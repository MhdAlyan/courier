<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
 "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

  <!-- Copyright 2004 Double Precision, Inc.  See COPYING for -->
  <!-- distribution information. -->

<refentry id="courier-analog">

  <docinfo>
    <title>courier-analog</title>
    <orgname>Double Precision, Inc.</orgname>
    <productname>Courier Mail Server</productname>

  </docinfo>
  <refmeta>
    <refentrytitle>courier-analog</refentrytitle>
    <manvolnum>8</manvolnum>
    <refmiscinfo>Double Precision, Inc.</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>courier-analog</refname>
    <refpurpose>Courier log analyzer</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <cmdsynopsis>
      <command>courier-analog</command>
      <arg>--smtpinet</arg>
      <arg>--smtpitime</arg>
      <arg>--smtpierr</arg>
      <arg>--smtpos</arg>
      <arg>--smtpod</arg>
      <arg>--smtpof</arg>
      <arg>--imapnet</arg>
      <arg>--imaptime</arg>
      <arg>--imapbyuser</arg>
      <arg>--imapbylength</arg>
      <arg>--imapbyxfer</arg>
      <arg>--pop3net</arg>
      <arg>--pop3time</arg>
      <arg>--pop3byuser</arg>
      <arg>--pop3bylength</arg>
      <arg>--pop3byxfer</arg>
      <arg>--html=<replaceable>directory</replaceable></arg>
      <arg>--noise=<replaceable>count</replaceable></arg>
      <arg>--noisy</arg>
      <arg>--title="<replaceable>text</replaceable>"</arg>
      <arg choice='req'>logfile</arg>
    </cmdsynopsis>
  </refsynopsisdiv>

  <refsect1>
    <title>DESCRIPTION</title>

    <para>
<command>courier-analog</command> reads the
<citerefentry>
	<refentrytitle>syslog</refentrytitle>
	<manvolnum>3</manvolnum>
      </citerefentry>
<replaceable>logfile</replaceable>
with log messages generated by <application>Courier</application>
mail server, and generates a useful report.
<command>courier-analog</command> can also be used with the
<application>Courier-IMAP</application> package subset, the SMTP-related
report sections will be empty.</para>

    <para>
<command>courier-analog</command> expects each line
in <replaceable>logfile</replaceable> to follow the generic syslog format:
<quote>Mmm dd hh:mm:ss hostname process: message</quote>; the first
fifteen character specify the time of the log message, which is followed by
the server's hostname, the name of the process logging the message, then
the message itself.</para>

    <para>
<command>courier-analog</command> should be invoked as part of the scheduled
job that rotates the system log files.
For example: all messages are logged to <filename>/var/log/maillog</filename>
and once a week (or once a day) <filename>/var/log/maillog</filename>
gets rotated to <filename>/var/log/maillog.1</filename>, after which
the command <quote>courier-analog [options] /var/log/maillog.1</quote> is
executed.</para>

    <para>
The name of the
<citerefentry>
	<refentrytitle>syslog</refentrytitle>
	<manvolnum>3</manvolnum>
      </citerefentry>
file with <application>Courier</application> messages is specified as
<replaceable>logfile</replaceable>, following
<command>courier-analog</command>'s command line options.
<replaceable>logfile</replaceable> may be <quote>-</quote>, which reads
standard input.
This can be used if log files are compressed after rotation.
Example:</para>

    <informalexample>
      <programlisting>
gunzip -cd &lt;/var/log/maillog.1.gz | courier-analog [options] -
</programlisting>
    </informalexample>

    <para>
The log file can contain messages from other applications besides
<application>Courier</application>; they will be ignored.</para>

    <note>
      <para>
<command>courier-analog</command>
reads the entire log file in memory, before indexing and generating reports,
and sufficient memory must be available.
A rule of thumb is that the amount of required RAM should be twice the
size of <replaceable>logfile</replaceable>.</para>

      <para>
A sensible system log rotation policy should be
established in advance, before
deploying <command>courier-analog</command>.
The level of system activity should be used to establish a log rotation
policy that generates log files of reasonable size, when compared with
system resources.
An alternative is to copy the log file to another server, with available
resources, and run <command>courier-analog</command> on the other
server.</para>

      <para>
If possible, system log files should not be rotated more than once a day.
The <quote>Connections by time</quote> report will not be meaningful with
more frequent rotation frequencies.</para>
    </note>
  </refsect1>

  <refsect1>
    <title>OPTIONS</title>

    <variablelist>
      <varlistentry>
	<term><literal>--smtpinet</literal></term>
	<listitem>
	  <para>
Generate the <quote>Incoming SMTP connections by network</quote> report
to standard output.
The report is sorted by the number of total connections from each
network, largest first.
This report summarizes incoming SMTP connections, by the connecting
/24 IPv4 network or a /64 IPv6 network.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><literal>--smtpitime</literal></term>
	<listitem>
	  <para>
Generate the <quote>Incoming SMTP connections by time</quote> report
to standard output.
The report is sorted by the number of total connections per hour,
largest first.
This report summarizes incoming SMTP connections, on an hourly basis.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><literal>--smtpierr</literal></term>
	<listitem>
	  <para>
Generate the <quote>Incoming SMTP connections by error message</quote> report
to standard output.
This report summarizes the error messages in incoming SMTP connections.
A single SMTP connection may have multiple delivery attempts, and generate
multiple errors.
This report identifies the largest sources of rejected E-mail messages without
regard to the actual number of connections.
This report consists of three parts:</para>
	  <orderedlist>
	    <listitem>
	      <para>
Summary of errors per each
/24 IPv4 network or a /64 IPv6 network, sorted by
the number of total errors from each network.</para>
	    </listitem>
	    <listitem>
	      <para>
Summary of errors per each return address, sorted by
the number of total errors for each return address.</para>
	    </listitem>
	    <listitem>
	      <para>
Summary of errors per each recipient address, sorted by
the number of total errors for each recipient address.</para>
	    </listitem>
	  </orderedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--smtpos</literal></term>
	<listitem>
	  <para>
Generate the <quote>Successful outbound SMTP connections</quote> report
to standard output.
This report consists of two parts:
summary sorted by the return address, and
summary sorted by the destination address,
sorted by the E-mail domain, largest number of
addresses first.
This report summarizes E-mail messages that were successfully sent.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--smtpof</literal></term>
	<listitem>
	  <para>
Generate the <quote>Failed outbound SMTP connections</quote> report
to standard output.
This report consists of two parts:
summary sorted by the return address, and
summary sorted by the destination address,
sorted by the E-mail domain, largest number of
addresses first.
This report summarizes E-mail messages that were not delivered.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--smtpod</literal></term>
	<listitem>
	  <para>
Generate the <quote>Deferred outbound SMTP connections</quote> report
to standard output.
This report consists of two parts:
summary sorted by the return address, and
summary sorted by the destination address,
sorted by the E-mail domain, largest number of
addresses first.
This report summarizes SMTP delivery attempts that resulted in a temporary
error due to the destination E-mail server being down or temporarily unable
to receive mail.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--html=</literal><replaceable>directory</replaceable></term>
	<listitem>
	  <para>
This option generates all reports in HTML format.
<quote>directory</quote> should be an empty directory (which will be
created, if necessary).
<command>courier-analog</command> generates all reports, in HTML format,
with a navigation <filename>index.html</filename> file.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--imapnet</literal></term>
	<listitem>
	  <para>
Generate the <quote>IMAP connections by network</quote> report
to standard output.
The report is sorted by the number of total connections from each
network, largest first.
This report summarizes IMAP connections, by the connecting
/24 IPv4 network or a /64 IPv6 network.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--imaptime</literal></term>
	<listitem>
	  <para>
Generate the <quote>IMAP connections by time</quote> report
to standard output.
The report is sorted by the number of total connections per hour,
largest first.
This report summarizes IMAP connections, on an hourly basis.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--imapbyuser</literal></term>
	<listitem>
	  <para>
Generate the <quote>IMAP logins</quote> report
to standard output.
The report is sorted by the number of total connections for each login ID,
in decreasing order.
This report summarizes IMAP connections, on a per-login basis.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--imapbyxfer</literal></term>
	<listitem>
	  <para>
Generate the <quote>IMAP data transfers</quote> report
to standard output.
This is the same report as the <quote>IMAP logins</quote> report, except
that the report is sorted by the total number of downloaded bytes
in decreasing order.
This report summarizes IMAP connections that download the most amount
of mail.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--imapbylength</literal></term>
	<listitem>
	  <para>
Generate the <quote>IMAP session lengths</quote> report
to standard output.
This is the same report as the <quote>IMAP logins</quote> report, except
that the report is sorted by the total login time,
in decreasing order.
This report summarizes the longest IMAP connections.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--pop3net</literal></term>
	<listitem>
	  <para>
Generate the <quote>POP3 connections by network</quote> report
to standard output.
The report is sorted by the number of total connections from each
network, largest first.
This report summarizes POP3 connections, by the connecting
/24 IPv4 network or a /64 IPv6 network.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--pop3time</literal></term>
	<listitem>
	  <para>
Generate the <quote>POP3 connections by time</quote> report
to standard output.
The report is sorted by the number of total connections per hour,
largest first.
This report summarizes POP3 connections, on an hourly basis.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--pop3byuser</literal></term>
	<listitem>
	  <para>
Generate the <quote>POP3 logins</quote> report
to standard output.
The report is sorted by the number of total connections for each login ID,
in decreasing order.
This report summarizes POP3 connections, on a per-login basis.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--pop3byxfer</literal></term>
	<listitem>
	  <para>
Generate the <quote>POP3 data transfers</quote> report
to standard output.
This is the same report as the <quote>POP3 logins</quote> report, except
that the report is sorted by the total number of downloaded bytes
in decreasing order.
This report summarizes POP3 connections that download the most amount
of mail.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>--pop3bylength</literal></term>
	<listitem>
	  <para>
Generate the <quote>POP3 session lengths</quote> report
to standard output.
This is the same report as the <quote>POP3 logins</quote> report, except
that the report is sorted by the total login time,
in decreasing order.
This report summarizes the longest POP3 connections.</para>
	</listitem>
      </varlistentry>


    </variablelist>

    <para>
The <literal>--smtpinet</literal> option will be used by default if none
are specified.
Multiple options concate the reports to standard output.
The <literal>--html</literal> option does not generate anything on
standard output.</para>

    <para>
The IMAP/POP3 connections by network and time reports may not show the same
connection total as the rest of the IMAP/POP3 reports.
The <quote>IMAP/POP3 connections by network and time</quote> reports
include all connections, whether they logged in or not.
The other reports only include connections that succesfully logged in.</para>
  </refsect1>

  <refsect1>
    <title>OTHER OPTIONS</title>

    <variablelist>
      <varlistentry>
	<term>--noise=<replaceable>N</replaceable></term>
	<listitem>
	  <para>
Generate a report only for connections, or error messages, that occur
more than <replaceable>N</replaceable> times.
The rest is background noise that should not be paid attention to.
The default is 10.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>--noisy</term>
	<listitem>
	  <para>
Generate a separate report for the background noise, all lumped together.
Alternatively, use <literal>--noise</literal> to set a lower noise
threshold (perhaps even <literal>--noise=0</literal>).</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>--title="<replaceable>text</replaceable>"</term>
	<listitem>
	  <para>
Use <quote><replaceable>text</replaceable></quote> for the report's
title.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>BUGS</title>

    <para>
<command>courier-analog</command> eats memory even if only one, small,
report is requested.
None of the options have a major impact on its memory demands.
<command>courier-analog</command> always eats the entire log file and
chews it.
The options only determine what gets spit out.</para>

    <para>
When the local time is set back due a transition to/from an alternate time
zone (such as the return to standard time from daylight savings time in
Northern America), the default
<citerefentry>
	<refentrytitle>syslog</refentrytitle>
	<manvolnum>3</manvolnum>
      </citerefentry>
format repeats the local timestamps, for an hour.
This will have a minor impact on some of the time-based based reports.</para>

    <para>
<command>courier-analog</command> understands multi-line SMTP messages.
During times of excessive system activity multi-line log entries
could be interspersed with other messages.
<command>courier-analog</command> may not be able to combine multi-line
messages in that case, and report on each line of the message
separately.</para>
  </refsect1>
</refentry>

