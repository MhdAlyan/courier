<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content=
  "text/html; charset=us-ascii" />
  <meta name="MSSmartTagsPreventParsing" content="TRUE" />
  <meta name="author" content="Sam Varshavchik" />

  <title>Installation</title>
  <link rel="icon" href="icon.gif" type="image/gif" />
</head>

<body>
  <!-- Copyright 1998 - 2011 Double Precision, Inc.  See COPYING for -->
  <!-- distribution information. -->

  <p>NOTE: a more readable HTML version of this INSTALL document
  can be found in courier/doc/install.html.</p>

  <h1>Installation</h1>

  <blockquote>
    <hr />

    <p><b>NOTE:</b></p>

    <p>This documentation describes manual installation of the
    <i>Courier</i> mail server. This is a somewhat involved process
    that may overwhelm people that do not have prior experience
    with installing large software packages. Many Linux-based
    distributions and BSD-family systems have
    separately-maintained, preconfigured, ready-to-install packages
    that can be loaded with much less investment of time.
    Installing a pre-built package would probably be the best
    approach in this case.</p>

    <p>Should you choose to install a platform-specific prebuilt
    package, you should carefully read any custom documentation
    files that are included in the package. Most platform-specific
    packages provide custom, non-default configuration settings
    that are optimized for that platform unique needs and
    requirements. Feedback about platform-specific precompiled
    packages should be copied to the development group that
    maintains the package, in additional to the platform-neutral
    <code>courier-users</code> mailing list. They will appreciate
    the feedback, and take it into consideration when preparing the
    next revision of the platform-specific package.</p>
    <hr />
  </blockquote>

  <p>Read this document in its entirety before entering a single
  command. Installing the <i>Courier</i> mail server for the first
  time will take a while. If possible, consider looking around for
  anyone who has already packaged the <i>Courier</i> mail server
  for your operating system, and save yourself the hassle.</p>

  <p>Fortunately, it gets easier with each subsequent installation.
  The <i>Courier</i> mail server is a complicated piece of
  software. Most problems people will have are likely to be with
  the configuring and installing it correctly. Designing complex
  software that compiles and installs on a wide variety of POSIX
  systems is not a trivial task.</p>

  <p>The <i>Courier</i> mail server's configuration and
  installation scripts are very flexible in setting up installation
  directories for each logical set of files - configuration files,
  binaries, scripts, the mail queue, and more. If you begin by
  installing someone else's package, instead of installing
  everything yourself, you should take careful notes where things
  are installed. If you later decide to roll your own package, you
  will either need to use a COMPLETELY IDENTICAL configuration, or
  take care to back up your old configuration, and then restore it
  after the upgrade. The following documentation refers to the
  default location of various configuration files (and other files
  as well). If you choose to install some files in a non-default
  location (either by yourself, or by using someone else's
  package), you will need to take this into account while reading
  the following documentation.</p>

  <p>This cannot be emphasized enough: the configuration defaults
  are very generic; the goal is to have the default configuration
  settings work for almost everyone. In every case using at least a
  couple of non-default parameters will make the <i>Courier</i>
  mail server work better on your system. You should anticipate
  going through several trial-and-error installs, tweaking the
  options to see what works better for you. Even my own
  pre-configured RPM package uses a number of non-default
  parameters.</p>

  <p>NOTE: older versions of the <code>linuxconf</code>
  configuration tool are hardwired for sendmail. They like to
  change the permission of the <code>sendmail</code> wrapper to
  match the permissions they think the real sendmail should have.
  Older versions of <code>linuxconf</code> also have a tendency to
  create the <code>/var/spool/mqueue</code> directory, even if
  sendmail is not installed.</p>

  <h2>Table Of Contents</h2>

  <p>The following table of contents might look intimidating at
  first, but some sections are marked "optional". These sections
  are not required for a basic installation as a simple ESMTP
  server.</p>

  <ul>
    <li><a href="#upgrade">Upgrading an existing
    installation</a></li>

    <li><a href="#overview">Overview</a></li>

    <li><a href="#prepare">Preparing for installation</a></li>

    <li><a href="#socks">OPTIONAL: Install the Socks 5 client
    toolkit</a></li>

    <li><a href="#configure">Run configure</a></li>

    <li><a href="#ipv6">IPv6</a></li>

    <li><a href="#compile">Compile and run make check</a></li>

    <li><a href="#install">Installation</a></li>

    <li><a href="#installconfigure">Install configuration
    files</a></li>

    <li><a href="#suid">Adjust system paranoia level</a></li>

    <li><a href="#postinst">Post-installation setup</a></li>

    <li><a href="#checks">Post-installation checks</a></li>

    <li><a href="#webadmin">OPTIONAL: Configure webadmin</a></li>

    <li><a href="#aliases">Create system aliases</a></li>

    <li><a href="#access">Create smtp access list</a></li>

    <li><a href="#backscatter">Backscatter suppression</a></li>

    <li><a href="#misc">Miscellaneous configuration</a></li>

    <li><a href="#locals">Define local domains</a></li>

    <li><a href="#uucp">OPTIONAL: Configure UUCP</a></li>

    <li><a href="#ldap">OPTIONAL: Configure LDAP aliasing</a></li>

    <li><a href="#filter">OPTIONAL: Configure filtering</a></li>

    <li><a href="#accept">Create a list of domains to accept mail
    for</a></li>

    <li><a href="#start">Starting and stopping the <i>Courier</i>
    mail server</a></li>

    <li><a href="#parallel">Run the <i>Courier</i> mail server in
    parallel to your mail server</a></li>

    <li><a href="#esmtpauth">OPTIONAL: Configure ESMTP
    authentication and SSL</a></li>

    <li><a href="#esmtpsecurity">OPTIONAL: Configure the SECURITY
    ESMTP extension</a></li>

    <li><a href="#spf">OPTIONAL: Configure the Sender Policy
    Framework</a></li>

    <li><a href="#imap">OPTIONAL: Configure the IMAP
    server</a></li>

    <li><a href="#imapsh">OPTIONAL: Configure IMAP shared
    folders</a></li>

    <li><a href="#imapssl">OPTIONAL: Configure IMAP over
    SSL</a></li>

    <li><a href="#sslcert">OPTIONAL: Certificate
    Authentication</a></li>

    <li><a href="#imapsend">OPTIONAL: Sending mail via an IMAP
    connection</a></li>

    <li><a href="#idle">OPTIONAL: Configure IMAP realtime folder
    status updates</a></li>

    <li><a href="#smap">OPTIONAL: Configure SMAP</a></li>

    <li><a href="#pop3">OPTIONAL: Configure the POP3
    server</a></li>

    <li><a href="#pop3ssl">OPTIONAL: Configure POP3 over
    SSL</a></li>

    <li><a href="#proxy">OPTIONAL: Configure the IMAP/POP3
    aggregator proxy</a></li>

    <li><a href="#webmail">OPTIONAL: Configure the webmail
    server</a></li>

    <li><a href="#calendaring">OPTIONAL: Configure webmail
    calendaring</a></li>

    <li><a href="#webfilter">OPTIONAL: Configure mail filtering for
    the webmail server</a></li>

    <li><a href="#changepass">OPTIONAL: Changing mail account
    passwords using the webmail server</a></li>

    <li><a href="#autoreply">OPTIONAL: Configure autoreplies for
    the webmail server</a></li>

    <li><a href="#gpg">OPTIONAL: Configure encryption for the
    webmail server</a></li>

    <li><a href="#footer">OPTIONAL: Install automatically-appended
    footer text for webmail messages</a></li>

    <li><a href="#quota">OPTIONAL: Quota support</a></li>

    <li><a href="#options">OPTIONAL: Account OPTIONS</a></li>

    <li><a href="#sendfax">OPTIONAL: Configure outbound
    faxing</a></li>

    <li><a href="#recvfax">OPTIONAL: Configure inbound
    faxing</a></li>

    <li><a href="#analog">OPTIONAL: Install the <i>Courier</i> mail
    server log analyzer</a></li>

    <li><a href="#decommission">Decommission your existing mail
    server</a></li>

    <li><a href="#sample">Sample init script</a></li>
  </ul>

  <h2><a name="upgrade" id="upgrade">Upgrading an existing
  installation</a></h2>

  <h3>Upgrading from the <i>Courier</i> mail server 0.63.0, or
  earlier</h3>

  <p>There's a new setting, <tt>SYSLOCALE</tt>, in the
  <tt>courierd</tt> configuration file, which initializes the
  environment from the default system locale. The configuration
  script heuristically searches for a list of known locale
  initialization scripts on various platforms, if found.</p>

  <p>If your platform's locale configuration script's name is not
  known to the configuration script, manually specify your default
  system locale in this configuration setting.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.55.1, or
  earlier</h3>

  <p>The <tt>webmlmd</tt> tool has been significantly enhanced,
  with a new administration screen that consists of three new
  template files: <tt>style.css.tmpl</tt>,
  <tt>webmlmlistadmin.tmpl.html</tt>, and
  <tt>webmlmlistadminpw.html.html</tt>. These three template files
  must be installed in each mailing list directory. You may copy
  them manually, or use the <tt>couriermlm update</tt> command.
  <tt>couriermlm update</tt> overwrites all your list-specific
  customizations, so make backups first!</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.54.2, or
  earlier</h3>

  <p>The logic for outbound authenticated SMTP has changed. This is
  when the <i>Courier</i> mail server sends outbound mail through a
  smarthost that requires authentication.</p>

  <p>The specified smarthost's name is still looked up in DNS, as
  before. When smtp.example.com is specified as the smarthost's
  name, The <i>Courier</i> mail server looks up any MX or A records
  for smtp.example.com. A connection gets established to a server
  whose name may be different than the original DNS hostname, if it
  gets redirected via an <tt>MX</tt> or a <tt>CNAME</tt>
  record.</p>

  <p>In earlier versions of the <i>Courier</i> mail server, the
  smarthost's userid and password must be listed using the
  resulting server's physical, resolved name. Starting with version
  0.55, the smarthost's original DNS name must be listed instead.
  In all cases now, the name of the server listed in
  <tt>esmtpauthclient</tt> will now match the name specified in
  <tt>esmtproutes</tt>.</p>

  <p>After updating to 0.55, the contents of the
  <tt>esmtpauthclient</tt> configuration file may need
  updating.</p>

  <p><em>IMPORTANT:</em> After updating to 0.55, all existing
  <tt>couriermlm</tt> mailing list directories must be updated with
  new configuration files. See the "update" command in the "MANUAL
  COMMANDS" section of the <a href=
  "couriermlm.html"><tt>couriermlm</tt>(1)</a> manual page. If you
  run many mailing lists, you are <em>strongly</em> advised to
  install the new version of the <i>Courier</i> mail server on
  another machine and become re-acquainted with
  <tt>couriermlm</tt>'s configuration. In an emergency, make a
  backup copy of the <tt>couriermlm</tt> command from your existing
  version of the <i>Courier</i> mail server, before installing this
  update.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.51, or
  earlier</h3>

  <p>Version 2.0 of maildrop, in the <i>Courier</i> mail server
  0.52, introduces a new pattern matching engine that uses the
  <tt>PCRE</tt> library, that uses a completely different syntax.
  However, very few changes should be required to upgrade existing
  maildrop recipes to the new syntax.</p>

  <p>After upgrading from the <i>Courier</i> mail server 0.51, or
  earlier, review the <tt>maildropfilter</tt> manual page which has
  been revised to document the new pattern matching syntax. The
  legacy pattern matching engine is still available by setting
  <tt>MAILDROP_OLD_REGEXP</tt> to <tt>1</tt>. See also the
  "Conversion of maildrop 1.x pattern to 2.0" section in the manual
  page, for more information.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.49.0, or
  earlier</h3>

  <p><code>couriermlm</code>'s default configuration now treats
  both the userid and the domain portion of E-mail addresses as
  case-insensitive.</p>

  <p>Any existing mailing list that has subscribers whose E-mail
  addresses contain uppercase addresses must explicitly set the new
  <code>CASESENSITIVE=1</code> list option, using the
  <code>couriermlm</code> command, otherwise those subscribers will
  have problems unsubscribing or posting messages to the list.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.48.2, or
  earlier</h3>

  <p>The <i>Courier</i> mail server's default configuration now
  includes backscatter suppression. Review <a href=
  "#backscatter">Backscatter suppression</a>, below, for any needed
  configuration changes.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.47, or
  earlier</h3>

  <p>Beginning with 0.48, the authentication library that used to
  be a part of the <i>Courier</i> mail server's source has been
  spun off into a standalone authentication library.</p>

  <p>You must download and install the <i>Courier</i> mail server
  authentication library from <a href=
  "http://www.courier-mta.org/authlib/">http://www.courier-mta.org/authlib/</a>
  before upgrading. Review the documentation in the
  <code>courier-authlib</code> package for more information.</p>

  <p>As part of installing <code>courier-authlib</code>, the
  configuration files in the <i>Courier</i> mail server's
  configuration directory that relate to authentication will be
  copied to <code>courier-authlib</code>'s configuration directory.
  The files are: <code>authdaemonrc</code>,
  <code>authmysqlrc</code>, <code>authpgsqlrc</code>,
  <code>authldaprc</code>, and <code>userdb</code> (together with
  the <code>.dist</code> versions). This works only as long as the
  <i>Courier</i> mail server was installed in one of the known
  default installation directories. The documentation in
  <code>courier-authlib</code> explains what to do if the existing
  version of the <i>Courier</i> mail server is installed in a
  non-default location.</p>

  <p>In any case, after upgrading to 0.48 these configuration files
  in the <i>Courier</i> mail server's configuration directory will
  no longer be used. To avoid future confusion the old copies of
  these configuration files (including the <code>.dist</code>
  files), should be removed from the <i>Courier</i> mail server's
  configuration directory. They now live in the <i>Courier</i> mail
  server-authlib's configuration directory
  (<code>/usr/local/etc/authlib</code>, or whatever was specified
  to the <i>Courier</i> mail server-authlib's
  <code>configure</code> script).</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.45.4 or
  earlier</h3>

  <p>The command to start the webmail server daemon has changed.
  The system startup script must be modified to run the new
  command: "<tt>/usr/lib/courier/sbin/webmaild start</tt>".
  Additionally, this scripts also starts pcpd, if required. It is
  no longer necessary to start pcpd by hand.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.44.0 or
  earlier</h3>

  <p>Version 0.44.1 introduced an updated webmail implementation.
  The suid cgi-bin binary has been replaced by a combination of a
  stub and a daemon process. After upgrading to 0.44.1 you will
  need to modify your system startup script to run
  <code>/usr/lib/courier/libexec/courier/sqwebmaild start</code>.
  See below for more information.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.42.2 or
  earlier</h3>

  <p>After upgrading from the <i>Courier</i> mail server 0.42.2, or
  earlier, any existing mail in POP3 mailboxes may show up as new
  mail, by some mail clients. This is a one-time event.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.42.0 or
  earlier</h3>

  <p>Version 0.43 introduced some functional changes to the LDAP,
  MySQL, and PostgreSQL authentication modules. A new
  DEFAULTDELIVERY setting is added to each module, incorporating
  some functionality previously done by the MAILDIR setting.
  Previously, MAILDIR served two purposes: 1) define the default
  location to the primary mailbox, relative to the account's home
  directory, 2) provide default mail delivery instructions,
  overriding DEFAULTDELIVERY in the <code>courierd</code>
  configuration file.</p>

  <p>Starting with this version, MAILDIR only specifies the default
  location for the primary mailbox, and this setting is now used
  only by the POP3, IMAP, and Webmail servers. The new
  DEFAULTDELIVERY setting specifies the default mail delivery
  instructions. Sites that previously used MAILDIR may now need to
  copy its setting to DEFAULTDELIVERY.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.34.1 or
  earlier</h3>

  <p>Version 0.35 introduced the ability to update system passwords
  from the webmail server. If you are using the
  <code>authuserdb</code> authentication module, rerun the
  <code>makeuserdb</code> script after upgrading to 0.35 or
  later.</p>

  <p>Prior to 0.35, the default configuration of the webmail server
  maintained a separate webmail password file. The webmail server
  did not have the logic to update system login passwords, the
  approach was to copy system login passwords into a webmail
  password file. Changing the webmail password involved simply
  updating the webmail password file, and life was good.</p>

  <p>In 0.35, logic was added to update the real system password
  file, and the eliminate the webmail password file. After
  upgrading in 0.35, it will probably be necessary to reset all
  mail account passwords on existing accounts, since the webmail
  password file is not being used any more, and most people have
  probably changed their webmail passwords.</p>

  <p>As the result of the password change, the default
  configuration script will now always build the
  <code>authdaemond</code> authentication module by default.
  Previously, <code>authdaemond</code> was built by default only if
  LDAP or MySQL support was necessary.</p>

  <h3>Upgrading from the <i>Courier</i> mail server 0.29.1 or
  earlier</h3>

  <p>Version 0.30 changed the format of most configuration files.
  The new configuration file format allows configuration files to
  be automatically upgraded. The automatic upgrade feature requires
  that both the old and the new installation have preformatted
  configuration files. Therefore, when upgrading from version
  0.29.1 or earlier, use the following procedure to upgrade the
  existing configuration files.</p>

  <p>All configuration files are installed in the same directory,
  "<i>sysconfdir</i>". <i>sysconfdir</i> is a configurable
  parameter, it's usually <code>/usr/lib/courier/etc</code>.
  <i>sysconfdir</i> is <code>/etc/courier</code> in the RPM version
  of the <i>Courier</i> mail server.</p>

  <h4>Back up your existing <i>sysconfdir</i></h4>

  <p>Make a backup copy of your current <i>sysconfdir</i>, then
  delete the old version of the <i>Courier</i> mail server.
  "<code>rm -rf /usr/lib/courier</code>" will do nicely. All the
  possible configurable settings are in <i>sysconfdir</i>,
  everything else can simply go.</p>

  <h4>Back up your existing <i>sysconfdir</i></h4>

  <p>Make a backup copy of your current <i>sysconfdir</i>. The
  upgrade process reinstalls several default configuration files;
  specifically <i>sysconfdir</i>/aliases/system and
  <i>sysconfdir</i>/smtpaccess/default. Any additions to these
  files will normally be lost in the upgrade, and can be restored
  from the backup afterwards. Don't forget to rerun
  <code>makealiases</code> and <code>makesmtpaccess</code>.</p>

  <h4>Install the new version</h4>

  <p>Follow the installation procedure in the next section
  (including the <code>make install-configure</code>). The
  following configuration files are now preformatted for automatic
  installation:</p>
  <pre>
   ldapaddressbook
   esmtpd
   esmtpd-msa
   courierd
   pop3d
   pop3d-ssl
   imapd
   imapd-ssl
   ldapaliasrc
   authldaprc
   authmysqlrc
   authpgsqlrc
   authdaemonrc
</pre>

  <p>NOTE: depending upon your configuration, you may not actually
  have every one of these files installed, so just disregard the
  ones that are not present. Manually edit <i>filename</i>, and
  retype any custom modifications from the backup copy of the
  configuration file. This is a hassle, but it only needs to be
  done once. Future upgrades will be 99% automatic.</p>

  <p>Any custom configuration changes are generally confined to
  these configuration files only. Very rarely are any configuration
  changes made to the remaining configuration files. If necessary,
  they can simply be restored from the backup copy made in the
  previous step. Something to keep in mind is that future versions
  may add additional complexity to other configuration files,
  resulting in additional configuration files being reformatted for
  automatic upgrading.</p>

  <h2><a name="overview" id="overview">Overview</a></h2>

  <p>You will need the following software in order to compile and
  install the <i>Courier</i> mail server:</p>

  <ol>
    <li>
      <strong>The <i>Courier</i> mail server Authentication
      Library</strong>

      <p>The <code>courier-authlib</code> package must be installed
      and configured prior to installing the <i>Courier</i> mail
      server. Download the <code>courier-authlib</code> package
      from <a target="_blank" href=
      "http://www.courier-mta.org/authlib/"><code>http://www.courier-mta.org/authlib/</code></a>.</p>
    </li>

    <li>
      <strong>A C++ compiler</strong>

      <p>The <i>Courier</i> mail server is primarily developed and
      built with gcc. Other C++ compiler may or may not work.
      Solaris's C++ compiler is reported to work without any
      problems. There are some issues with AIX's xlC compiler,
      which mostly has to do with the C++ libraries and header
      files. IBM has released a GNU/Linux development toolkit for
      AIX, which may help in getting the <i>Courier</i> mail server
      to compile.</p>
    </li>

    <li>
      <strong>PCRE</strong>

      <p>The PCRE library (<a href=
      "http://www.pcre.org">http:/www.pcre.org</a>) is
      required.</p>
    </li>

    <li>
      <strong>GNU IDN library</strong>

      <p>This library (<a href=
      "http://www.gnu.org/software/libidn/">http://www.gnu.org/software/libidn/</a>)
      implements support for internationalized domain names.</p>
    </li>

    <li>
      <strong>GNU make</strong>

      <p>On the BSD platform family GNU make is usually installed
      as gmake. Simply replace 'make' with 'gmake' in the following
      instructions. GNU make is REQUIRED. Use anything else at your
      own risk.</p>
    </li>

    <li>
      <strong>Perl 5</strong>

      <p>A recent version of Perl needs to be installed.</p>
    </li>

    <li>
      <strong>GDBM or Berkeley DB library</strong>

      <p>Either library must be installed.</p>
    </li>

    <li>
      <strong><a target="_blank" href=
      "http://oss.sgi.com/projects/fam/">FAM, the File Alteration
      Monitor</a>, or its modern Linux-specific replacement
      <strong><a href="http://www.gnome.org/~veillard/gamin/"
      target="_blank">Gamin</a></strong></strong>

      <p>FAM (<tt>http://oss.sgi.com/projects/fam/</tt>) or
      <a href="http://www.gnome.org/~veillard/gamin/" target=
      "_blank">Gamin</a> is optional. If FAM or Gamin is installed,
      it is used for an enhanced IMAP <code>IDLE</code>
      implementation that provides real-time folder status updates
      to concurrent IMAP clients that have the same folder
      opened.</p>
    </li>

    <li>
      <strong>OpenSSL</strong> or <strong>GnuTLS</strong>

      <p>Support for SSL/TLS requires OpenSSL/GnuTLS. If OpenSSL or
      GnuTLS is not installed, SSL/TLS features are disabled.</p>
    </li>

    <li>
      <strong>OpenLDAP</strong>

      <p>Support for LDAP directory services requires OpenLDAP
      client libraries to be installed. If OpenLDAP is not
      installed LDAP directory features are disabled. Sometimes
      there's some confusion when commercial LDAP servers are used,
      which come with their own development toolkits, which use a
      different API than OpenLDAP. Even if a commercial LDAP server
      is used to provide LDAP services, OpenLDAP is still required
      to enable LDAP services in the <i>Courier</i> mail server.
      Also, note that you need OpenLDAP <em>development</em>
      libraries and files. On most systems, the development files
      are packaged separately, in addition to the runtime OpenLDAP
      libraries. Make sure that you have not just the runtime
      OpenLDAP libraries installed, but the development libraries
      as well.</p>

      <p>Most of the LDAP support code is already provided by the
      <i>Courier</i> mail server authentication library. Some LDAP
      features, such as LDAP-based mail aliases, are implemented in
      the <i>Courier</i> mail server directly. OpenLDAP client
      libraries must be installed. If OpenLDAP is not installed,
      LDAP directory features are disabled.</p>
    </li>

    <li>
      <strong>mgetty+sendfax, groff or troff (not tested),
      ghostscript, and NetPBM</strong>

      <p>This optional software is required to send E-mail messages
      via fax. The <i>Courier</i> mail server will compile and
      install without this software, but you will not be able to
      send faxes. All packages must be installed prior to
      installing the <i>Courier</i> mail server, and binaries from
      all packages must be installed in the default <tt>PATH</tt>
      before running the <i>Courier</i> mail server's
      <tt>configure</tt> script.</p>

      <p><a target="_blank" href=
      "http://alpha.greenie.net/mgetty/">mgetty+sendfax</a>,
      <a target="_blank" href=
      "http://www.ghostscript.com/">ghostscript</a>, and <a target=
      "_blank" href=
      "http://www.gnu.org/software/groff/groff.html">groff</a>, are
      required for basic fax support, which supports faxing of
      plain text, Postscript, and PDF-formatted content. It's
      probably possible to use the original UNIX troff instead of
      groff, but this has not been tested. Installing <a target=
      "_blank" href="http://netpbm.sourceforge.net/">NetPBM</a>
      adds the ability to fax GIF, JPEG, and PNG images.</p>
    </li>
  </ol>

  <p>The typical sequence of commands to install the <i>Courier</i>
  mail server is as follows. Read the following section before
  running these commands:</p>
  <pre>
   ./configure [options]
   make
   make check       # Optional -- see below
   make install
   make install-configure
</pre>

  <p>These commands are described in greater detail in the
  following sections.</p>
  <hr />

  <blockquote>
    <p>If you're using <code>gmake</code> (the <code>make</code> on
    GNU/Linux, and <code>gmake</code> everywhere else), and you are
    compiling the <i>Courier</i> mail server on a workstation with
    multiple CPUs and plenty of memory, set the following
    environment variable:</p>
    <pre>
   MAKEFLAGS="-j 4"; export MAKEFLAGS         # Bourne or Korn shell
</pre>or:
    <pre>
   setenv MAKEFLAGS="-j 4"                    # The C shell
</pre>

    <p>This must be done before running the <code>configure</code>
    script. This works only with <code>gmake</code>.</p>
  </blockquote>
  <hr />

  <blockquote>
    <p>The <i>Courier</i> mail server will not work on a Linux
    kernel that's been patched with the Openwall security patch in
    its default configuration. The current version of the Openwall
    patch has a non-default option that turns off the portion of
    the Openwall patch which prevents the <i>Courier</i> mail
    server from running.</p>

    <p>NOTE: Linux-Mandrake includes the Openwall patch in the
    alternative "secure" kernel package. The <i>Courier</i> mail
    server will not run on Linux-Mandrake under the alternative
    "secure" kernel. This package must be removed and the standard
    kernel package must be installed.</p>
  </blockquote>
  <hr />

  <h2><a name="prepare" id="prepare">Preparing for
  installation</a></h2>

  <p>The first step consists of gathering some information about
  your existing mail system. Before proceeding, you will need to
  identify and resolve the following issues:</p>

  <ul>
    <li>Maildirs or mailbox files</li>
  </ul>

  <p>The <i>Courier</i> mail server can be used as a simple mail
  relay -- which does not store any mail locally but is merely a
  gateway between internal and external mail systems. The
  <i>Courier</i> mail server can also be used as a traditional mail
  server, accepting and storing messages in individual mailboxes
  that are accessible via POP3, IMAP, or webmail.</p>

  <p>The <i>Courier</i> mail server defaults to storing mail in
  maildirs, not traditional flat file mailbox files. Maildirs
  require less I/O and CPU resources; they do not use locking; and
  multiple clients can read and write from maildirs simultaneously.
  Maildirs scale very well to servers with multiple CPUs. Some
  benchmark numbers on maildirs are available from <a target=
  "_blank" href=
  "http://www.courier-mta.org/mbox-vs-maildir/">http://www.courier-mta.org/mbox-vs-maildir/</a>.</p>

  <p>Additionally, The <i>Courier</i> mail server's integrated
  POP3, IMAP, and HTTP/webmail servers support maildir mailboxes
  only. They do not support mailbox files.</p>

  <p>If you have an existing mail server in service, chances are
  that your current mail server delivers mail to mailbox files. You
  should consider migrating and converting to maildirs, but this
  will require that you also upgrade your POP3 server, your IMAP
  server, and all your other mail clients to software that supports
  maildirs. Fortunately, The <i>Courier</i> mail server already
  includes a fully integrated POP3 and IMAP server.</p>

  <p>Still, if circumstances absolutely require for you to stick
  with mailbox files, The <i>Courier</i> mail server has limited
  compatibility support for delivering mail to mailbox files, but
  you have more homework to do:</p>

  <ul>
    <li>What locking mechanism is used on mailbox files</li>
  </ul>

  <p>If you decide to stick with mailbox files, you must know - of
  course - where your mailboxes are located, and what locking
  mechanism is being used by your mail software. Mailbox files
  require some form of locking, because only one application can
  access the mailbox file at the same time. Unfortunately,
  different operating systems use different locking methods. There
  are several possible locking strategies that can be used:
  so-called "dot-locks", or one of three possible kinds of file
  locking calls. You will need to consult the documentation for
  your existing mail software to determine what locking mechanisms
  you should use.</p>

  <p>In most cases, mailbox files are located in a separate
  partition, usually the directory <code>/var/spool/mail</code>. In
  some instances, mailbox files may be kept in the home directory
  of each individual account, and the mail is delivered to either
  $HOME/Mailbox, or $HOME/INBOX. Again, you will have to figure
  this out by yourself.</p>

  <p>The <i>Courier</i> mail server can deliver mail to mailbox
  files only if the default mailbox file is in the home directory
  of each individual account, and if you use file locking. The
  <i>Courier</i> mail server does not support dot-locks, and the
  <i>Courier</i> mail server does not support a separate mail
  directory for mailbox files. Mailbox files must be located in the
  home directory of each individual account.</p>

  <p>The <i>Courier</i> mail server can use a recipient database
  (userdb) that can specify a non-default location for a
  recipient's mailbox. In theory, it is possible to point each
  account to its individual mailbox in
  <code>/var/spool/mail</code>, or somewhere else. However, that's
  a tedious task that must be done manually for each account, and
  is likely to be a major maintenance issue.</p>

  <p>A better solution is to use a separate local mail delivery
  agent. Your existing mail system is very likely to include a
  separate local mail delivery agent. If you already use a mail
  delivery agent such as <code>procmail</code>, you probably
  already have it set to use the correct locking mechanism for
  mailbox files, and it already knows where the mailbox files are.
  The <i>Courier</i> mail server will be happy to hand off all
  local mail to <code>procmail</code>, or anything else for the
  actual delivery.</p>

  <p>The <i>Courier</i> mail server source distribution includes
  the <code>maildrop</code> mail delivery agent which has some
  additional file locking options, however you'll have less
  problems if you stick with procmail in the beginning, and switch
  to <code>maildrop</code> after you've gained some experience
  configuring and installing the <i>Courier</i> mail server.</p>

  <ul>
    <li>Create the <code>courier</code> user and group IDs</li>
  </ul>

  <p>You should create a new userid and groupid named
  "<code>courier</code>". That's optional, but highly recommended.
  If this is not done, The <i>Courier</i> mail server will install
  as user/group <code>daemon</code> (or some other suitable
  user/group id). Only two of the <i>Courier</i> mail server's
  daemon processes run as a superuser (and one of them is
  perpetually waiting for a non-superuser daemon process to
  terminate, in order to restart it). Everything else runs as a
  non-superuser process. Ideally, you should reserve a separate
  user and group ID for the <i>Courier</i> mail server's use only,
  so a compromised mail system cannot be used to compromise the
  rest of the system. If push comes to shove, you can set up the
  <i>Courier</i> mail server to use a well-defined existing user
  and group ID, such as <code>daemon</code>.</p>

  <ul>
    <li>Define the installation directory</li>
  </ul>

  <p>The <i>Courier</i> mail server, by default, installs in
  <code>/usr/lib/courier</code>. Everything goes in there:
  binaries, scripts, configuration files, and manual pages. You
  will have to configure your <code>man</code> command to look for
  manual pages in <code>/usr/lib/courier/man</code> by adding this
  directory to the MANPATH environment variable. You will also need
  to add <code>/usr/lib/courier/bin</code> and
  <code>/usr/lib/courier/sbin</code> (for the root user only) to
  the default PATH. The <i>Courier</i> mail server RPM package
  installs a script that automatically implements that.</p>

  <p>Note that this installation layout is nothing more than a
  basic default, chosen because this simple arrangement works for
  everyone. The installation layout can be easily changed. For
  example, binaries can go to <code>/usr/local/bin</code>, and
  configuration files to <code>/usr/local/etc</code>. But keep in
  mind that the <i>Courier</i> mail server consists of several
  hundred individual files (at the last count), so if you install
  the <i>Courier</i> mail server somewhere else it might be very
  cumbersome to keep track of where everything went, and it will
  lead to almost guaranteed problems later, when you upgrade.</p>

  <p>You should try to use some kind of a packaging system in order
  to keep track of your the <i>Courier</i> mail server
  installation. Once you choose a packaging system, you should
  stick to it. If you switch to a different packaging system you
  should take extreme care to remove your previous package, and
  install your new package. Extreme configuration flexibility means
  that different packages will install in different places, and
  even have different file ownerships!</p>

  <p>For example, The <i>Courier</i> mail server's source code
  tarball can be built by RPM version 3.0.3 or higher, into a
  binary RPM package. The binary RPM package installs configuration
  files in <code>/etc/courier</code>, the mail queue in
  <code>/var/spool/courier</code>, and everything else in
  <code>/usr/lib/courier</code>. If you install my package, and
  later decide to either create your own package or use someone
  else's, you will have to make sure to use the same settings, or
  remove my package completely, before installing your new package.
  I mean it when I say "remove my package completely". That
  includes the mail queue containing any unsent messages. The
  <i>Courier</i> mail server will not function if you reinstall it
  using a different user/group ID, or if you use a different value
  for any other option.</p>

  <ul>
    <li>Conclusion</li>
  </ul>

  <p>Once these issues are squared away, you are ready to configure
  and install the <i>Courier</i> mail server.</p>

  <h2><a name="socks" id="socks">OPTIONAL: Install the Socks 5
  client toolkit</a></h2>

  <p>The <i>Courier</i> mail server has the ability to send
  outgoing SMTP mail through a Socks 5 proxy. The Socks 5 proxy
  option requires a separate module to be installed before
  installing the <i>Courier</i> mail server. Download the Socks 5
  proxy client library from <a target="_blank" href=
  "http://www.courier-mta.org/download.php#sox">http://www.courier-mta.org/download.php#sox</a>
  and follow its installation instructions. Binary RPMs can be
  built from the source code tarball by following the procedure
  outlined in <a target="_blank" href=
  "http://www.courier-mta.org/FAQ.html#rpm">http://www.courier-mta.org/FAQ.html#rpm</a>
  using the "courier-sox-<i>version</i>" tarball, and installing
  the "courier-sox" and "courier-sox-devel" binary RPMs
  afterwards.</p>

  <blockquote>
    <p><b>NOTE:</b> Be sure to read the <tt>README</tt>,
    <tt>NEWS</tt>, and <tt>INSTALL</tt> files in the <i>Courier</i>
    mail server Socks 5 library toolkit, before attempting to
    install it for the first time (unless using the RPM build
    method).</p>
  </blockquote>

  <p>Socks proxying must be implemented in relatively low-level
  manner, and may not work on all operating systems. This is why it
  is packaged separately, in case that it doesn't work. The
  <code>configure</code> script, described in the following
  section, enables Socks 5 support automatically if the
  <i>Courier</i> mail server Socks 5 proxy client library is
  already installed. To make sure that the library is installed
  correctly, specify the "<code>--with-socks</code>" option to the
  following <code>configure</code> script. This option aborts the
  <code>configure</code> script if it does not detect the
  <i>Courier</i> mail server Socks 5 proxy client library.</p>

  <h2><a name="configure" id="configure">Run configure</a></h2>

  <p>After you are squared away with the preliminaries, run the
  <code>configure</code> script:</p>

  <p><code>./configure [ options ]</code></p>

  <blockquote>
    <p><b>NOTE</b></p>

    <p>You MUST run the <code>configure</code> script as normal
    user, not root. Did you extract the tarball as root? It won't
    work. Delete everything you have just extracted, as root. Log
    in as a normal user. Extract the source code as a normal user,
    then run <code>configure</code>. You will do everything as a
    normal user, except for the final step of installing the
    compiled software. When you're ready to do a <code>make
    install</code>, later, <code>su</code> yourself to root, and
    run <code>make install</code>.</p>
  </blockquote>

  <p>The <code>configure</code> script can take a while to
  complete. There will be more then thirty separate configuration
  scripts that will be executed by this command. To an untrained
  eye it may seem that the same configuration script is stuck in a
  loop; that's because all these configuration scripts share a lot
  of code. It may take as much as 15-20 minutes for
  <code>configure</code> to finish on a slow machine - even
  more.</p>

  <p>You must have the <code>uux</code> command in your default
  search path if you intend to use the <i>Courier</i> mail server
  to relay mail via UUCP. You may need to modify your
  <code>PATH</code> environment variable to include the directory
  containing <code>uux</code>.</p>

  <p><code>gcc/egcs</code> is officially blessed for building the
  <i>Courier</i> mail server. In most cases there's no need to
  tweak any compiler-specific settings. Note that there currently
  may be some unresolved issues with gcc 2.96. gcc 2.91 has been
  tested and known to work. Occasionally some of your system
  libraries may be stuck in some oddball directory that is not
  searched by default. Non-standard options for the compiler or
  linker can be set by putting them into environment variables.
  This must be done before running the
  <code>configurescript:</code></p>

  <ul>
    <li>
      <code>CFLAGS</code>

      <p>Additional flags for the C compiler.</p>
    </li>

    <li>
      <code>CXXFLAGS</code>

      <p>Additional flags for the C++ compiler.</p>
    </li>

    <li>
      <code>LDFLAGS</code>

      <p>Additional flags for the linker.</p>
    </li>

    <li>
      <code>LDADD</code>

      <p>Additional libraries to link with. NOTE -
      <i>everything</i> will be linked with these libraries.</p>
    </li>
  </ul>

  <p>The complete reference to all <code>configure</code> script
  options is provided below. The most important options are:</p>

  <ul>
    <li>
      <code>--prefix=pathname</code>

      <p>Install the <i>Courier</i> mail server in <i>pathname</i>,
      instead of the default location of
      <code>/usr/lib/courier</code>. Note - the examples in the
      rest of this text assumes this is where you will install the
      <i>Courier</i> mail server. Do not attempt to install the
      <i>Courier</i> mail server in a directory whose name contains
      spaces or punctuation marks. Periods or dashes are fine, but
      refrain the temptation to use other, exotic, punctuation.</p>
    </li>

    <li>
      <code>--with-db=db</code> or <code>--with-db=gdbm</code>

      <p>The <i>Courier</i> mail server requires either the GDBM or
      the DB database library. GDBM is used if both are present.
      This option forces the selection of the database library.</p>
    </li>

    <li>
      <code>--with-locking-method=<i>function</i></code>

      <p>Select a file locking function. Available functions are:
      <code>fcntl</code>, <code>lockf</code>, and
      <code>flock</code>. Not every function is available on every
      platform. If this option is not present,
      <code>configure</code> tries each one, and takes the first
      one that works. You can select a specific locking function by
      using this option. This affects both the locking used for
      delivering mail to mailbox files, and for other kinds of
      locking that the <i>Courier</i> mail server uses
      internally.</p>
    </li>

    <li>
      <code>--enable-mimecharset=charset</code>

      <p>Specify the default character set the <i>Courier</i> mail
      server uses when adding MIME headers to a message. If not
      specified, <code>us-ascii</code> is used.</p>
    </li>

    <li>
      <code>--without-tcpddns</code>

      <p>Use this option if you are running a small network without
      access to a DNS server. This option will cause
      <code>couriertcpd</code> to use the system resolver's
      <i>gethostby</i> functions instead of issuing DNS queries.
      Also: you must initialize the <code>esmtproutes</code>
      control file with the IP addresses of all your servers.</p>
    </li>
  </ul>

  <h3><code>configure</code> reference</h3>

  <p>Here's a comprehensive list of options for the
  <code>configure</code> script. They are presented in no
  particular order. In almost all cases, the <code>configure</code>
  script will automatically figure out the correct values, but
  sometimes it is necessary to specify them explicitly. If you ever
  have a need to manually specify any configuration option, try to
  determine whether you need it because of a particular unique case
  that involves your server only, or whether it affects any server
  running your hardware, or system. In the later case, try to
  investigate if it's possible for <code>configure</code> to be a
  bit smarter and make the right decision.</p>

  <ul>
    <li>
      <code>--prefix=<i>pathname</i></code>

      <p>Install the <i>Courier</i> mail server in <i>pathname</i>,
      instead of the default location of
      <code>/usr/lib/courier</code>. Note - the examples in the
      rest of this text assumes this is where you will install the
      <i>Courier</i> mail server.</p>
    </li>

    <li>
      <code>--exec-prefix=<i>pathname</i></code>

      <p>Specify where the <i>Courier</i> mail server's
      machine-executable binaries should be installed. This
      defaults to the same directory as given by the
      <code>--prefix</code> option. There will be three
      subdirectories created underneath <code>exec-prefix</code>:
      <code>bin</code> - user-executable binaries;
      <code>sbin</code> - superuser-only binaries;
      <code>libexec</code> - other binaries that are not directly
      invoked from the command line, but are started by other
      <i>Courier</i> mail server commands.</p>
    </li>

    <li>
      <code>--bindir=pathname</code>,
      <code>--sbindir=pathname</code>,
      <code>--libexecdir=pathname</code>

      <p>These options override the default value for the
      corresponding subdirectory underneath
      <code>--exec-prefix</code> (see above). The
      <code>bindir</code> directory contains programs that can be
      executed by anyone. <code>sbindir</code> contains programs
      that can only be executed by the superuser.
      <code>libexecdir</code> contains programs and libraries that
      cannot be directly executed from the command line. The
      default locations are the <code>bin</code>,
      <code>sbin</code>, and <code>libexec</code> subdirectories
      underneath the directory specified by
      <code>exec_prefix</code>.</p>
    </li>

    <li>
      <code>--datadir=pathname</code>

      <p>Specify the directory where miscellaneous shell scripts,
      Perl scripts, and data files will be installed. This option
      defaults to the subdirectory "<code>share</code>" in the
      directory specified by the <code>--prefix</code> option.</p>
    </li>

    <li>
      <code>--sysconfdir=pathname</code>

      <p>Specifies the directory where the <i>Courier</i> mail
      server's configuration files are installed. This option
      defaults to the subdirectory "<code>etc</code>" in the
      directory specified by the <code>--prefix</code> option.</p>
    </li>

    <li>
      <code>--localstatedir=pathname</code>

      <p>Specify the directory that will hold the mail queue, and
      other temporary data. This option defaults to the
      subdirectory "<code>var</code>" in the directory specified by
      the <code>--prefix</code> option.</p>
    </li>

    <li>
      <code>--without-ipv6</code>

      <p>Do not compile IPv6 support. IPv6 support, if available is
      normally automatically detected and enabled. Use
      <code>--without-ipv6</code> to disable it. IPv6
      implementations on various platforms is still in flux, and
      IPv6 support will not be enabled if the detection logic
      fails. Use <code>--with-ipv6</code> in order to fail the
      configuration stage if IPv6 is not detected, instead of
      silently continuing with IPv4 support only. See "<a href=
      "#ipv6">IPv6</a>" below for more information.</p>
    </li>

    <li>
      <code>--with-db=db</code> or <code>--with-db=gdbm</code>

      <p>The <i>Courier</i> mail server requires either the GDBM or
      the DB database library. GDBM is used if both are present.
      This option forces the selection of the database library.</p>
    </li>

    <li>
      <code>--with-locking-method=</code><i><code>function</code></i>

      <p>Select a file locking function. Available functions are:
      <code>fcntl</code>, <code>lockf</code>, and
      <code>flock</code>. Not every function is available on every
      platform. If this option is not present, configure will
      choose the first locking function that's available. You can
      select a specific locking function by using this option. This
      affects both the locking used for delivering mail to mailbox
      files, and for other kinds of locking that the <i>Courier</i>
      mail server uses internally.</p>
    </li>

    <li>
      <code>--enable-mimecharset=<i>charset</i></code>

      <p>Specify the default character set the <i>Courier</i> mail
      server uses when adding MIME headers to a message. If not
      specified, <code>us-ascii</code> will be used.</p>
    </li>

    <li>
      <code>--without-tcpddns</code>

      <p>\Use this option if you are running a small network
      without access to a DNS server. This option will cause
      <code>couriertcpd</code> to use the system resolver's
      <i>gethostby</i> functions instead of issuing DNS queries.
      Also: you will have to initialize the smtproutes control file
      with the IP addresses of all your servers.</p>
    </li>

    <li>
      <code>--without-explicitsync</code>

      <p>Normally the <i>Courier</i> mail server will automatically
      sync, or flush out all file buffers to disk, at certain key
      points in order to try to minimize the extent the mail queue
      can get corrupted if the system crashes. If the mail queue is
      installed on a reliable disk array or a network file server,
      this may not be necessary, and will only serve to slow down
      the mail delivery. Use this option to turn off syncing.</p>
    </li>

    <li>
      <code>--with-dirsync</code>

      <p>Also explicitly sync the parent directory. There's a
      school of thought which believes that the Linux ext2
      filesystem requires the parent directory to also be synced,
      in addition to the new message file that's just been written
      to disk. There's another school of thought that thinks that
      this issue is completely blown out of proportion, and is
      really nothing more than a tempest in a teapot. However -- to
      accomodate the former school of thought -- this option adds a
      little bit of extra code to sync the parent directory.</p>
    </li>

    <li>
      <code>--with-shellpath=<i>path</i></code>

      <p>Specify the contents of the <code>PATH</code> environment
      variable that is inherited by custom programs started by the
      <i>Courier</i> mail server to deliver messages. If not
      specified, <code>PATH</code> will be set to
      <code>/bin:/usr/bin:/usr/local/bin</code>.</p>
    </li>

    <li>
      <code>--disable-local-extensions</code>

      <p>Normally, in addition to accepting mail that's addressed
      to <code>&lt;user@domain.com&gt;</code>, The <i>Courier</i>
      mail server can accept mail that's addressed to
      <code>&lt;user-xxx@domain.com&gt;</code>, for arbitrary
      values of <i>xxx</i>. In order for that to happen the
      <code>user</code> has to create a special file with delivery
      instructions. See the <a href=
      "dot-courier.html"><code>dot-courier(5)</code></a> manual
      page for more information. This option disables this
      feature.</p>
    </li>

    <li>
      <code>--with-paranoid-smtpext</code>

      <p>Be paranoid when negotiating the <i>Courier</i> mail
      server-specific ESMTP extensions with remote servers. The
      <i>Courier</i> mail server defines and implements certain
      experimental ESMTP extensions: <code>XVERP</code> and
      <code>XEXDATA</code>. Problems may result in the event that
      someone else uses the same name to implement some other
      extension. If this option is specified, The <i>Courier</i>
      mail server's <code>ESMTP</code> server will also advertise a
      dummy ESMTP capability called
      <code>XCOURIEREXTENSIONS</code>, and will not recognize any
      the <i>Courier</i> mail server-specific extensions unless the
      remote mail server also advertises this dummy ESMTP
      capability.</p>
    </li>

    <li>
      <code>--enable-workarounds-for-imap-client-bugs</code>

      <p>There are several confirmed bugs in some IMAP clients that
      do not properly implement the IMAP4rev1 protocol. This option
      enables some workarounds for those buggy IMAP clients. NOTE:
      <code>make check</code> will fail if this option is used. You
      should first configure without this option, and if all
      post-configuration tests succeed, rerun configure with this
      option and recompile.</p>
    </li>

    <li>
      <code>--with-qdircount=<i>n</i></code>

      <p>Set <i>n</i> to be the number of mail queue
      subdirectories. In order to improve the speed of access to
      the mail queue, messages are stored in subdirectories, hashed
      by the message queue number. <i>n</i> specifies how many
      subdirectories will be created. If this option is not
      specified, 100 subdirectories will be used. <b>WARNING:</b>
      once you've installed the <i>Courier</i> mail server once, if
      you decide to reconfigure and reinstall, you MUST use the
      same subdirectory count (by default, or explicitly),
      otherwise you'll end up with a big mess on your hands if you
      have ANY messages in the mail queue. If you need to change
      this option, wait for all messages in the queue to be flushed
      out, and reinstall with an empty mail queue.</p>
    </li>

    <li>
      <code>--with-random=<i>/dev/path</i>, --without-random</code>

      <p>Sometimes the <i>Courier</i> mail server sometimes needs a
      good source of random noise. If <code>configure</code> finds
      <code>/dev/urandom</code>, it will use that. If your random
      device is named otherwise, specify it using this option. If
      you don't want to use a random device, specify
      <code><i>--without-random</i></code>, and the <i>Courier</i>
      mail server will generate some noise on its own. The
      <i>Courier</i> mail server will generate noise based on the
      output of a random ps command, and several other, hopefully
      unpredictable, sources.</p>
    </li>

    <li><code>--with-gnutls</code> - Use the GnuTLS library even if
    the OpenSSL library is also installed. The <i>Courier</i> mail
    server automatically uses whichever one is available. The
    OpenSSL library is selected if both are present. Use this
    option to override and select GnuTLS instead.</li>

    <li>
      <code>--without-certdb</code>

      <p>Do not install a default set of trusted X.509 root CA
      certs (in order to validate the remote server's X.509
      certificate). See "<a href="#esmtpauth">Configure ESMTP
      authentication and SSL</a>" for more information.</p>
    </li>

    <li>
      <code>--with-certdb=<i>pathname</i></code>

      <p>Do not install the default set, but put <i>pathname</i> as
      the default location of the root CA database, into the
      configuration file. This is a convenient option to have the
      <i>Courier</i> mail server use an external, previously
      installed, root CA database.</p>
    </li>

    <li>
      <code>--with-waitfunc=wait, --with-waitfunc=wait3</code>

      <p>Specify the system call to use to asynchronously reap
      child processes. This is a sticky one, because the behavior
      of the wait and wait3 system calls varies greatly depending
      on the level of each individual system's POSIX compliance.
      The configure script will attempt to compile and run some
      test programs in order to attempt to figure out which system
      call actually works. If the configure script fails, or if it
      selects a wrong function (which will be evident when mail
      delivery stops, and you have a bunch of zombies that are not
      being reaped), you might have to manually specify it using
      either option. In that case, however, you should also examine
      the test programs, investigate what went wrong, and patch the
      test programs to give a correct result for your system.</p>
    </li>

    <li>
      <code>--without-ispell, --with-ispell=<i>program</i></code>

      <p>The <i>Courier</i> mail server's webmail server can use
      spell checking, if the ispell program is available (aspell
      can be used too). If configure finds ispell, spell checking
      is enabled. Use <code>--without-ispell</code> to forcefully
      disable spell checking. If ispell is not in the current
      search path, use <code>--with-ispell=<i>program</i></code> to
      explicitly set the location of ispell. See "<a href=
      "#webmail">Configure the webmail server</a>" for more
      information on ispell or aspell.</p>
    </li>

    <li>
      <code>--enable-imageurl=<i>/url</i></code>

      <p>Use <i>/url/</i> as the URL to the static images displayed
      by the webmail server. HTML pages are dynamically generated
      by the webmail server CGI, but they also include some static
      icons. The webmail CGI will use <i>/url</i> as the URL to the
      directory containing the static images. The default URL is
      "/webmail", which means that the static images must be
      installed in the <code>&lt;DocumentRoot&gt;/webmail</code>
      directory. This is a manual process that is described in more
      detail in the "<a href="#webmail">Configure the webmail
      server</a>" section, below.</p>
    </li>

    <li>
      <code>--enable-https, --enable-https=login,
      --enable-https=auto</code>

      <p>If you have an SSL-enabled web server, use the
      <code>--enable-https</code> option in order to configure
      webmail access for SSL. Use <code>--enable-https=login</code>
      in order to use SSL only when logging in, to send the
      password. Use <code>--enable-https=auto</code> to generate
      relative URLs, so that users can connect with either http or
      https and their session will remain that way.</p>

      <p><code>--enable-https=login</code> and
      <code>--enable-https=auto</code> require that your http and
      https URLs that refer to the webmail CGI be identical (which
      is the usual default).</p>

      <p><code>--enable-https=auto</code> is the default. Use
      <code>--disable-https</code> if you need to completely
      disable https, for some reason.</p>
    </li>

    <li>
      <code>--enable-hardtimeout=7200</code>

      <p>set the hard timeout for webmail sessions (in seconds).
      The default is 2 hours. webmail sessions are unequivocally
      logged out after the indicated time interval.</p>
    </li>

    <li>
      <code>--enable-softtimeout=1200</code>

      <p>set the inactivity timeout for webmail sessions (in
      seconds). The default is 20 minutes. webmail sessions are
      logged out if there's no activity for the indicated time
      interval.</p>
    </li>

    <li>
      <code>--with-defaultlang=<i>lang</i></code>

      <p>reserved for future use.</p>
    </li>

    <li>
      <code>--enable-mimetypes=file:file:file</code>

      <p>this is a colon-separated list of all of your
      <code>mime.types</code> files. The <code>mime.types</code>
      configuration files are used to map file extension to their
      corresponding MIME content types. The configuration script
      will look in several directories where
      <code>mime.types</code> usually exists. You can use this
      option to explicitly specify a list of
      <code>mime.types</code> files to be used, instead of the
      default.</p>
    </li>

    <li>
      <code>--enable-bannerprog=<i>pathname</i></code>

      <p>advanced option that sets a banner program that the
      webmail server will execute. This program should print HTML,
      on standard output, to generate a typical banner.</p>
    </li>

    <li>
      <code>--with-maxargsize=<i>bytes,</i>--with-maxformargsize=<i>bytes</i></code>

      <p>Sets an upper limit on the size of CGI arguments for the
      webmail server. Normally there's no reason to modify the
      defaults (500,000 and 2,000,000 bytes). The latter is
      generally the maximum allowed size of an attachment. The
      former is generally the maximum allowed size of the typed
      message. These settings can also be adjusted at runtime. See
      <a href="#maxsizes">Maximum message size</a>, below.</p>
    </li>

    <li>
      <code>--with-maxmsgsize=<i>bytes</i></code>

      <p>Sets the upper limit of messages composed in the webmail
      server, the main text and all the attachments. This setting
      can also be adjusted at runtime. See <a href=
      "#maxsizes">Maximum message size</a>, below.</p>
    </li>

    <li>
      <code>--with-cachedir=<i>dir</i>,
      --with-cacheowner=<i>userid</i></code>

      <p>The webmail server uses a cache of currently active
      logins. The webmail server binary, is executed for each and
      every HTTP request, and the user's maildir needs to be
      quickly located each time. Because hitting the authentication
      module can be expensive (think MySQL/PostgreSQL/LDAP query
      for every HTTP request!) the webmail server will cache this
      information in order to avoid having your authentication
      server brought down to its knees. By default, the directory
      <code>/usr/lib/courier/var/webmail-logincache</code> will be
      used, owned by the <i>bin</i> user. These options can be used
      to specify a different location for the webmail login cache
      directory.</p>

      <p>If you'll be using the webmail server, you MUST add an
      hourly cron job to run the
      <code>/usr/lib/courier/share/sqwebmail/cleancache.pl</code>
      script which deletes expired cache records from the cache
      directory. Add the following command to be executed from cron
      at least once an hour:</p>
      <pre>
su -c "/usr/lib/courier/share/sqwebmail/cleancache.pl" bin
</pre>

      <p>(This assumes that your cache directory is owned by the
      <code>bin</code> user). There's no need to set up this cron
      job if the webmail server is not used. NOTE: your su command
      may use different options or syntax, check the su manual page
      to confirm the correct syntax.</p>
    </li>

    <li>
      <code>--without-gzip</code>

      <p>if the configuration script finds the gzip utility, the
      webmail server will automatically use gzip compression for
      some large web pages (if the client browser supports gzip
      compression). Use this option to turn off gzip
      compression.</p>
    </li>

    <li>
      <code>--disable-autorenamesent</code>

      <p>do not rename the Sent folder every month. This option can
      also be controlled by the SQWEBMAIL_AUTORENAMESENT
      environment variable (which can be set in Apache's
      httpd.conf, for example). This setting gives the initial
      configuration, that can be individually adjusted in the
      Preferences screen.</p>
    </li>

    <li>
      <code>--with-calendarpurge=N</code>

      <p>if calendaring is enabled, purge expired calendar events
      after N days (default: 30).</p>
    </li>

    <li>
      <code>--with-trashquota</code>

      <p>include deleted messages, and the Trash folder, in the
      estimated quota usage for maildirs. Quotas are optional, see
      the file maildir/README.maildirquota.html for more
      information. The default configuration does not count
      messages marked as deleted (but not yet expunged) and the
      contents of the Trash folder (which are automatically purged
      by the server) against the quota usage. NOTE - if this option
      is used, <code>make check</code> WILL FAIL. You should first
      configure the <i>Courier</i> mail server without this option,
      run <code>make check</code>, then reconfigure the
      <i>Courier</i> mail server with this option.</p>
    </li>
  </ul>

  <h2><a name="ipv6" id="ipv6">IPv6</a></h2>

  <p>IPv6 support in the <i>Courier</i> mail server means basically
  the following:</p>

  <ul>
    <li>ESMTP, IMAP, and POP3 servers will create an IPv6 socket
    and accept IPv6 connections.</li>

    <li>The ESMTP client will attempt to resolve AAAA records in
    addition to A records.</li>

    <li>Headers in incoming mail will log IPv6 addresses, instead
    of IPv4 addresses. Delivery Status Notifications and log files
    will also reflect IPv6 addresses.</li>
  </ul>

  <p>IPv6 implementations are required to accept IPv4 connections
  on IPv6 sockets, so IPv6 sockets should be able to receive both
  IPv4 and IPv6 connections. In the event that your IPv6
  implementation is not stable, or is partially incomplete, IPv6
  support in the <i>Courier</i> mail server should be disabled.</p>

  <p>The configuration script will attempt to detect whether IPv6
  structures and functions are available, and automatically enable
  IPv6 support if they are found. The <code>--without-ipv6</code>
  option disables IPv6 support, which may be desired for the
  following reasons:</p>

  <ul>
    <li>The IPv6 implementation on your platform is
    incomplete.</li>

    <li>The IPv6 implementation on your platform is actually not
    available, despite the presence of IPv6 structures and
    functions. Most GNU/Linux distributions ship without IPv6
    support enabled in the default kernel build. The <i>Courier</i>
    mail server automatically falls back to creating an IPv4
    socket, if it can't create an IPv6 socket, so things should
    continue to work in that case. However, each such attempt is
    likely to result in an error message logged to
    <code>/var/log/messages</code> -- modprobe is whining that it
    can't find an IPv6 module to load. On systems that handle a
    large amount of traffic the log files can fill up rather
    quickly.</li>

    <li>Implementing IPv6 can increase the amount of DNS traffic,
    even if there is no IPv6 support in the kernel. Even if the
    <i>Courier</i> mail server falls back to IPv4 sockets, it will
    continue to resolve IPv6 addresses, resulting in some extra DNS
    queries. There won't be a lot of extra DNS queries, but there
    will be some. Also, there are still some DNS servers that
    cannot correctly handle IPv6 queries, and attempts to deliver
    mail to these domains will fail despite the presence of valid
    IPv4 records.</li>
  </ul>

  <p>IPv6 support is still a bit spotty in some places. If the
  configuration checks fail, IPv6 support will be quietly
  suppressed. If you expect IPv6 support to be present, the
  <code>--with-ipv6</code> flag can be used to abort configuration
  if IPv6 support was not detected.</p>

  <h2><a name="compile" id="compile">Compile and run <code>make
  check</code></a></h2>
  <pre>
    make
    make check
</pre>

  <p>If the <code>configure</code> script ran without errors, run
  <code>make</code> to build the <i>Courier</i> mail server. If
  <code>make</code> completes succesfully, run <code>make
  check</code>. <code>make check</code> runs some simple internal
  tests. It is not feasible to run a complete check of the
  <i>Courier</i> mail server's behavior, but <code>make
  check</code> does automatically run some tests on several
  modules.</p>

  <p>If <code>make check</code> fails, you need to do some
  detective work. Investigate the source of the failure. It is
  possible that the issue can be resolved by specifying different
  options to the <code>configure</code> script, in which case you
  have to go back and rerun the <code>configure</code> script
  again.</p>

  <h2><a name="install" id="install">Installation</a></h2>

  <p><code>su</code> yourself to root, if you want to do a live
  install, then run <code>make install</code> or <code>make
  install-strip</code> to install the <i>Courier</i> mail server.
  If you use the GNU version of <code>make</code>, and you would
  like to see which files the <i>Courier</i> mail server installs
  and where, don't <code>su</code> yourself to root, but set the
  <code>make</code> variable named <code>DESTDIR</code>. For
  example:</p>

  <p><code>make install DESTDIR=/var/tmp/courier-inst</code></p>

  <p>The contents of DESTDIR are prepended to the name of every
  file installed, so if <code>--prefix</code> was set to
  <code>/usr/lib/courier</code>, the files will be installed in
  <code>/var/tmp/courier-inst/usr/lib/courier</code>. This only
  works if you use GNU make.</p>

  <p><b>NOTE:</b> you must make sure that your umask is 022 before
  you run make install.</p>

  <p>If executed by root, <code>make install</code> automatically
  sets the correct ownership on the installed files. Non-root
  <code>make installs</code> do not set the ownership, but still
  set correct permissions. This feature is mainly for use by people
  who are rolling the <i>Courier</i> mail server into a prebuilt
  package, since this allows them to build the package as a normal
  user, not root. In this situation the command <code>make
  install-perms</code> will be very useful. This command creates a
  file called <code>permissions.dat</code>. This file contains a
  complete listing of everything that will be installed, and what
  the correct permissions are on every file.</p>

  <p><code>make install</code> installs the <i>Courier</i> mail
  server binaries with debugging data, which is probably a good
  idea to do while the <i>Courier</i> mail server is in
  development. Use <code>make</code><code>install-strip</code> to
  install binaries without debugging data. Some systems have a
  broken <code>install</code> utility, so make install-strip may
  fail.</p>

  <h2><a name="installconfigure" id="installconfigure">Install
  configuration files</a></h2>

  <p>The following command creates and updates configuration files.
  It must be executed after running <code>make install</code>:</p>

  <p><code>make install-configure</code></p>

  <p>This command copies each configuration file
  "<i>filename.dist</i>" to "<i>filename</i>". The existing
  <i>filename</i> is backed up as <i>filename.bak</i>. If upgrading
  from the <i>Courier</i> mail server 0.30 or later, the previous
  configuration settings in <i>filename.bak</i> will be
  automatically copied to <i>filename</i>, provided that they are
  still valid. If a configuration setting may no longer be valid,
  it will be reset to its default value. The output of <code>make
  install-configure</code> will indicate the status of each
  configuration setting, therefore it is advistable to save the
  output to a file, and examine it:</p>

  <p><code>make install-configure &gt;upgrade.log</code></p>

  <p>Versions prior to 0.30 cannot have their configuration
  settings automatically preserved, and must be restored manually
  from <i>filename.bak</i>. Do not simply copy <i>filename.bak</i>
  to <i>filename</i>, this will lose all the formatting codes that
  allow automatic upgrades.</p>

  <h3>PAM configuration</h3>

  <p>If you use PAM library for authentication, you may need to set
  up PAM for authenticating POP3 logins, IMAP logins, webmail
  logins, and/or ESMTP authentication. In most cases, all you have
  to do is install <code>/usr/lib/courier/etc/pop3d.authpam</code>
  as <code>/etc/pam.d/pop3</code>,
  <code>/usr/lib/courier/etc/imapd.authpam</code> as
  <code>/etc/pam.d/imap</code>,
  <code>/usr/lib/courier/etc/webmail.authpam</code> as
  <code>/etc/pam.d/webmail</code>, and
  <code>/usr/lib/courier/etc/esmtp.authpam</code> as
  <code>/etc/pam.d/esmtp</code>. However you will have to consult
  your PAM documentation, and the manual pages for
  <code>authpam</code>, in order to make sure.</p>

  <p>Some versions of the PAM library, do not use the
  <code>/etc/pam.d</code> directory. Instead they use a single
  configuration file <code>/etc/pam.conf</code>. Here's an example
  of what needs to be added to <code>/etc/pam.conf</code> on
  FreeBSD 4.0. NOTE: other platforms may need something
  similar:</p>
  <pre>
imap  auth    required        pam_unix.so      try_first_pass
imap  account required        pam_unix.so
imap  session required        pam_permit.so
pop3  auth    required        pam_unix.so      try_first_pass
pop3  account required        pam_unix.so
pop3  session required        pam_permit.so
esmtp auth    required        pam_unix.so      try_first_pass
esmtp account required        pam_unix.so
esmtp session required        pam_permit.so
</pre>

  <h3>Building RPM packages</h3>

  <p>NOTE: If you build an RPM package directly from the source
  tarball, the resulting RPMs may not install if you have an
  existing IMAP or an existing POP3 server installed. The RPM
  packages will contain these PAM configuration files, and they
  will conflict with any PAM configuration files installed by
  another IMAP or POP3 server. If you manually installed an IMAP or
  a POP3 server without packaging them up into an RPM, the
  <i>Courier</i> mail server RPM package will install and the old
  configuration files will be silently removed, since they were not
  installed using RPM.</p>

  <p>The <i>Courier</i> mail server includes integrated POP3, IMAP,
  and webmail servers, however they only work with maildirs. Decide
  if you want to keep using your current server, or switch to the
  <i>Courier</i> mail server's IMAP/POP3/webmail servers. If you
  want to keep your existing servers, back up the contents of your
  <code>/etc/pam.d</code> directory before installing the RPM,
  install it, then restore the overwritten files. If you want to
  switch to the <i>Courier</i> mail server, blow away your current
  server before running <code>make install</code>.</p>

  <h2><a name="suid" id="suid">Adjust system paranoia
  level</a></h2>

  <p>There are four setuid binaries in the <i>Courier</i> mail
  server that are owned by root: <code>sendmail</code>,
  <code>maildrop</code>, <code>webmail</code> and
  <code>webadmin</code>. There's also one setgid binary,
  <code>sqwebpasswd</code>.</p>

  <p><code>/usr/lib/courier/bin/maildrop</code> is the mail filter.
  If you do not need mail filtering, you can remove it. The setuid
  root privilege is only needed to implement mail filtering "on the
  wire", when receiving mail from an external mail relay (see
  <a href="localmailfilter.html">localmailfilter(7)</a> for more
  information). Removing the setuid root bit still allows
  traditional mail filtering to be used, after the message is
  received and delivered to the mailbox.</p>

  <p><code>/usr/lib/courier/libexec/courier/webmail/webmail</code>
  is the webmail CGI. It is executed by the web server, and needs
  to change its userid/groupid, in order to enter the maildir. If
  you do not need webmail access, you can remove it. An alternative
  is to implement virtual mailboxes, owned by a non-privileged
  userid, and change the ownership of the webmail CGI to the
  non-privileged user (you will also need to use the
  <code>--with-cacheowner</code> option to the
  <code>configure</code> script since the webmail process must have
  write access to the webmail login cache directory).</p>

  <p><code>/usr/lib/courier/libexec/courier/webmail/webadmin</code>
  is the wrapper for the web-based administration tool. <a href=
  "#webadmin">See below</a> for more information.</p>

  <p><code>/usr/lib/courier/bin/sendmail</code> is the command line
  mail sender. Its first order of business is to set its group id
  to the <i>Courier</i> mail server's group id, and restore the
  original userid, dropping root. The reason that it needs root
  setuid is to set its real group id, because setting the setgid
  bit on the executable is not enough. The setgid bit sets only the
  effective group id, and the root setuid bit is required to set
  both effective and real group ids. Both real and effective group
  IDs are needed in order to be able to implement maildrop mail
  filtering.</p>

  <p><code>/usr/lib/courier/libexec/courier/sqwebpasswd</code> is
  described in detail in the "<a href="#changepass">OPTIONAL:
  Changing mail account passwords using the webmail server</a>"
  section.</p>

  <h2><a name="postinst" id="postinst">Post-installation
  setup</a></h2>

  <p>A first-time the <i>Courier</i> mail server installation may
  not require the system startup scripts to be modified to start
  the <i>Courier</i> mail server at system boot. Until the system's
  functionality is verified, the system will probably continue to
  use the existing mail server. Still, most the <i>Courier</i> mail
  server configurations will require two things to be started
  before any part of the system is put to use:</p>

  <ul>
    <li>An hourly <code>cron</code> job needs to be created to run
    the <code>cleancache.pl</code> script, which purges expired
    webmail login cache records. Logging in to the mail account via
    the web creates a file in a temporary directory that caches the
    login session identity. The output of <code>make install</code>
    includes the command that needs to be set up as a
    <code>cron</code> job by root. The <code>cron</code> job runs
    <code>su</code> to change to the userid that owns the login
    cache directory, then runs the purge script. The
    <code>su</code> command on some system uses a slightly
    different syntax than what's shown by <code>make
    install</code>. It may be necessary to consult the
    <code>su</code> man page before setting up the cron job. Run
    the <code>su</code> command as root, to make sure that its
    syntax is correct, before setting up the <code>cron</code> job.
    The <code>cron</code> job can be omitted if webmail is not
    going to be used.</li>
  </ul>

  <h2><a name="checks" id="checks">Post-installation
  checks</a></h2>

  <p>The following tests should be run to verify that your
  installation works properly. These tests are not really
  comprehensive tests, they only make sure that the basic
  functionality is there, and they definitely must be done the
  first time you install a version of the <i>Courier</i> mail
  server on your system. If you later reinstall the same version on
  the same platform, using the same configuration, you don't need
  to run these installation checks (but you better be sure that the
  reinstallation is COMPLETELY identical to the original install).
  You might also wish to rerun these installation checks after
  upgrading your base operating system.</p>

  <p>The following documentation assumes that the <i>Courier</i>
  mail server is installed in <code>/usr/lib/courier</code>.</p>

  <h3>Verify module installation</h3>

  <p>Run the <code>showmodules</code> utility after all files have
  been installed, but before you attempt to start the
  <i>Courier</i> mail server. The <code>showmodules</code> utility
  attempts to load and initialize transport modules that have been
  configured, without actually starting up the <i>Courier</i> mail
  server. Running <code>showmodules</code> should result in
  something that looks like this:</p>
  <pre>
<code>   showmodules[5060]: Loading STATIC transport module libraries.
   showmodules[5060]: Installing i586-gnu-linux [0/0]
   showmodules[5060]: Installing local
   showmodules[5060]: Installed local
   showmodules[5060]: Installing esmtp
   showmodules[5060]: Installed esmtp
   showmodules[5060]: Installing dsn
   showmodules[5060]: Installed dsn
   showmodules[5060]: Initializing local
   showmodules[5060]: Initializing esmtp
   showmodules[5060]: Initializing dsn</code>
</pre>

  <h3>Test child process termination</h3>

  <p>In this test, you will start the <i>Courier</i> mail server,
  then attempt to rapidly pump through as many messages as fast as
  possible, to verify that asynchronous child process termination
  handling works. For this test (and the following tests) you need
  to use a test account.</p>

  <p>Log on to the test account and run <code>maildirmake</code> to
  create two maildirs: <code>maildirmake $HOME/test</code>, and
  <code>maildirmake $HOME/bounces</code>.</p>

  <p>Create <code>$HOME/.courier-test-default</code>, containing
  one line: <code>./test</code>. Create
  <code>$HOME/.courier</code>, containing one line:
  <code>./bounces</code>. If you previously selected .qmail
  compatibility, you will need to use
  <code>.qmail-test-default</code> and <code>.qmail</code>, of
  course. Keep that in mind as you work through the remaining
  tests.</p>

  <p>Start the <i>Courier</i> mail server as root:</p>

  <p><code>/usr/lib/courier/sbin/courier start</code></p>

  <p>Check your system log files for any error messages. Run the ps
  command, and check that you only have the following processes
  running: courierd (two processes), courierdsn, courieruucp,
  courieresmtp, and courierlocal. You will also have a couple of
  "logger" processes hanging around, that's ok too.</p>

  <p>One of the two courierd processes will be running as root. The
  courierlocal process will also be running as root. All other
  processes will be running as the courier (or daemon, or mail)
  user. <code>courieruucp</code> may be running as
  <code>uucp</code>.</p>

  <p>Run the <code>perftest1</code> script, which can be found in
  the directory containing the <i>Courier</i> mail server's source
  code:</p>
  <pre>
<code>sh perftest1 1000 "user-test-1 user-test-2 user-test-3 user-test-4 user-test-5"</code>
</pre>

  <p>Run this script while logged on to the test account. Replace
  "user" with the name of your test account. This will send 1000
  messages with five recipients per message. You should end up with
  exactly 5000 messages in <code>$HOME/test/new</code>. Count
  them.</p>

  <p>Monitor the system logs. There will be a lot of activity. On
  my test system, the system logger usually backs up. The
  <i>Courier</i> mail server generates log messages faster than the
  logger can record them. When all the activity stops, count how
  many files you have in <code>$HOME/test/new</code>. For extra
  credit, total up the <code>Delivered-To:</code> headers in all
  the messages, there should be 1000 headers for each one of the
  five addresses.</p>

  <p>If you did not get 5000 messages, and <code>mailq</code> comes
  up empty, check <code>$HOME/bounces/new</code>. If you're lucky,
  the rest bounced. That's still a problem, but the bounces will
  help you to investigate things further.</p>

  <p>If you did not get 5000 messages, and <code>mailq</code> shows
  some messages remaining in the queue, and <code>ps</code> shows
  some dead zombie processes that are not being reaped, this means
  that asynchronous process termination is not working. You will
  need to examine your configuration to see whether
  <code>configure</code> selected the <code>wait</code> or the
  <code>wait3</code> function. Unpack the source code again and
  rerun <code>configure</code>. This time use the
  <code>--with-waitfunc</code> option to choose the other wait
  function, manually. Recompile, reinstall, and rerun this
  test.</p>

  <p>If you did get all the messages, go through your syslog for
  extra-extra credit. <code>grep</code> it for the word "defer" to
  see if any messages required multiple delivery attempts. This
  shouldn't happen either.</p>

  <p>If your hardware has enough juice to pump through 5000
  messages in a short period of time, rerun this test with a larger
  number of messages. Before doing that, wipe the Maildirs clean,
  in order to confirm the message count, later. The test must run
  for at least 3-4 minutes in order to get meaningful results.</p>

  <h3>User/group ID check</h3>

  <p>For this test you will need to use or create a regular user
  test account, which will be referred to as <i>user</i>. You can
  use the same test account you used in the last test, but erase
  all <code>.courier</code> (or <code>.qmail</code>) files.</p>

  <p>In user's home directory, create <code>.courier</code> which
  contains the following text:</p>
  <pre>
| /usr/bin/id &gt;ID
| /usr/bin/env &gt;ENV
</pre>

  <p>Make sure that your <code>id</code> and <code>env</code>
  commands are in <code>/usr/bin</code>. If not, use the correct
  path.</p>

  <p>Send a single message to <i>user</i>:</p>

  <p><code>echo "To: <i>user</i>" |
  /usr/lib/courier/bin/sendmail</code></p>

  <p>Thie message will disappear into the never-never land, so
  don't waste time looking for it. Just examine, very closely, the
  contents of the <code>ID</code> and the <code>ENV</code> files in
  <i>user</i>'s home directory. Double check what user and the
  group ids recorded in <code>ID</code> match <i>user</i>'s. Pay
  close attention to any auxiliary group IDs, make sure that they
  haven't "leaked" from the root user who started the
  <i>Courier</i> mail server.</p>

  <p>Also, examine the environment, in <code>ENV</code>. Check the
  manual page for <code>dot-courier</code>, <code>ENV</code> should
  contain only the documented environment variables, and any
  environment variables that are defined in the
  <code>/usr/lib/courier/etc/courierd</code> file.</p>

  <h2><a name="webadmin" id="webadmin">OPTIONAL: Configure
  <code>webadmin</code></a></h2>

  <p>This is a web-based administration tool. <code>webadmin</code>
  is a web CGI application. It is necessary to have a local web
  server installed in order to use <code>webadmin</code>. Apache
  will do, but so will any other server with a complete CGI
  implementation (PHP is not required). Installing
  <code>webadmin</code> is a three step process:</p>

  <ol>
    <li>Move
    <code>/usr/lib/courier/libexec/courier/webmail/webadmin</code>
    to your web server's SSL <code>cgi-bin</code> directory. Take
    care to preserve the binary's ownership and permissions.</li>

    <li>Execute "<code>make install-webadmin-password</code>". This
    prompts for a password, which is saved in the file
    <code>/usr/lib/courier/etc/webadmin/password</code>.</li>

    <li>The web server SHOULD be configured to run
    <code>webadmin</code> from the <code>cgi-bin</code> directory
    using SSL only. <code>webadmin</code>'s authentication is
    rather simple: the password is saved in a cookie. Unless SSL is
    used, the <code>webadmin</code> password can be intercepted in
    transit. If SSL is not available, an acceptable level of
    security can be achieved by setting up a firewall that allows
    web access only from trusted IP addresses, then use a dedicated
    webadmin password. This is not perfect, but is generally
    adequate. A firewall is a good idea even if SSL is used. This
    is not Fort Knox, and <code>webadmin</code> is not going to be
    publicly accessible, so the only needed security is to keep
    everyone out except for authorized IP addresses.

      <p>Note that <code>webadmin</code>, by default, will enforce
      this restriction: either SSL, or access from a local IP
      address. Create the file
      <code>/usr/lib/courier/etc/webadmin/unsecureok</code> to
      allow non-SSL <code>webadmin</code> connections from remote
      IP addresses.</p>
    </li>
  </ol>

  <p><code>webadmin</code> is designed to be self-explanatory.
  Configuration options are divided into logical sections. Changes
  made to configuration options do not take effect immediately. To
  apply configuration changes, select "Install new configuration"
  from the main menu. To cancel all changes made, select "Cancel
  new configuration". Selecting "Install new configuration" will
  apply all the changes to the configuration files, and restart any
  the <i>Courier</i> mail server modules that must be restarted in
  order for the changes to take effect.</p>

  <p>If you decide to use <code>webadmin</code>, most of the
  remaining steps in this INSTALL document can be done using
  <code>webadmin</code>'s equivalent screens.</p>

  <h2><a name="aliases" id="aliases">Create system aliases</a></h2>

  <p>You must now specify which account gets postmaster mail.
  <b>The <i>Courier</i> mail server does NOT deliver any mail to
  root.</b> You must use a non-privileged for postmaster mail. You
  will also need to specify where your postmaster account is. In
  the following example the same account is used for both, but you
  can easily use separate mailboxes.</p>

  <p>Let's say that you want postmaster mail to be delivered to the
  user "admin".</p>

  <p>Create <code>/usr/lib/courier/etc/aliases/system</code> using
  any text editor. An example <code>aliases/system</code> file is
  created by <code>make install</code>, and you can simply edit
  what you have there. The default contents of this file are as
  follows:</p>

  <p><code>root: postmaster</code></p>

  <p><code>mailer-daemon: postmaster</code></p>

  <p><code>MAILER-DAEMON: postmaster</code></p>

  <p><code>uucp: postmaster</code></p>

  <p>You need to append the following line:</p>

  <p><code>postmaster: admin</code></p>

  <p>These aliases cause all mail addressed to <i>root</i>,
  <i>postmaster</i>, or <i>mailer-daemon</i>, to be delivered to
  admin's account. If you want root's mail delivered somewhere
  else, you can replace "<i>root: postmaster</i>", with something
  else.</p>

  <p>Run the following command as root:</p>

  <p><code>/usr/lib/courier/sbin/makealiases</code></p>

  <p>This command creates
  <code>/usr/lib/courier/etc/aliases.dat</code>, a database that
  contains your new aliases.</p>

  <p>Send a test message:</p>

  <p><code>echo "To: postmaster" |
  /usr/lib/courier/bin/sendmail</code></p>

  <p>Check admin's mailbox, the message should be there.</p>

  <p>Let's do it again:</p>

  <p><code>echo "To: postmaster" | /usr/lib/courier/bin/sendmail
  -Nsuccess</code></p>

  <p>This time, in addition to the blank message, the sending
  account should receive a return receipt.</p>

  <p>Additional aliases can be either added to this file, or placed
  in any other text file in the
  <code>/usr/lib/courier/etc/aliases</code> directory.</p>

  <h2><a name="access" id="access">Create smtp access list</a></h2>

  <p>You need to define which IP addresses are allowed to relay
  SMTP mail through the server. The installation script creates
  <code>/usr/lib/courier/etc/smtpaccess/default</code> containing
  an example of how to enable relaying for IP address 127.0.0.1,
  and several reserved netblocks. You can either append additional
  entries to this file, or put your additional entries in any other
  file in the <code>/usr/lib/courier/etc/smtpaccess</code>
  subdirectory. Afterwars, run the following as root:</p>

  <p><code>/usr/lib/courier/sbin/makesmtpaccess</code></p>

  <p>This command creates the
  <code>/usr/lib/courier/etc/smtpaccess.dat</code> database that
  <code>couriertcpd</code> uses to initialize the environment for
  <code>courieresmtpd</code>.</p>

  <p>You will need to rerun <code>makesmtpaccess</code> in order to
  rebuild <code>smtpaccess.dat</code> after any changes in the
  <code>smtpaccess</code> subdirectory.</p>

  <p>The default the <i>Courier</i> mail server configuration
  applies <code>smtpaccess.dat</code> to both the regular ESMTP
  server (port 25), and the message submission server (port 587).
  It is possible to set up different access files for both ports.
  To do that, edit <code>/usr/lib/courier/etc/esmtpd-msa</code>,
  and explicitly set <code>ACCESSFILE</code> to a different file,
  create that file, and use the <code>makesmtpaccess-msa</code>
  command to compile the dedicated port 587 access database.</p>

  <blockquote>
    <p><strong>NOTE:</strong> Authenticated SMTP is preferred over
    defining explicit IP address ranges. When combined with SSL,
    authenticated SMTP enables relaying privileges to any sender
    that securely provides a valid login/password, from any IP
    address, instead of only a small range of preauthorized IP
    addresses. The "<a href="#esmtpauth">OPTIONAL: Configure ESMTP
    authentication and SSL</a>" section, later in this installation
    guide, gives more information on enabling authenticated SMTP
    and SSL-based encryption.</p>

    <p>Furthermore, preauthorized IP address ranges are vulnerable
    to being a source of abusive backscatter E-mail. Using
    authenticated SMTP together with the optional backscatter
    setting, described in the following section, prevents
    transmission of abusive backscatter bounces to external
    recipients even from trusted senders that have been
    compromised.</p>
  </blockquote>

  <h2><a name="backscatter" id="backscatter">Backscatter
  suppression</a></h2>

  <blockquote>
    <p><strong>NOTE:</strong> It is important to know that the
    <i>Courier</i> mail server's default backscatter configuration
    means that if the <i>Courier</i> mail server receives a message
    for delivery to a local mailbox, and encounters an error during
    the delivery, the sender may not receive a delivery failure
    notification. The most common reason is an error in a custom
    mail filtering script. The next most common reason is a
    configuration error (the <i>Courier</i> mail server
    authentication library gives the account's home directory,
    optional non-default mailbox location, the account's system
    userid and groupid; but they differ from the actual files and
    directories (the home directory or the account's mailbox does
    not exist, exists somewhere else, or they're owned by a
    different userid or groupid).</p>

    <p>When installing the <i>Courier</i> mail server for the first
    time, it is usually helpful to termporary turn off the default
    backscatter filters, by setting BOFHSUPPRESSBACKSCATTER to
    "none", as described below. Remove this setting after the
    <i>Courier</i> mail server is installed and its basic functions
    appear to be working.</p>
  </blockquote>

  <p>The term "backscatter" refers to non-delivery reports sent to
  a forged return address. SMTP was created a long time ago, in
  better times when everyone trusted each other. Anyone could
  provide any return address for any E-mail message.</p>

  <p>Times have changed. At the time this documentation is written,
  most surveys report that between 75% and 80% of Internet E-mail
  is junk E-mail or viruses, with a forged return address.</p>

  <p>Backscatter becomes a problem when a mail server does not
  reject unwanted mail. The mail server decides that the message is
  unwanted only after it is accepted. It generates a non-delivery
  notice, and sends it to the original message's return address.
  Because viruses and junk mail use random forged return addresses,
  the unfortunate victim of address forgery must deal with large
  amounts of useless non-delivery notices from the mailbox. Not to
  mention a bunch of uninformed people who think he is responsible
  for sending the virus or the junk mail to them.</p>

  <p>There's now a growing consensus that backscatter bounces
  should be considered E-mail abuse. The <i>Courier</i> mail server
  is already very good at minimizing the amount of backscatter, by
  the virtue of refusing to receive any mail to a nonexistent local
  mailbox. However it's still possible for the <i>Courier</i> mail
  server to bounce a received message. Several settings control how
  the <i>Courier</i> mail server filters out its own backscatter,
  and avoids becoming a nuisance to others.</p>

  <p>Two settings are available. The first setting instructs the
  <i>Courier</i> mail server to simply discard backscatter bounces.
  This is the <code>ESMTP_BLOCKBACKSCATTER</code> setting in the
  <em>courierd</em> configuration file. This setting lists the
  so-called "message sources" which are dropped by the SMTP client.
  All messages from any matching source are quietly discarded. The
  default setting lists one message source: a code that means "a
  delivery status notification for a message received via SMTP from
  a non-authenticated source". "Non-authenticated" means a message
  received from an IP address that does not have relaying
  privileges, and did not authenticate. It's also possible to
  include authenticated SMTP sources; or it's possible to disable
  this setting altogether, instructing the <i>Courier</i> mail
  server to deliver all bounces via SMTP, even if they may
  potentially be backscatter.</p>

  <p>Note that messages received in other ways (such as messages
  sent via the sendmail command) are not affected. Their bounces
  will be sent via SMTP in all cases (although there exists an
  undocumented setting to block those bounces too). Also, bounces
  are always delivered to local mailboxes, this setting is ignored
  for local mail deliveries.</p>

  <p>The default setting means that if the <i>Courier</i> mail
  server receives a message via SMTP for delivery to a local
  mailbox, and it bounces for some reason, the bounce will be
  discarded.</p>

  <p>The <i>Courier</i> mail server is also often used as a
  smarthost for SMTP clients. These SMTP clients either connect
  from trusted IP addresses (IP addresses that belong to the
  organization that runs the mail server), or that succesfully
  authenticate, using SMTP authenticate. If those messages bounce,
  the non-delivery report gets delivered, because the default
  setting only drops bounces from non-authenticated source (a
  connection from a trusted IP address is always processed as if
  the sender succesfully authenticated).</p>

  <blockquote>
    <p><strong>NOTE:</strong> Sometimes the <i>Courier</i> mail
    server serves as a backup MX for another organization. If mail
    cannot be delivered to the primary MX (it rejects the message,
    or the message times out), the bounce will be discarded,
    because the message was probably received from a
    non-authenticated source.</p>
  </blockquote>

  <p>The second setting minimizes the possibility of generating a
  bounce, of any kind, in the first place. The second setting
  controls the backscatter suppression list, which is a list of
  blacklisted E-mail addresses.</p>

  <p>When the <i>Courier</i> mail server fails to deliver a message
  to an address, this address goes on the suppression list, and the
  <i>Courier</i> mail server will refuse to accept any more
  messages to the same address. If the delivery failure was a
  temporary failure, any future messages will also be turned away
  with a temporary error. A permanent delivery failure results in
  future messages rejected with a permanent error.</p>

  <p>Note that the suppression list does not apply to messages
  already accepted by the <i>Courier</i> mail server, and which are
  in its mail queue. The suppression list is checked when the
  <i>Courier</i> mail server is receiving a new message. The
  <i>Courier</i> mail server automatically clears an address from
  the suppression list after two hours. If the original message
  encountered a temporary delivery failure, The <i>Courier</i> mail
  server periodically tries again to re-deliver the message. If the
  message continues to encounter a temporary delivery failure, the
  clock starts running again, from the beginning, If a re-delivery
  attempts succeeds, the address is cleared from the suppression
  list, and the <i>Courier</i> mail server will now accept more
  messages to the same address, immediately.</p>

  <p>If a message keeps encountering temporary delivery failures,
  the time before re-delivery attempts gets longer. It's possible
  that it could take more than two hours for another delivery
  attempt, on a busy mail server. The address then falls off the
  list, and the <i>Courier</i> mail server will accept another
  message to the undeliverable address. This situation is
  unavoidable, but is not considered to be a major issue.</p>

  <p>The second setting is the <code>BOFHSUPPRESSBACKSCATTER</code>
  setting, in the <em>bofh</em> configuration file. See the
  <code>courier(8)</code> man page for more information. The
  default <code>BOFHSUPPRESSBACKSCATTER</code> setting also filters
  only messages from non-authenticated SMTP sources against the
  suppression list.</p>

  <p>The suppression list is not updated when problematic messages
  are manually removed from the mail queue (using the
  "<code>courier cancel</code>" command). Even though the stuck
  messages are deleted, The <i>Courier</i> mail server will
  continue to refuse messages to suppressed addresses, until they
  time out. Use the "<code>courier clear</code>" command to
  manually clear addresses from the suppression list, if so
  desired.</p>

  <blockquote>
    <p><strong>NOTE:</strong> A mailbox that exceeded its storage
    quota results in temporary delivery failures. Therefore, when a
    mailbox fills up, The <i>Courier</i> mail server stops
    accepting any more messages to this mailbox (there might be one
    or two messages already in the mail queue, but that shouldn't
    be a major issue). Mail deliveries will resume when the mailbox
    goes below the quota (although this may take an hour, or two,
    as explained previously). It's possible that an existing
    version of the <i>Courier</i> mail server was originally
    modified to generate a permanent delivery failure for a quota
    exceeded condition. This change should now be undone, in order
    for backscatter suppression to work properly.</p>
  </blockquote>

  <p>The third setting is the <code>DSNTOAUTHADDR=1</code> setting
  in the <em>courierd</em> configuration file. This setting, when
  enabled, alters bounce handling of messages that were received
  from an authenticated SMTP connection.</p>

  <p>Bounces of authenticated messages are processed according to
  the previous two settings, except that the bounce message gets
  sent (if it gets sent at all) to the authenticated login address,
  instead of the message's return address.</p>

  <blockquote>
    <p><strong>NOTE:</strong> This works only if the <i>Courier</i>
    mail server is configured, via the <i>Courier</i> mail server
    Authentication Library, to validate login IDs that consist of a
    full E-mail address, "<code>user@domain</code>", with the login
    ID corresponding to the mailbox's E-mail address.</p>
  </blockquote>

  <p>Enabling this setting removes the possibility of the
  <i>Courier</i> mail server sending abusive backscatter bounces to
  external recipients, from a compromised trusted sender, even if
  the compromised trusted sender uses authenticated SMTP. Instead
  of sending the bounces to the forged return address, they get
  redirected to the sender's mailbox.</p>

  <blockquote>
    <p><strong>NOTE:</strong> The authenticated address is used for
    bounces only. When the message gets sent to its listed
    recipients, the message's return address gets used, as
    usual.</p>
  </blockquote>

  <blockquote>
    <p><strong>NOTE:</strong> Authenticated SMTP must be used for
    this option to have any effect. When relaying privileges are
    granted to explicit IP address ranges (see the preceding
    "<a href="#access">Create smtp access list</a>" section), The
    <i>Courier</i> mail server will not have the sender's
    authenticated login address (unless the sender voluntary
    authenticates).</p>
  </blockquote>

  <h2><a name="misc" id="misc">Miscellaneous configuration</a></h2>

  <p>Review/edit contents of various configuration files in
  <code>/usr/lib/courier/etc</code>:</p>

  <ul>
    <li>
      <code>courierd</code>

      <p>this file controls general aspects of the <i>Courier</i>
      mail server's message processing. A default file is installed
      with comments describing what the various options are. Review
      the default options, and make whatever changes you deem
      appropriate. You will probably need to make changes to this
      configuration file in order to select the correct way to
      deliver local mail (whether to have the <i>Courier</i> mail
      server handle the delivery directly, or whether to run
      procmail or maildrop). There are comments in this file that
      tell you what needs to be done to have the <i>Courier</i>
      mail server use a separate local mail delivery agent, such as
      <code>procmail</code>, for mail delivery. Read and follow the
      instructions there.</p>
    </li>

    <li>
      <code>esmtpd</code>

      <p>this is an important file that controls the <i>Courier</i>
      mail server's ESMTP server. Options in this file include
      setting the maximum limit on simultaneous server connections,
      whether to disable certain optional SMTP features, whether or
      not you have a mail filter module installed, and whether or
      not blacklists are used.</p>
    </li>

    <li>
      <code>esmtpd-msa</code>

      <p>this file controls the <i>Courier</i> mail server's ESMTP
      message submission server (RFC 2476). The settings in this
      file supplement the settings in <code>esmtpd</code>. The
      default startup script first reads <code>esmtpd</code>, then
      <code>esmtpd-msa</code> in order to initialize the ESMTP
      message submission server on port 587.</p>
    </li>

    <li>
      <code>smtpaccess</code>

      <p>this configuration file/directory is used to ban explicit
      IP addresses from connecting to the ESMTP server at all, or
      to specify which IP address ranges are allowed to relay mail
      through the ESMTP server. The default file turns on relaying
      in a couple of reserved IP address ranges, as an example. The
      <code>makesmtpaccess</code> command must be executed for any
      changes to <code>smtpaccess</code> to take effect.</p>
    </li>

    <li>
      <code>pop3d</code>

      <p>this file sets various options for the <i>Courier</i> mail
      server's POP3 server. The <i>Courier</i> mail server's POP3
      server can be used only if mail is stored in Maildirs. You
      will need to use another POP3 server if you choose to deliver
      your mail to legacy mailbox files. A default configuration
      file is installed, describing the available options.</p>
    </li>

    <li>
      <code>imapd</code>

      <p>this file sets various options for the <i>Courier</i> mail
      server's IMAP server. The <i>Courier</i> mail server's IMAP
      server can be used only if mail is stored in Maildirs. You
      will need to use another IMAP server if you choose to deliver
      your mail to legacy mailbox files. A default configuration
      file is installed, describing the available options.</p>
    </li>
  </ul>

  <h4>Qmail compatibility mode.</h4>
  <pre>
<code>echo "qmail" &gt;/usr/lib/courier/etc/dotextension</code>
</pre>

  <p>Run this command if you are installing the <i>Courier</i> mail
  server on a system that's currently running the Qmail mail
  server. The <i>Courier</i> mail server will now read
  <code>.qmail</code> files for delivery instructions, instead of
  <code>.courier</code> files. The <i>Courier</i> mail server's
  <code>.courier</code> files are mostly compatible with Qmail's
  <code>.qmail</code> files, but there are some minor differences.
  Still, most of your <code>.qmail</code> files should work without
  too many problems.</p>

  <h2><a name="locals" id="locals">Define local domains</a></h2>

  <p>The configuration file
  <code>/usr/lib/courier/etc/locals</code> is a list of all the
  domains that are considered local. Mail to any address in any
  local domain is handled as a local delivery. If this file does
  not exist the <i>Courier</i> mail server will use the contents of
  the <code>me</code> configuration file, or it will obtain its
  machine name from the operating system.</p>

  <p>This file contains a list of domains, one per line. In most
  cases you need to initialize this file to contain every hostname
  that has a DNS A, or AAAA, record pointing to any IP address
  assigned to this machine, including "<code>localhost</code>". You
  will also need to include any domain that lists this machine as
  its primary MX relay.</p>

  <p>You may also include domain wildcards in <code>locals</code>
  by prefixing the domain with a period. For example:
  ".example.com" will treat any domain underneath
  <code>example.com</code> - like <code>a.example.com</code>,
  <code>b.example.com</code> - as a local domain. Note that this
  does not include <code>example.com</code> itself, so you may need
  to list it explicitly as well!</p>

  <p><b>NOTE:</b> The <code>makealiases</code> command must be
  entered after making any changes to this file.</p>

  <h2><a name="accept" id="accept">Create a list of domains to
  accept mail for</a></h2>

  <p>If you would like your server to function as a backup mail
  relay for other domains, create
  <code>/usr/lib/courier/etc/esmtpacceptmailfor</code>. This is a
  plain text file, containing a list of domains, one per line. This
  file lists all domains your server will accept mail for. NOTE: if
  you create this file, you MUST include all your local domains.
  Usually you can simply append what you have in
  <code>/usr/lib/courier/etc/locals</code>. If
  <code>/usr/lib/courier/etc/esmtpacceptmailfor</code> does not
  exist, The <i>Courier</i> mail server will accept mail only for
  the machine name listed in <code>/usr/lib/courier/etc/me</code>,
  (or the system machine name).</p>

  <p>Like <code>/usr/lib/courier/etc/locals</code>, prepending a
  period to a domain name in <code>esmtpacceptmailfor</code> will
  cause the <i>Courier</i> mail server to accept mail for all
  subdomains of this domain.</p>

  <h2><a name="uucp" id="uucp">OPTIONAL: Configure UUCP</a></h2>

  <p>The <i>Courier</i> mail server is capable of sending and
  receiving mail via UUCP. The <i>Courier</i> mail server does not
  implement UUCP directly, but instead uses your existing UUCP
  software to send and receive mail.</p>

  <p>The <i>Courier</i> mail server's UUCP functionality has been
  tested with Taylor UUCP 1.06. It's likely that some minor
  tweaking will be necessary to get the <i>Courier</i> mail server
  working with other UUCP builds. Give it a shot, and keep an eye
  out for problems.</p>

  <h3><code>/usr/lib/courier/etc/uucpme</code></h3>This
  configuration file must be initialized to list the UUCP node name
  that this machine is known as. Currently the <i>Courier</i> mail
  server does not support multiple UUCP node aliases for the same
  machine.

  <h3><code>/usr/lib/courier/etc/uucpneighbors</code></h3>This
  configuration file contains a list of all the nodes that your
  machine talks to via UUCP. Obviously this information will be a
  duplicate of the corresponding data in your existing UUCP
  configuration files, and some maintenance will be necessary to
  keep both lists in sync. That is, unfortunately, unavoidable. The
  <code>makeuucpneighbors</code> commands turns this plain text
  file into a database, which is what the <i>Courier</i> mail
  server uses directly. The format of the
  <code>uucpneighbors</code> configuration file is described in the
  <a href="courieruucp.html"><code>makeuucpneighbors(8)</code></a>
  manual page.

  <h3><code>/usr/lib/courier/etc/uuucprewriteheaders</code></h3>The
  <i>Courier</i> mail server automatically rewrites message
  envelope addresses from ESMTP to UUCP format. If this file
  exists, the addresses in the headers of messages sent to/from
  UUCP addresses will also be rewritten.

  <h2>Configure UUCP domain aliases</h2>

  <p>The <i>Courier</i> mail server can accept mail addressed to
  <code>&lt;user@example.com&gt;</code>, and then forward it to
  <code>uucp!bang!path!user</code>, via UUCP. This is done by
  adding a UUCP virtual domain alias to your aliases file, see
  <a href="#aliases">"Create system aliases"</a>. Append the
  following entry to your <code>/etc/aliases</code>, then run the
  <code>makealiases</code> command:</p>
  <pre>
   @example.com: uucp!bang!path!
</pre>

  <p>See the <code><a href=
  "makealiases.html">makealiases(8)</a></code> manual page for more
  information.</p>

  <h2><a name="ldap" id="ldap">OPTIONAL: Configure LDAP
  aliasing</a></h2>

  <p>In addition to using LDAP for authentication and for managing
  accounts, The <i>Courier</i> mail server can use an LDAP
  directory for routing, or "aliasing" mail.</p>

  <p>The term "aliasing" refers to substituting one or more
  addresses for another address. A one-to-one substitution results
  in the <i>Courier</i> mail server accepting mail for one address,
  and delivering the mail to another address. A one-to-many
  substitution results in the <i>Courier</i> mail server accepting
  mail for one address, and delivering a separate copy of the
  message to every address defined by the alias.</p>

  <p>The <i>Courier</i> mail server supports a basic form of
  aliasing using a GDBM or DB-based database. The <a href=
  "makealiases.html"><code>makealiases(8)</code></a> command reads
  a plain text file containing the aliasing rules, the creates a
  GDBM or a DB database. Each recipient address is looked up in the
  database, and if an alias is defined for the recipient address,
  it is used in place of the original address. Aliasing can be used
  against individual addresses, one by one. An extended form of
  aliasing maps an entire domain to a single local address, using
  <a href="dot-courier.html"><code>dot-courier(5)</code></a>
  delivery instruction files.</p>

  <p>The <i>Courier</i> mail server can use an LDAP directory
  instead of a GDBM or a DB database, to perform essentially the
  same function. If OpenLDAP is available at time of installation,
  the installation script installs the <a href=
  "courierldapaliasd.html"><code>courierldapaliasd(8)</code></a>
  program and a <code>ldapaliasrc</code> configuration file. It
  will be necessary to enter appropriate information into
  ldapaliasrc, and arrange to run "<code>courierldapaliasd
  start</code>" at system boot time (it is a background daemon
  process that opens persistent connections to the LDAP
  server).</p>

  <p>Additional instructions for setting up LDAP-based aliasing are
  found in the <a href=
  "courierldapaliasd.html"><code>courierldapaliasd(8)</code></a>
  manual page.</p>

  <h2><a name="filter" id="filter">OPTIONAL: Configure mail
  filtering</a></h2>

  <p>The <i>Courier</i> mail server includes several options for
  selectively filtering mail. In general, The <i>Courier</i> mail
  server provides only the plug-in interfaces by which arbitrary
  external mail filters can be used to selectively accept or reject
  messages. The <i>Courier</i> mail server comes only with some
  sample code that demonstrates how to write a mail filter. An
  actual mail filter must be written and installed separately.
  Please note that running mail filters can have a non-trivial
  impact on mail system performance and throughput.</p>

  <p>The <i>Courier</i> mail server provides two mail filtering
  interfaces:</p>

  <ul>
    <li>Global mail filters

      <p>these filters are installed and will be used to filter
      every incoming message. Global mail filters are permanently
      running daemons that create and listen on a filesystem domain
      socket. Each new message that the <i>Courier</i> mail server
      receives must be acknowledged by every global mail filter.
      Note that if global mail filters are installed, but their
      daemons are not running, The <i>Courier</i> mail server will
      not accept any new messages.</p>
    </li>

    <li>Local mail filter

      <p>this filter can be used when the message is addressed to a
      local recipient - when the <i>Courier</i> mail server itself
      will deliver the message to a physical mailbox. Local mail
      filtering is designed to be primarily used by the
      <code>maildrop</code> mail filter. With the local mail
      filtering installed, individual recipients can create files
      containing mail filtering instructions that can selectively
      accept or reject individual messages.</p>
    </li>
  </ul>

  <p>See <a href=
  "courierfilter.html"><code>courierfilter(8)</code></a> for more
  information on global mail filters.</p>

  <p>See <a href=
  "maildropfilter.html"><code>maildropfilter(7)</code></a> for more
  information on local mail filters.</p>

  <h3>Miscellaneous UUCP configuration</h3>

  <p>The <i>Courier</i> mail server sends UUCP mail by running
  <code>rmail</code> via <code>uux</code>. The configuration script
  searches for the <code>uux</code> command in the default search
  path. If your <code>uux</code> command is not in a directory
  that's in your search path you will have to modify
  <code>PATH</code> before running configure.</p>

  <p>The <i>Courier</i> mail server receives UUCP mail by expecting
  your UUCP software to run the <code>rmail</code> command, which
  is installed in <code>/usr/lib/courier/bin</code>. (It's actually
  a soft link to <code>sendmail</code>, but we'll talk about it
  later). Your UUCP software probably does not run commands from
  this directory by default, so you will have to make the necessary
  adjustments. You can always create another soft link in a
  directory that UUCP searches by default.</p>

  <h2><a name="start" id="start">Starting and stopping the
  <i>Courier</i> mail server</a></h2>

  <p>To start the <i>Courier</i> mail server, run the command
  <code>/usr/lib/courier/sbin/courier start</code>. To stop the
  <i>Courier</i> mail server, run the command
  <code>/usr/lib/courier/sbin/courier stop</code>. See the
  <code>courier(8)</code> manual page for more information.</p>

  <p>You should add these commands to your system startup and
  shutdown scripts.</p>

  <p>Note that this command starts and stops the <i>Courier</i>
  mail server's core processes only. It does not start any
  additional daemon processes that you may need, such as the mail
  filtering daemon, the ESMTP server daemon, the POP3 server
  daemon, or the IMAP server daemon.</p>

  <p>The commands <code>courierfilter start</code>,
  <code>courierfilter stop</code>, <code>esmtpd start</code>,
  <code>esmtpd stop</code>, <code>esmtpd-msa start</code>,
  <code>esmtpd-msa stop</code>, <code>pop3d start</code>,
  <code>pop3d stop</code>, <code>imapd start</code>, and
  <code>imapd stop</code> (all commands are installed in the sbin
  directory) are used to start or stop their respective daemons,
  and they should be added to your system startup and shutdown
  scripts, where required. As described in the relevant manual
  pages, <code>courierfilter</code> should be the first daemon
  process to start, and the last one to terminate. The remaining
  daemons may be started in any order.</p>

  <h2><a name="parallel" id="parallel">Run the <i>Courier</i> mail
  server in parallel to your mail server</a></h2>

  <p>You now have several options for migrating from your existing
  mail server to the <i>Courier</i> mail server:</p>

  <ul>
    <li>Your existing mail server can continue to handle incoming
    mail, by listening on the smtp port. The <i>Courier</i> mail
    server will be used to send all outgoing mail. This is
    accomplished by configuring your mail software to run
    <code>/usr/lib/courier/bin/sendmail</code> to send mail,
    instead of your current sendmail program.</li>

    <li>The <i>Courier</i> mail server can handle incoming mail by
    listening on the smtp port, and your existing mail server can
    continue to handle all outgoing mail. You will need to stop
    your existing mail server from listening on the smtp port, and
    run the following command:
      <pre>
/usr/lib/courier/sbin/esmtpd start
</pre>

      <p>from your system start up script. You should also add
      <code>/usr/lib/courier/sbin/esmtpd stop</code> to your system
      shutdown script. Note that there's a separate script that
      starts the ESMTP submission server on port 587 -
      <code>/usr/lib/courier/sbin/esmtpd-msa</code>, that is used
      in an analogous fashion.</p>
    </li>
  </ul>

  <h2><a name="esmtpauth" id="esmtpauth">OPTIONAL: Configure ESMTP
  authentication and SSL</a></h2>

  <p>The <i>Courier</i> mail server supports authenticated ESMTP in
  order to grant ESMTP relaying privileges to remote users. The
  following steps set up authenticated ESMTP:</p>

  <ul>
    <li>Edit <code>/usr/lib/courier/etc/esmtpd</code> and
    initialize the <code>ESMTPAUTH</code> configuration setting.
    The configuration file
    <code>/usr/lib/courier/etc/esmtpd-msa</code> is used for the
    ESMTP submission server on port 587. Setting this variable in
    <code>esmtpd</code> is sufficient, because
    <code>esmtpd-msa</code> merely supplements the settings in
    <code>esmtpd</code>. Explicitly initialize this setting in
    <code>esmtpd-msa</code> only if you wish to apply it to port
    587 only.

      <p><code>ESMTPAUTH</code> is a list of SASL authentication
      methods to use use. Currently, The <i>Courier</i> mail server
      supports <code>LOGIN</code>, <code>PLAIN</code>,
      <code>CRAM-SHA1</code> and <code>CRAM-MD5</code>. The list of
      authentication methods is sometimes influenced by the
      installed authentication modules in the <i>Courier</i> mail
      server Authentication Library. Not all authentication modules
      implement <code>CRAM-MD5/SHA1</code>. The authentication
      modules that support CRAM-MD5/SHA1 authentication are:
      <code>authuserdb</code>, <code>authldap</code>,
      <code>authmysql</code>, and <code>authpgsql</code>.</p>
    </li>

    <li>Your authentication modules may require additional
    configuration, you will have to take care of that too. For
    example, <code>authpam</code> - the PAM authentication module -
    requires that you also configure your PAM library. In this
    case, you need to configure your PAM library to support the
    "esmtp" service. The PAM library configuration details depend
    on your particular operating system, and are beyond the scope
    of this document. Consult the documentation for your PAM
    library for more information.</li>

    <li>Restart the <i>Courier</i> mail server.</li>
  </ul>

  <h3>ESMTP over TLS/SSL</h3>

  <p>The <i>Courier</i> mail server also supports ESMTP over
  TLS/SSL, by using the ESMTP STARTTLS extension:</p>

  <ul>
    <li>
      <p>To add SSL support you have to install OpenSSL or GnuTLS
      before installing the <i>Courier</i> mail server. Download
      OpenSSL from <a target="_blank" href=
      "http://www.openssl.org/"><code>http://www.openssl.org/</code></a>,
      or GnuTLS from <a target="_blank" href=
      "http://www.gnutls.org"><code>http://www.gnutls.org</code></a>.</p>

      <p>OpenSSL's support is well-tested, the GnuTLS version is a
      relatively new addition, and is considered experimental.
      Follow OpenSSL's or GnuTLS's installation instructions, then
      build the <i>Courier</i> mail server.</p>

      <blockquote>
        <p><b>NOTE:</b> Most systems already have an available
        OpenSSL or GnuTLS package. Do not build OpenSSL or GnuTLS
        yourself, if a prebuilt package is already available. Just
        install the prebuilt package.</p>
      </blockquote>

      <blockquote>
        <p><b>NOTE:</b> The development libraries must be installed
        in addition to the runtime package, in order to build the
        <i>Courier</i> mail server. On most systems, the
        development files (header files, libraries, etc...) are
        provided in a separate "devel" package. The base
        OpenSSL/GnuTLS package is not sufficient to build the
        <i>Courier</i> mail server, the development libraries must
        be installed.</p>
      </blockquote>

      <p>The OpenSSL library is selected when both OpenSSL and
      GnuTLS libraries are found by the <code>configure</code>
      script. Use the <code>--with-gnutls</code> option to
      explicitly select GnuTLS library over OpenSSL.</p>
    </li>

    <li>STARTTLS is enabled simply by installing an X.509
    certificate as <code>/usr/lib/courier/share/esmtpd.pem</code>.
    If this file exists, the STARTTLS ESMTP extension will be
    automatically advertised. This file must be owned by the userid
    the <i>Courier</i> mail server is installed as, and MUST NOT be
    world readable!</li>

    <li>Note that SSL requires a signed X.509 certificate. You can
    generate your own self-signed certificates with <i>OpenSSL</i>,
    but mail clients will display a warning message the first time
    they connect to the server. To prevent the warning message, you
    will need to pay money to have your certificate signed by a
    certificate authority. The gory details of setting up SSL is
    beyond the scope of this document, and you should consult the
    OpenSSL documentation for more information.</li>

    <li>The certificate must be installed as
    <code>/usr/lib/courier/share/esmtpd.pem</code>. This file
    <b>MUST NOT HAVE</b> any group or world permissions! It must be
    owned by the <i>Courier</i> mail server userid (the userid used
    to install the <i>Courier</i> mail server, usually
    <code>courier</code> or <code>daemon</code>).</li>

    <li>In times of extreme desperation the script
    <code>/usr/lib/courier/sbin/mkesmtpdcert</code> can be used to
    generate <code>/usr/lib/courier/share/esmtpd.pem</code>. This
    script will silently terminate if OpenSSL is not installed, or
    if the esmtpd.pem certificate file already exists (so it will
    not be overwritten). This makes it easier to have this script
    invoked from a package install script.</li>

    <li>Restart the <i>Courier</i> mail server's ESMTP server after
    installing the X.509 certificate.</li>
  </ul>

  <p>The <i>Courier</i> mail server will also use TLS/SSL when
  sending ESMTP mail, automatically. If the remote mail server
  support STARTTLS, The <i>Courier</i> mail server will use it
  automatically.</p>

  <p>SSL/TLS settings for the ESMTP client can be adjusted in the
  <code>/usr/lib/courier/etc/courierd</code> configuration file.
  When sending mail using SSL, The <i>Courier</i> mail server can
  optionally verify the remote server's X.509 certificate. This is
  done by setting <code>ESMTP_TLS_VERIFY_DOMAIN</code> to
  <code>1</code>, in <code>/usr/lib/courier/etc/courierd</code>.
  Also, <code>TLS_PEERCERTDIR</code> must be set to a directory
  that contains PEM files of X.509 certificates of trusted root
  certificate authorities. The PEM files must be hashed by
  OpenSSL's <code>c_rehash</code> script. When this is done, the
  remote server's X.509 certificate must signed by trusted root CA,
  else the <i>Courier</i> mail server will bounce the
  recipient.</p>

  <p>Starting with version 0.34, The <i>Courier</i> mail server
  installs a default set of trusted public certificate authorities,
  and the default configuration will require the remote server to
  present an X.509 certificate that's signed by any trusted
  certificate authority. To disable certificate validation, set
  ESMTP_TLS_VERIFY_DOMAIN to 0 in
  <code>/usr/lib/courier/etc/courierd</code>. Alternatively, custom
  certificates may be installed instead. The TLS_TRUSTCERTS setting
  in <code>/usr/lib/courier/etc/courierd</code> specifies the
  location of trusted certificate authorities.</p>

  <h2><a name="esmtpsecurity" id="esmtpsecurity">OPTIONAL:
  Configure the SECURITY ESMTP extension</a></h2>

  <p>The <i>Courier</i> mail server includes an experimental
  extension to ESMTP that can be used to set up secure E-mail
  delivery between trusted mail relays over an untrusted network.
  This is implemented by an experimental ESMTP extension in the
  <i>Courier</i> mail server. Therefore, at present time both the
  sending and the receiving mail relay must be running the
  <i>Courier</i> mail server that's configured to support this
  extension. The specification for this ESMTP extension is <a href=
  "draft-varshavchik-security-smtpext.txt">publicly available</a>.
  This is a very small extension of the existing, draft-standard
  <a target="_blank" href=
  "http://www.rfc-editor.org/rfc/rfc2487.txt">STARTTLS</a> ESMTP
  extension. The SECURITY extension should only require minor
  changes to existing mail servers and clients that already
  implement STARTTLS.</p>

  <h3>Overview</h3>

  <p>The first necessary step is to read the formal definition of
  the SECURITY extension, which can be found on <a target="_blank"
  href="http://www.courier-mta.org">http://www.courier-mta.org</a>.
  Although the following instructions do not use any information
  directly from this document, it is important to understandi how
  this mechanism works. This will be very useful in
  troubleshooting. This is not called an "experimental" extension
  just for the hell of it.</p>

  <p>The SECURITY extension builds on top of several existing,
  proven, technologies in order to deliver mail with the highest
  level of security that can possibly be implemented using the
  existing technology. The several steps in implementing the
  SECURITY extension:</p>

  <ol>
    <li>Install and configure the STARTTLS ESMTP extension. This
    extension uses TLS/SSL encryption for sending mail.</li>

    <li>Create a private, controlled, X.509 Certificate
    Authority.</li>

    <li>Use the private CA to sign X.509 certificates of all mail
    nodes in the trusted mail network. This CA's certificate is
    also installed in every trusted mail node.</li>
  </ol>

  <p>The SECURITY extension is an optional tag that's attached to
  an E-mail message. The <i>Courier</i> mail server requires
  STARTTLS to forward SECURITY-tagged messages, and the receiving
  mail nodes must present an X.509 certificate, signed by the
  private Certificate Authority, before the <i>Courier</i> mail
  server will send the message. The <i>Courier</i> mail server will
  refuse to send the message to a mail node that does not support
  STARTTLS, or doesn't present a suitable X.509 certificate.</p>

  <p>Therefore, in an ideal world, mail clients will simply tag
  messages with the SECURITY extension. Obviously, this means that
  mail clients must be updated to implement this feature. Until
  this happens, The <i>Courier</i> mail server will provide a
  workaround that automatically tags all messages for selected
  domains with the SECURITY extension. This is not a perfect
  solution, and it has some minor limitations, which will be
  mentioned later.</p>

  <h3>Install and configure the STARTTLS ESMTP extension</h3>The
  first step is to implement ESMTP STARTTLS. Use the instructions
  elsewhere in this document to activate ESMTP STARTTLS support.
  The following instructions use the scripts from OpenSSL 0.9.6,
  but should also work with OpenSSL 0.9.5a.

  <h3>Create a private X.509 Certificate Authority</h3>

  <p>Create an empty subdirectory:</p>
  <pre>
    mkdir /etc/myca
    cd /etc/myca
</pre>

  <p>There's a convenient OpenSSL script called <code>CA.pl</code>
  that you want to copy to the current directory:</p>
  <pre>
    cp /usr/share/ssl/misc/CA.pl .
</pre>

  <p>Your OpenSSL package may have <code>CA.pl</code> installed
  someplace else. Find it, and copy it to <code>/etc/myca</code>.
  The <code>CA.pl</code> needs to be slightly modified before it
  can be used. Find the following commands in <code>CA.pl</code>,
  and change them as follows:</p>

  <p>Replace:</p>
  <pre>
      system ("$REQ -new -keyout newreq.pem -out newreq.pem $DAYS");
</pre>

  <p>replace with:</p>
  <pre>
      system ("$REQ -new -nodes -keyout newreq.pem -out newreq.pem $DAYS");
</pre>

  <p>Also replace:</p>
  <pre>
      system ("$REQ -new -x509 -keyout " .
          "${CATOP}/private/$CAKEY -out ${CATOP}/$CACERT $DAYS");
</pre>

  <p>replace with:</p>
  <pre>
      system ("$REQ -new -nodes -x509 -keyout " .
          "${CATOP}/private/$CAKEY -out ${CATOP}/$CACERT $DAYS");
</pre>

  <p>The <code>CA.pl</code> script creates password-protected
  certificate keys by default. Password protected certificates
  currently do not work with the <i>Courier</i> mail server. Adding
  the <code>-nodes</code> parameter turns off password protection.
  This means that it is vital to make sure that the trusted mail
  relays are properly secured. All the encryption in the world will
  not be of much use if the mail relays are running a rootable FTP
  server (for example). Anyway, run <code>CA.pl</code> to create a
  new certificate authority:</p>
  <pre>
    ./CA.pl -newca
</pre>

  <p><code>CA.pl</code> prompts for a basic description of the new
  CA, then creates the certificate and the certificate key. The
  CA's root certificate is saved in
  <code>/etc/myca/demoCA/cacert.pem</code>.</p>

  <h3>Use the private CA to sign X.509 certificates of all trusted
  mail nodes</h3>

  <p>This step must be performed to create the X.509 certificates
  for every mail node in the trusted secure network. First, a
  certificate request is created:</p>
  <pre>
    ./CA.pl -newreq
</pre>

  <p><code>CA.pl</code> prompts for a basic description of the new
  certificate. Special care must be paid to the "commonName"
  setting. "commonName" MUST be set to the hostname of the trusted
  mail node, NOT its mail domain. For example, given the following
  DNS setup for <code>example.com</code>:</p>
  <pre>
     example.com.  MX 10 mx1.example.com.
     example.com.  MX 20 mx2.example.com.

     mx1.example.com. A 192.68.0.1
     mx2.example.com. A 192.68.1.1
</pre>

  <p>This domain will need two certificates, one with "commonName"
  set to "mx1.example.com", and one with "commonName" set to
  mx2.example.com.</p>

  <p>Running <code>./CA.pl</code> produces a certificate request in
  the file <code>newreq.pem</code>. Run the following command to
  sign it:</p>
  <pre>
    ./CA.pl -signreq
</pre>

  <p>This step creates the file <code>newcert.pem</code> that
  contains a new signed certificate. The private key from the
  original certificate request must be appended to this file,
  before the certificate can be used. Simply take the
  <code>newreq.pem</code> file from the previous step, and append
  the private key in that file to <code>newcert.pem</code>. The
  resulting certificate file should look something like this:</p>
  <pre>
   [ description of the certificate ]

-----BEGIN CERTIFICATE-----

   [ binary goo ]

-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----

   [ binary goo ]

-----END RSA PRIVATE KEY-----
</pre>

  <p>The OpenSSL documentation contains instructions on how to
  perform the equivalent procedure with Diffie-Hellman instead of
  RSA.</p>

  <h3>Configure trusted mail nodes</h3>

  <p>Two files must be installed on every trusted mail node.</p>

  <ul>
    <li>The mail node's certificate, the <code>newcert.pem</code>
    file from the previous step. The following documentation
    assumes that this file is installed as
    <code>/etc/mycert.pem</code>. This mail node will use this
    certificate to authenticate itself to other trusted mail
    nodes.</li>

    <li>The certificate authority file, <code>cacert.pem</code>.
    The following documentation assumes that it's installed as
    <code>/etc/cacert.pem</code>. The CA's certificate is used to
    authenticate other trusted mail nodes.</li>
  </ul>

  <p>Edit the <code>/usr/lib/courier/etc/esmtpd</code>
  configuration file. Set <code>TLS_CERTFILE</code> to
  <code>/etc/mycert.pem</code>. The <i>Courier</i> mail server will
  use <code>TLS_CERTFILE</code> to authenticate itself to other
  trusted mail nodes.</p>

  <p>Edit the <code>/usr/lib/courier/etc/courierd</code>
  configuration file. Set <code>TLS_TRUSTSECURITYCERTS</code> to
  <code>/etc/cacert.pem</code>. The <i>Courier</i> mail server will
  not send ESMTP mail tagged with the SECURITY extension to other
  mail relays unless they produce a certificate that's signed by
  <code>TLS_TRUSTSECURITYCERTS</code>.</p>

  <h3>Testing</h3>

  <p>The following simple steps can be carried out to verify that
  everything is working correctly. These examples use two mail
  nodes called <code>send.example.com</code> and
  <code>receive.example.com</code>. The test messages are sent from
  <code>send.example.com</code>, and are addressed to
  <code>receive.example.com</code>. The <i>Courier</i> mail server
  must be restarted on both <code>send</code> and
  <code>receive</code>, after reconfiguring the machines for each
  test. It is not strictly necessary to do this every time,
  actually, but it's simply easier to do make it a part of the
  routine. It is necessary to restart both the main the
  <i>Courier</i> mail server daemon processes as well as the
  separate ESMTP daemon process (on <code>receive</code>):</p>
  <pre>
    courier stop
    courier start
    esmtpd stop
    esmtpd start
</pre>

  <ol>
    <li>Temporary get rid of
    <code>/usr/lib/courier/bin/couriertls</code> wrapper on
    <code>receive.example.com</code>. Rename it to
    <code>couriertls.save</code>. <code>STARTTLS</code> is
    automatically disabled if <code>couriertls</code> is
    missing,</li>

    <li>Run the following command on <code>send.example.com</code>:
      <pre>
    echo "To: postmaster" | /usr/lib/courier/bin/sendmail \
              -S STARTTLS postmaster@receive.example.com
</pre>

      <p>This message should bounce back since <code>receive</code>
      has STARTTLS disabled.</p>
    </li>

    <li>Restore <code>couriertls</code> on
    <code>receive.example.com</code>, but then rename it on
    <code>send.example.com</code>. The situation is now reversed,
    and the test message should still bounce.</li>

    <li>Restore <code>couriertls</code> on
    <code>send.example.com</code>. Edit <code>receive</code>'s
    <code>/usr/lib/courier/etc/esmtpd</code> file. Comment out the
    current <code>TLS_CERTFILE</code> setting (which points to the
    private CA certificate). Reset <code>TLS_CERTFILE</code> to
    <code>/usr/lib/courier/share/esmtpd.pem</code>, which is the
    self-signed test certificate created by the
    <code>mkesmtpdcert</code> script, when STARTTLS support in the
    <i>Courier</i> mail server was first set up.

      <p>Send a test message <b>WITHOUT</b> the "-S STARTTLS"
      option. This message should go through, assuming all the
      other setting in all configuration files are the initial
      defaults. The regular ESMTP STARTTLS extension, without
      authentication, will be used the deliver this message. Verify
      this by checking the headers in the received message on
      <code>receive.example.com</code>.</p>

      <p>Send a test message <b>WITH</b> the "-S STARTTLS" option.
      It should bounce, even though
      <code>receive.example.com</code> supports STARTTLS. That's
      because it is using an X.509 certificate that's not signed by
      the private CA authority.</p>
    </li>

    <li>Restore <code>TLS_CERTFILE</code> on <code>receive</code>,
    and send a test message with the <code>-S STARTTLS</code>
    option, which should now go through.</li>
  </ol>

  <h3>Force SECURITY for selected domains</h3>

  <p>As demonstrated by the test messages, messages must be tagged
  with the <code>SECURITY</code> extension in order for them to be
  securely transmitted. This must be done by the sending mail
  client. Until mail clients support <code>SECURITY</code> The
  <i>Courier</i> mail server can automatically add the
  <code>SECURITY</code> tag to every message addressed to a domain.
  This is done by entering the domain in the
  <code>esmtproutes</code> configuration file using the following
  syntax:</p>
  <pre>
receive.example.com:  /SECURITY=STARTTLS
</pre>

  <p>Repeat the tests in the previous section, but this time add
  and delete this entry in
  <code>/usr/lib/courier/etc/esmtproutes</code> instead of using
  the <code>-S STARTTLS</code> option. The test messages must still
  bounce or not bounce in the same way.</p>

  <p>Consult the <a href="courier.html"><code>courier(8)</code></a>
  manual page for more information on the <code>esmtproutes</code>
  configuration file.</p>

  <h3>Limitations</h3>

  <p>This setup makes it virtually impossible to intercept mail
  traffic between trusted mail nodes. Even if the DNS cache is
  poisoned to intercept mail to a hostile mail node, mail will not
  go through since the attacker will not have a signed X.509 cert.
  However, all is lost if the mail nodes themselves are compromised
  directly. After securing the compromised node, everything must be
  rebuilt. A new CA must be created, and all mail nodes must now
  receive new certificates. Once support for certificate revocation
  lists is improved, this situation will get somewhat better.</p>

  <p>Another possible way to mitigate that possibility is to use a
  different certificate authority for every trusted mail node.
  <code>TLS_TRUSTSECURITYCERTS</code> can point to a directory,
  instead of a file. This directory can contain multiple
  certificate authorities (hashed by OpenSSL's
  <code>c_rehash</code> script). Then, only the compromised mail
  node's authority certificate needs to be tossed out, regenerated,
  and redistributed.</p>

  <p>TODO: it may be possible to avoid generating individual
  certificates, and distribute self-signed certificate authority
  certs only, with a properly-initialized commonName field. This
  needs to be researched.</p>

  <p>There are some minor differences between using <code>-S
  STARTTLS</code> versus putting the domain into
  <code>esmtproutes</code>. If the <i>sending</i> mail node forward
  mail to this domain via UUCP, <code>-S STARTTLS</code> will
  bounce. Since <code>esmtproutes</code> does not apply to UUCP,
  putting this domain in <code>esmtproutes</code> will have no
  effect whatsoever.</p>

  <h2><a name="spf" id="spf">OPTIONAL: Configure the Sender Policy
  Framework</a></h2>

  <p>The <i>Courier</i> mail server can optionally check the return
  address on all SMTP mail for the sender's published Sender Policy
  Framework (SPF). Keep in mind SPF is an experimental protocol
  that's still maturing. The <i>Courier</i> mail server's SPF
  configuration is set up in the "bofh" configuration file, and is
  fully explained in the <a href="courier.html">courier(8)</a>
  manual page.</p>

  <h2><a name="imap" id="imap">OPTIONAL: Configure the IMAP
  server</a></h2>

  <p>The <i>Courier</i> mail server includes an integrated IMAP
  server. The following steps set it up:</p>

  <ul>
    <li>Edit <code>/usr/lib/courier/etc/imapd</code>. If you want
    to use IMAP SASL authentication, set up the
    <code>IMAP_CAPABILITY</code> variable. It performs the
    equivalent function as the <code>ESMTPAUTH</code> variable in
    the <code>esmtpd</code> configuration file, except that
    <code>IMAP_CAPABILITY</code> also sets several other IMAP
    capabilities that are advertised to IMAP clients. Also, for
    IMAP, CRAM-MD5/SHA1 authentication has been tested, and is
    known to work, so it is listed as a default. Also, note than if
    the <code>authpam</code> authentication module is used, you
    will need to configure the "imap" PAM service. Other
    authentication modules have their own requirements too.</li>

    <li>Uninstall any existing IMAP server that you have, remove
    the entry for the IMAP port in <code>/etc/inetd.conf</code>,
    and restart the <code>inetd</code> daemon.</li>

    <li>Add the following command to your system startup script
      <pre>
/usr/lib/courier/sbin/imapd start
</pre>

      <p>Of course, add <code>/usr/lib/courier/sbin/imapd
      stop</code> to your shutdown script too.</p>
    </li>
  </ul>

  <p>NOTE: if you have previously installed the stand-alone version
  of the <i>Courier</i> IMAP server, you will need to remove it
  prior to using the directly integrated version. They use the same
  base source code, but have a slightly different
  configuration.</p>

  <p>NOTE: this IMAP server supports maildirs only. It does not
  support mbox file mailboxes.</p>

  <h2><a name="imapsh" id="imapsh">Configure IMAP shared
  folders</a></h2>

  <p>It is possible to share folders between different mailboxes,
  via IMAP. See the file
  <code>maildir/README.sharedfolders.(txt|html)</code> for more
  information.</p>

  <h2><a name="imapssl" id="imapssl">OPTIONAL: Configure IMAP over
  SSL</a></h2>

  <p>To add SSL support you have to install OpenSSL or GnuTLS
  before installing the <i>Courier</i> mail server. Download
  OpenSSL from <a target="_blank" href=
  "http://www.openssl.org/"><code>http://www.openssl.org/</code></a>,
  or GnuTLS from <a target="_blank" href=
  "http://www.gnutls.org"><code>http://www.gnutls.org</code></a>.</p>

  <p>OpenSSL's support is well-tested, the GnuTLS version is a
  relatively new addition, and is considered experimental. Follow
  OpenSSL's or GnuTLS's installation instructions, then build the
  <i>Courier</i> mail server.</p>

  <blockquote>
    <p><b>NOTE:</b> Most systems already have an available OpenSSL
    or GnuTLS package. Do not build OpenSSL or GnuTLS yourself, if
    a prebuilt package is already available. Just install the
    prebuilt package.</p>
  </blockquote>

  <blockquote>
    <p><b>NOTE:</b> The development libraries must be installed in
    addition to the runtime package, in order to build the
    <i>Courier</i> mail server. On most systems, the development
    files (header files, libraries, etc...) are provided in a
    separate "devel" package. The base OpenSSL/GnuTLS package is
    not sufficient to build the <i>Courier</i> mail server, the
    development libraries must be installed.</p>
  </blockquote>

  <p>The OpenSSL library is selected when both OpenSSL and GnuTLS
  libraries are found by the <code>configure</code> script. Use the
  <code>--with-gnutls</code> option to explicitly select GnuTLS
  library over OpenSSL.</p>

  <p>The <code>/usr/lib/courier/etc/imapd-ssl</code> configuration
  file sets some additional options for SSL support, which you may
  need to adjust. Consult that configuration file for additional
  information. Then, you also have to run the
  <code>/usr/lib/courier/sbin/imapd-ssl</code> script from your
  system startup and shutdown scripts, just like the
  <code>/usr/lib/courier/sbin/imapd</code> script. You may accept
  both SSL and non-SSL connections by running both scripts.</p>

  <p>Note that SSL requires a valid, signed, X.509 certificate to
  be installed where the <i>Courier</i> mail server expects to find
  it. The default location for the X.509 certificate, in PEM
  format, is <code>/usr/lib/courier/share/imapd.pem</code>. The
  X.509 certificate must be signed by a certificate authority that
  is known to the IMAP client. You can generate your own
  self-signed certificate by running the script
  <code>/usr/lib/courier/share/mkimapdcert</code> which will work
  too, except that IMAP clients using SSL will display a warning
  message the first time they connect to the server. To get rid of
  the warning message you'll have to pay for a signed X.509
  certificate. The gory details of setting up SSL is beyond the
  scope of this document, and you should consult the OpenSSL
  documentation for more information.</p>

  <p>The <code>mkimapdcert</code> script will not overwrite an
  existing <code>imapd.pem</code> certificate, in order to allow
  precompiled packages to simply call <code>mkimapdcert</code>
  after installation, without worry.</p>

  <p>The IMAP server also supports the IMAP STARTTLS extension as
  an alternative or a complement to IMAP over SSL. The
  <code>/usr/lib/courier/etc/imapd-ssl</code> configuration file is
  also used to enable or disable IMAP STARTTLS, which has all the
  same requirements and prerequisites as IMAP over SSL.</p>

  <h2><a name="imapsend" id="imapsend">OPTIONAL: Sending mail via
  an imap connection</a></h2>

  <p>This server allows using the IMAP connection to send E-mail.
  Normally, the IMAP protocol provides only access to mail in an
  existing mail account, and mail clients must use SMTP in order to
  send mail. The <i>Courier</i> IMAP server has an optional setting
  to enable mail to be send via an IMAP connection in a manner that
  should work with all existing IMAP mail clients. This can be
  useful when an account is logged in from a shared access pool
  which normally blocks most access to the SMTP port.</p>

  <p>This is implemented by enabling a setting in the
  <code>imapd</code> configuration file that designates a folder as
  a special "Outbox" folder. The default setting is a folder called
  "Outbox" (IMAP path INBOX.Outbox), but the name can be changed to
  anything. This folder, for the most part, is no different than
  any other folder. If a folder by that name doesn't exist, it
  needs to be created, just like any other IMAP folder. It looks
  and acts like any other folder, except that each message added to
  the folder, via IMAP's APPEND or COPY command, will also be
  mailed out by the <i>Courier</i> IMAP server to the addresses
  listed in the <code>To:</code>, <code>Cc:</code>, and
  <code>Bcc:</code> headers.</p>

  <p>It should be possible to use this to send mail from any IMAP
  client by:</p>

  <ol>
    <li>Composing a draft message, telling the IMAP client to save
    the draft message in its drafts folder on the IMAP server.</li>

    <li>Opening the drafts folder, and moving or copying the
    message to the Outbox folder.</li>

    <li>The act of copying the message into the Outbox folder will
    send the mail. There won't be any explicit notification to the
    fact that the message was sent, so it's a good idea to include
    your own E-mail address on the Cc: list.</li>
  </ol>

  <blockquote>
    <p><b>NOTE:</b> it is tempting to configure the IMAP mail
    client to use Outbox as its default folder for saving drafts.
    Resist the temptation. If you forget, you'll save a partially
    completed draft, which will be then obediently mailed out.</p>
  </blockquote>

  <blockquote>
    <p><b>NOTE:</b> the message, in addition to being sent, will be
    saved in the folder in the normal fashion. After saving the
    message, reopen the Outbox folder and delete the sent message,
    or move it someplace else.</p>
  </blockquote>

  <blockquote>
    <p><b>NOTE:</b> when enabled, the <i>Courier</i> IMAP server
    will advertize a private <code>XCOURIEROUTBOX</code> IMAP
    capability. It is theoretically possible to code an IMAP mail
    client that reads this capability and automatically configures
    itself accordingly -- when this IMAP capability is present --
    to send E-mail in the normal way but using the IMAP connection.
    At this time, I'm not aware of any actual mail clients that
    know how to do this.</p>
  </blockquote>

  <blockquote>
    <p><b>NOTE:</b> many mail clients save some additional internal
    information in headers of draft messages. The internal
    information is normally removed before the mail client sends
    the message. Make sure that none of this extra information is
    something that should not be mailed out.</p>
  </blockquote>

  <h2><a name="idle" id="idle">OPTIONAL: Configure IMAP realtime
  folder status updates</a></h2>

  <p>If <a target="_blank" href=
  "http://oss.sgi.com/projects/fam/">FAM, the File Alteration
  Monitor</a> (<tt>http://oss.sgi.com/projects/fam/</tt>) or
  <a href="http://www.gnome.org/~veillard/gamin/" target=
  "_blank">Gamin</a> is installed, it will be possible to allow
  multiple clients to open the same folder, and have all clients to
  be simultaneously notified of any changes to the folder
  contents.</p>

  <p>After installing the server see the <tt>imapd(8)</tt> manual
  page for more information.</p>

  <h2><a name="smap" id="smap">OPTIONAL: Configure SMAP</a></h2>

  <p>Starting with the <i>Courier</i> mail server 0.43, the IMAP
  server supports an experimental mail access protocol, dubbed
  "Simple Mail Access Protocol". SMAP is an experiment to provide
  enhanced mail processing beyond what's currently possible with
  IMAP. SMAP's purpose is to prototype and develop advanced mail
  access functionality that's not possible with IMAP. SMAP is
  disabled by default. Uncomment the <code>SMAP_CAPABILITY</code>
  setting in the <code>imapd</code> configuration file in order to
  enable SMAP. The <a target="_blank" href=
  "http://www.courier-mta.org/cone/index.html">Cone</a> mail client
  supports SMAP.</p>

  <h2><a name="pop3" id="pop3">OPTIONAL: Configure the POP3
  server</a></h2>

  <p>The <i>Courier</i> mail server includes an integrated POP3
  server. The following steps will set it up:</p>

  <ul>
    <li>Edit <code>/usr/lib/courier/etc/pop3d</code>. Very few POP3
    clients support POP3 SASL authentication, but if you want to
    use it, for some reason, uncomment the <code>POP3AUTH</code>
    variable. It performs the equivalent function as the
    corresponding variable in the <code>esmtpd</code> and
    <code>imapd</code> configuration files. For POP3, SASL LOGIN
    authentication has been tested, and is known to work, and
    CRAM-MD5/SHA1 has not been tested. Also, note than if
    <code>authpam</code> is used, you will need to configure the
    "pop3" PAM service. Other authentication modules have their own
    requirements.</li>

    <li>Uninstall any existing POP3 server that you have, remove
    the entry for the POP3 port in <code>/etc/inetd.conf</code>,
    and restart the <code>inetd</code> daemon.</li>

    <li>Add the following command to your system startup script:
      <pre>
/usr/lib/courier/sbin/pop3d start
</pre>

      <p>Of course, add <code>/usr/lib/courier/sbin/pop3d
      stop</code> to your shutdown script too.</p>
    </li>
  </ul>

  <p>NOTE: this POP3 server supports maildirs only. It does not
  support mbox file mailboxes.</p>

  <h2><a name="pop3ssl" id="pop3ssl">OPTIONAL: Configure POP3 over
  SSL</a></h2>

  <p>Implementing POP3 over SSL is very similar to implementing
  IMAP over SSL. The only differences are that the startup/shutdown
  command is "<code>/usr/lib/courier/sbin/pop3d start</code>" and
  "<code>/usr/lib/courier/sbin/pop3d stop</code>", the
  configuration file is <code>/usr/lib/courier/etc/pop3d</code>,
  the name of the required SSL certificate is
  <code>/usr/lib/courier/share/pop3d.pem</code>, and the command to
  generate a test SSL certificate is <code>mkpop3dcert</code>.</p>

  <h2><a name="proxy" id="proxy">OPTIONAL: Configure the IMAP/POP3
  aggregator proxy</a></h2>

  <p>It is possible to distribute IMAP and POP3 mailboxes between
  multiple server.</p>

  <p>See <code>imap/README.proxy</code> for more information.</p>

  <h2><a name="sslcert" id="sslcert">CERTIFICATE
  AUTHENTICATION</a></h2>

  <p>The <i>Courier</i> mail server can use SSL certificates for
  authentication purposes. That is, instead of using a login ID and
  a password, for accessing the mailbox, The <i>Courier</i> mail
  server uses a client-side SSL certificate. For certificate
  authentication purposes, one of the fields in your certificates'
  subject must match the login ID in the authentication database.
  Consider the following certificate:</p>

  <blockquote>
    <pre>
...
Subject: C=US,ST=New York,L=New York,O=Acme Widgets Inc,CN=John Smith,emailAddress=johnsmith@example.com
</pre>
  </blockquote>

  <p>If the <code>emailAddress</code> field is configured as the
  login ID, the authentication database must provide login details
  for <code>johnsmith@example.com</code>. To enable certificate
  authentication, edit the following configuration files in
  <i>sysconfdir</i>: <code>imapd-ssl</code>,
  <code>pop3d-ssl</code>, <code>esmtpd</code> and
  <code>esmtpd-ssl</code> (the <code>esmtpd</code> files enable SSL
  certificate authentication for incoming <code>SMTP</code>
  connections, if a good SSL certificate is provided, the client
  receives mail relaying privileges). All of these configuration
  files require the same set of changes:</p>

  <ul>
    <li>
      <p>Set <code>TLS_TRUSTCERTS</code> to the filename with your
      certificate authority's X.509 certificate.</p>
    </li>

    <li>
      <p>Change the <code>TLS_VERIFYPEER</code> setting to
      "<code>PEER</code>". The setting can also be changed to
      "<code>REQUIREPEER</code>" to require all SSL/TLS connections
      to provide a certificate. Otherwise, it is optional. If the
      mail client provides an SSL certificate, it may be used to
      authenticate. Without a certificate, password-based
      authentication remains an option.</p>
    </li>

    <li>
      <p>Change the <code>TLS_EXTERNAL</code> setting to the name
      of the certificate subject field that gives the login ID. In
      the above example, this would be
      "<code>TLS_EXTERNAL=emailaddress</code>".</p>

      <blockquote>
        <p>NOTE: GnuTLS's <code>certtool</code> uses
        "<code>email</code>" as the name of this field. If the
        <i>Courier</i> mail server is compiled with GnuTLS, you
        should still specify this field as
        "<code>emailaddress</code>".</p>
      </blockquote>
    </li>
  </ul>

  <h2><a name="webmail" id="webmail">OPTIONAL: Configure the
  webmail server</a></h2>

  <p>The integrated webmail server is made up of two parts. The
  first part, by default, is installed as
  <code>/usr/lib/courier/libexec/courier/webmail</code>. You can
  simply copy this binary executable to your web server's
  <code>cgi-bin</code> directory, or create a link from the cgi-bin
  directory to this program. This is a small stub program that
  connects, via a local socket, to the <code>sqwebmaild</code>
  daemon process, which implements the webmail service. It is
  necessary to start the webmail server by adding the following
  command to the system startup screen (so that the webmail server
  gets automatically started at boot):</p>

  <p><code>/usr/lib/courier/sbin/webmaild start</code></p>

  <p>(It is also possible to run "<code>webmaild stop</code>" from
  the system shutdown script in order to shut down webmail service
  gracefully).</p>

  <p>Note that the webmail server is used to access mail in
  existing accounts only. There is no provision to create accounts
  through the webmail interface (nor there should be).</p>

  <p>Your web server also needs to be configured to use HTTP/1.0
  when talking to any MSIE browser. The MSIE browser has a number
  of bugs in its HTTP/1.1 implementation, at least as of MSIE 4.x
  and 5.x. You must configure your web server to use HTTP/1.0 when
  talking to any MSIE browser (at least until MSIE gets fixed). The
  problem has to do with downloading attachments. Apparently, MSIE
  forgets how MIME works, when it uses HTTP/1.1. For the Apache
  server, insert the following directive in httpd.conf:</p>
  <pre>
BrowserMatch "MSIE" nokeepalive downgrade-1.0 force-response-1.0
</pre>

  <p>Recent versions of Apache already have a similar directive for
  a specific version of MSIE, MSIE 4.0b2. Just replace it with a
  browsermatch for any MSIE version.</p>

  <h3>SELinux</h3>

  <p>The following extension may be necessary to make webmail work
  when SELinux kernel extensions are turned on:</p>
  <pre>
allow httpd_sys_script_t var_t:sock_file write;
allow httpd_sys_script_t unconfined_t:unix_stream_socket connectto;
</pre>

  <h3><a name="spellcheck" id="spellcheck">Spell checking</a></h3>

  <p>The webmail server can use either the ispell or the aspell
  package for spell checking. Install ispell or aspell before
  installing the <i>Courier</i> mail server.</p>

  <p>NOTE: <i>Courier</i> mail server assumes that the spell
  checking dictionary is called "english". Some systems use a
  different name for the default spell checking dictionary. To
  change the name of the spell checking dictionary used by the
  webmail server, put the name of the dictionary into the file
  <code>/usr/lib/courier/share/sqwebmail/html/en-us/ISPELLDICT</code>.</p>

  <h3>Images</h3>

  <p>It is also necessary to install the static icon images used by
  the webmail server. The installation script copies the static
  images to the
  <code>/usr/lib/courier/share/sqwebmail/images</code> directory.
  By default, the webmail server uses the URL
  "<code>/webmail/</code>" to specify the location of the static
  images, for example: <code>/webmail/folders.gif</code>. This
  means that you must create a subdirectory called
  "<code>webmail</code>" in your web server's document root -
  typically <code>/usr/local/etc/apache/htdocs/webmail</code>, or
  <code>/usr/local/www/htdocs/webmail</code>, or something similar.
  You will need to determine the actual location of your web root
  directory, which varies from system to system. Then, create a
  subdirectory named "<code>webmail</code>", and copy all the icons
  to that directory.</p>

  <p>Another possibility is to install a soft link, instead of
  creating the <code>webmail</code> sub directory, and point the
  soft link to <code>/usr/lib/courier/share/sqwebmail/images</code>
  (you also must make sure that the web server is configured to
  follow symlinks).</p>

  <p>There is a configuration option,
  <code>--enable-imageurl</code>, that can be used to use something
  other than <code>/webmail/</code> as the URL prefix for
  images.</p>

  <h3>Alternative timezones</h3>

  <p>The file
  <code>/usr/lib/courier/share/sqwebmail/html/en-us/TIMEZONELIST</code>
  contains a list of alternative timezones. By default all dates
  and times are shown in the server's default timezone, and the
  dropdown list on the login screen can be used to select an
  alternative timezone. The default alternative timezone list that
  lists only a small number of timezones. Additional timezones can
  be entered into this file to be shown on the login web page.</p>

  <h3>LDAP address book import</h3>

  <p>The webmail server can import E-mail addresses from public
  LDAP address books into an individual address book. A default
  systemwide list of accessible LDAP address books is defined for
  everyone, and individuals can configure additional LDAP address
  books for themselves.</p>

  <p>The OpenLDAP development toolkit must be installed before
  building SqWebMail, in order for LDAP search code to compile.</p>

  <p>The file <code>ldapaddressbook</code> configuration file
  should contain a default systemwide list of accessible address
  book. See <a href="courier.html">courier(8)</a> for more
  information. A default file will be installed, listing some
  common Internet address books. Each line in this file contains
  the following information:</p>
  <pre>
name&lt;tab&gt;host&lt;tab&gt;port&lt;tab&gt;suffix&lt;tab&gt;binddn&lt;tab&gt;bindpw
</pre>

  <p><i>&lt;tab&gt;</i> is a single ASCII TAB character.
  <i>name</i> is the unique name for this LDAP server. <i>host</i>
  and <i>port</i> specify the connection parameters. <i>suffix</i>
  specifies the root LDAP entry whose subtree gets searched. The
  <i>binddn</i> and <i>bindpw</i> fields are not presently used
  (they were used in earlier version of the webmail server, before
  the LDAP search interface was rewritten and simplified).</p>

  <h2><a name="calendaring" id="calendaring">OPTIONAL: Configure
  webmail calendaring</a></h2>

  <p>Optional calendaring services can be enabled in the webmail
  server. Right now, the current implementation provides basic
  calendaring services. For more information on calendaring, see
  the file <a href=
  "pcp_README.html"><code>pcp/README.html</code></a>.</p>

  <h3>Webmail session timeouts</h3>

  <p>A login session is automatically logged out after certain
  period of inactivity. The timeout period defaults to 20 minutes,
  and is set by the <code>--enable-softtimeout</code> option to the
  configure script. It is also possible to adjust this value by
  setting the <code>SQWEBMAIL_TIMEOUTSOFT</code> environment
  variable. For example, with Apache, by adding the following to
  <code>httpd.conf</code>:</p>
  <pre>
SetEnv SQWEBMAIL_TIMEOUTSOFT 3600
</pre>

  <p>There is also a hard timeout, which logs out a session no
  matter what. The default of two hours is changed with the
  <code>--enable-hardtimeout</code> option to the configure script,
  and the <code>SQWEBMAIL_TIMEOUTHARD</code> environment
  variable.</p>

  <p><b>WARNING:</b></p>

  <p>The hard timeout interval is used to calculate the maintenance
  of the login cache (if that option is selected). This factor is
  used in the <code>cleancache.pl</code> cleanup script, and
  changes to this value must be coordinated appropriately. It is
  not possible to use different hard timeout values with the same
  login cache (in different virtual domains, as described in the
  next session). Leisurely tinkering with this environment variable
  is STRONGLY DISCOURAGED, it's very easy to screw up the whole
  system. You've been warned.</p>

  <p>If you adjust the hard timeout, you must simultaneously delete
  your current login cache directory, and adjust $timeouthard in
  the installed <code>cleancache.pl</code> script.</p>

  <h3><a name="maxsizes" id="maxsizes">Maximum message
  sizes</a></h3>

  <p>Messages composed in the webmail server are limited in size.
  The additional limitation are on top of the limit set in the
  <em>sizelimit</em> configuration file, see the <a href=
  "courier.html">courier(8)</a> manual page.</p>

  <p>The <code>--with-maxargsize</code>,
  <code>--with-maxformargsize</code>, and
  <code>--with-maxmsgsize</code> options to the
  <code>configure</code> script set the parameters that control the
  maximum size of messages and attachments. These parameters can
  also be set through the following environment variables.</p>

  <blockquote>
    <p><em>NOTE:</em> The <code>configure</code> script parameters
    define the minimum settngs. The following environment variables
    may be used to set larger limits only.</p>

    <p><em>NOTE:</em> These settings limit only the maximum size of
    messages sent from the webmail server. The limit on the
    incoming message size is set by other <i>Courier</i> mail
    server settings (usually the <i>sizelimit</i> setting
    also).</p>
  </blockquote>

  <dl>
    <dt><code>SQWEBMAIL_MAXARGSIZE</code></dt>

    <dd>
      Approximate maximum size, in bytes, of the message, excluding
      any attachments (overrides the <code>--with-maxargsize</code>
      parameter to the <code>configure script</code>). This is the
      maximum message that can be typed into the webmail server.

      <p><em>NOTE:</em> The webmail server has an inactivity
      timeout. While composing a new message use the "Preview"
      button frequently to save the unfinished message and keep the
      session from timing out.</p>
    </dd>

    <dt><code>SQWEBMAIL_MAXATTSIZE</code></dt>

    <dd>
      Approximate maximum size, of each allowed attachment.
      (overrides the <code>--with-maxargsize</code> parameter to
      the <code>configure script</code>).

      <p><em>NOTE:</em> Attaching binary files to E-mail messages
      incurs an overhead of approximately 33%. E-mail is really not
      the optimum medium for exchanging files. Setting
      <code>SQWEBMAIL_MAXATTSIZE</code> to 4000000 will effectively
      allow attaching files of up to 3000000 bytes in length,
      approximately.</p>
    </dd>

    <dt><code>SQWEBMAIL_MAXMSGSIZE</code></dt>

    <dd>Approximate maximum size, of a message, including the text
    portion and all attachments (overrides the
    <code>--with-maxmsgsize</code> parameter to the <code>configure
    script</code>). There can be any number of attachments, each
    one up to <code>SQWEBMAIL_MAXATTSIZE</code> bytes long, but the
    sum total of the entire message cannot exceed
    <code>SQWEBMAIL_MAXMSGSIZE</code>.</dd>
  </dl>

  <p>These variables must be set in the environment that runs the
  webmail <code>CGI</code> program. With Apache, these variables
  can be set in the <i>httpd.conf</i> file by the
  <code>SetEnv</code> command. <i>httpd.conf</i> example:</p>

  <blockquote>
    <pre>
SetEnv SQWEBMAIL_MAXATTSIZE 1000000
SetEnv SQWEBMAIL_MAXMSGSIZE 4000000
</pre>
  </blockquote>

  <blockquote>
    <p><em>NOTE:</em> These settings are global, and apply to all
    mailboxes. However, advanced Apache configuration can be used
    to use different environment variable settings with different
    virtual hosts.</p>

    <p><em>NOTE:</em> On 32-bit platforms, the maximum limits may
    not exceed 2 gigabytes. A 64-bit platform is required to have
    SqWebMail capable of handling attachments and messages larger
    than 2 gigabytes.</p>
  </blockquote>

  <h3>Random seed</h3>

  <p>A random seed is required for preventing certain kinds of
  external attacks against the SqWebMail server. The random seed
  must be a constant value, only varying between different
  instances of SqWebMail. By default the random seed is derived
  from the inode number of one of the supporting script files. The
  script file ordinarily remains constant, thus the random seed
  does not change, but different SqWebMail installs will end up
  with a different seed.</p>

  <p>When a pool of SqWebMail servers is combined for
  load-balancing, all servers must use the same random seed. This
  is done by defining the <tt>SQWEBMAIL_RANDSEED</tt> environment
  variable. This can be set in the <i>httpd.conf</i> as well:</p>

  <blockquote>
    <pre>
SetEnv SQWEBMAIL_RANDSEED 82738AZ
</pre>
  </blockquote>

  <p><tt>SQWEBMAIL_RANDSEED</tt> should contain up to ten letters
  or numbers.</p>

  <h3>Domain-based templates</h3>

  <p>The default set of templates for the dynamically generated
  HTML is installed in
  <code>/usr/local/share/sqwebmail/html</code>. When the same
  server is used to provide webmail access for multiple domains it
  is possible to specify a different set of HTML templates for each
  domain.</p>

  <p>This functionality is not directly implemented in SqWebMail,
  simply because there is no standard way to specify this. Instead,
  this is something that will need some minor work set up.</p>

  <p>Domain-based templates are implemented by making the web
  server set the environment variables
  <code>SQWEBMAIL_TEMPLATEDIR</code> prior to running the
  <code>sqwebmail</code> binary. The contents of this environment
  variable override the default location of
  <code>/usr/local/share/sqwebmail/html</code>. By having the web
  server initialize this variable based on the domain name it is
  possible to present different templates, based on the domain name
  used.</p>

  <p>To do this, make copies of the HTML template directory,
  <code>/usr/local/share/sqwebmail/html. Then, configure the web
  server to initialize</code> SQWEBMAIL_TEMPLATEDIR appropriately.
  For example, with Apache:</p>
  <pre>
  &lt;VirtualHost <i>a.b.c.d</i>&gt;
    ServerName <i>webmail.example.com</i>
    [...]
    SetEnv SQWEBMAIL_TEMPLATEDIR <i>/usr/local/share/webmail/webmail.example.com</i>
    [...]
  &lt;/VirtualHost&gt;
</pre>The possibilities are endless.

  <h3>Name-based templates</h3>

  <p>It is now possible to display two or more templates from the
  same CGI binary WITHOUT setting up multiple domain names.</p>

  <p>For example, with Name-based templates an sqwebmail
  administrator can set up sqwebmail to display a template in the
  <code>/usr/local/share/sqwebmail/html</code> directory when
  sqwebmail is called from the URL:
  <code>http://www.foo.com/cgi-bin/sqwebmail</code></p>

  <p>And display a <b>different</b> template in the
  <code>/usr/local/share/sqwebmail/alternate-html</code> directory
  when sqwebmail is called from the URL:
  <code>http://www.foo.com/cgi-bin/sqwebmail-alt-template</code></p>

  <p>This is made possible by a little web server magic (explained
  below in the section entitled <a href="#nametempsapache">"Apache
  Name-based template configuration example"</a>) and the setting
  of TWO sqwebmail environment variables:</p>
  <pre>
SQWEBMAIL_TEMPLATEDIR
SQWEBMAIL_IMAGEURL
</pre>

  <p>You should recognize the SQWEBMAIL_TEMPLATEDIR environment
  variable from the section above on <a href=
  "#domaintemps">Domain-based templates</a>. If you haven't read
  that section yet, please do so now.</p>

  <p>The SQWEBMAIL_IMAGEURL environment variable is new in versions
  of sqwebmail greater than sqwebmail-3.5.3.20030629. It allows us
  to set, at run time, the image URL, or the root URL, in which to
  look for our template's images. This image URL is then
  automatically inserted into the current template anytime a
  conditional image tag or an IMAGEURL tag is encountered.</p>

  <p>This is an example of a conditional image tag:</p>

  <p><code>[#@image.gif, ... @text@#]</code></p>

  <p>The conditional image tag is replaced at template processing
  time with an HTML &lt;img src="..."&gt; tag <b>if</b> (hence the
  word "conditional") sqwebmail is set up to display images.</p>

  <p>This is an example of an IMAGEURL tag:</p>

  <p><code>[#IMAGEURL#]</code></p>

  <p>The <code>IMAGEURL</code> tag is replaced at template
  processing time with the contents of the
  <code>SQWEBMAIL_IMAGEURL</code> environment variable, if set, and
  otherwise with the value of the <code>--with-imageurl</code>
  configure option, which defaults to "<code>/webmail</code>".</p>

  <h3><a name="nametempsapache" id="nametempsapache">Apache
  Name-based template configuration example</a></h3>

  <p>Let's take a look at a simple Apache Name-based sqwebmail
  template configuration example:</p>
  <pre>
  
  # Sqwebmail Alternate Template URL
  ScriptAlias /cgi-bin/sqwebmail-alt-template <i>"/usr/local/apache/cgi-bin/sqwebmail"</i>

  &lt;Location <i>/cgi-bin/sqwebmail-alt-template</i>&gt;
      Setenv SQWEBMAIL_TEMPLATEDIR <i>"/usr/local/share/sqwebmail/alternate-template"</i>
      Setenv SQWEBMAIL_IMAGEURL <i>"/alternate-webmail"</i>
      [...]
  &lt;/Location&gt;
      
</pre>

  <p>The above should allow your users to run sqwebmail with the
  template in
  <code>/usr/local/share/sqwebmail/alternate-template</code> and an
  image URL of <code>/alternate-webmail</code>, simply by calling
  sqwebmail from the following URL:</p>

  <p>
  <code>http://www.yourdomain.com/cgi-bin/sqwebmail-alt-template</code></p>

  <p>The original sqwebmail templates would then still be available
  from this URL:</p>

  <p><code>http://www.yourdomain.com/cgi-bin/sqwebmail</code></p>

  <p>Using Apache's &lt;Location&gt; directive we can utilize a
  virtually unlimited number of templates without setting up a
  single virtual domain.</p>

  <h2><a name="webfilter" id="webfilter">OPTIONAL: Configure mail
  filtering for the webmail server</a></h2>

  <p>This is an optional feature where the webmail server is used
  to automatically set up mail filtering rules to forward or
  deliver incoming mail to folders. This feature requires maildrop
  to be used as the local mail delivery agent.</p>

  <p>Edit the <code>courierd</code> configuration file, and follow
  the instructions in that file to install <code>maildrop</code> as
  the local mail delivery agent. Then, follow the instruction below
  to create the <code>maildirfilter</code> configuration file,
  which may be installed either in the global configuration file
  directory (<code>/usr/lib/courier/etc</code> by default), or in
  each individual Maildir (which overrides the global default).</p>

  <p>Implementing mail filtering requires a couple of dominos to
  fall in the right order. This is not difficult to do, but is a
  bit tricky. Here's how it works, in general. Specifics
  follow.</p>

  <p>Some people would probably have a difficult time setting it
  up. That's to be expected. The implementation allows only
  selected accounts to be set up for mail filtering, so the
  suggested way is to attempt to set up mail filtering for one
  account only, test it to make sure it works, then roll it out
  globally.</p>

  <h3>The big picture</h3>

  <p>The <i>maildrop</i> mail filter is used to do the actual mail
  filtering. <i>maildrop</i> must be installed as your local mail
  delivery agent. The next thing to do is to actually learn how
  <i>maildrop</i> works, and learn its filtering language. Although
  the mail filter will be automaticaly generated here, you still
  need to become familiar with the filtering language in order to
  troubleshoot any installation problems. <i>maildrop</i> comes
  with manual pages documenting the filtering language, as well as
  some examples. Read them.</p>

  <h3>The little picture</h3>

  <p>Here's what's going to happen. The webmail server will
  automatically generate a <i>maildrop</i> filtering recipe.
  <i>maildrop</i> reads the recipe, and does its thing. Sounds
  simple enough, right?</p>

  <p>Well, it's not. There are a few little details that need to be
  resolved.</p>

  <p>For starters, the default <i>maildrop</i> filtering recipe is
  <code>$HOME/.mailfilter</code>. That's how things usually work
  physical system accounts are used. When virtual mailboxes are
  installed, things are less murky. There are several ways to set
  up virtual mailboxes, described elsewhere in this INSTALL file,
  so the actual implementation varies from system to system.
  Somehow, the virtual mailboxes share the same physical account,
  and have the same $HOME. In that case the usual approach is for
  each virtual mailbox to have the corresponding mail filtering
  recipe manually specified to <i>maildrop</i> as an extra command
  line argument. Review the <i>maildrop</i> documentation for more
  information.</p>

  <p>Now, on the other hand, the webmail server doesn't really know
  anything about physical and virtual accounts. The mapping between
  a login ID and the maildir is completely encapsulated in the
  black box-type authentication library. The login ID and password
  are validated by the authentication library, which obtains the
  maildir corresponding to the login ID, and the webmail server is
  started for that maildir. Whether or not a login ID corresponds
  to an actual system account or to virtual account, that's
  something the webmail server doesn't really know, or care. All it
  cares about is the maildir where all the mail is, and that's the
  end of the story. (The IMAP and POP3 servers work the same
  way).</p>

  <p>So, the issue is that the webmail server needs to find the
  corresponding <i>maildrop</i> filtering recipe, so it knows where
  to write the mail delivery instructions. That's the deal</p>

  <p>In order for mail filtering to be enabled, it is necessary to
  initialize the file named <code>maildirfilterconfig</code> in the
  maildir itself. This is where the webmail server runs, so it
  simply reads this file. The contents of this file should be as
  follows:</p>
  <pre>
MAILDIRFILTER=<i>pathtomailfilter</i>
MAILDIR=<i>pathtomaildir</i>
</pre>

  <p><i>pathtomailfilter</i> specifies the location of the
  <i>maildrop</i> filtering recipe for this maildir, relative to
  the <i>maildir</i> itself. Set the current directory to the
  maildir directory. Now ask yourself, where's my <i>maildrop</i>
  filtering recipe?</p>

  <p>In most cases, where virtual mailboxes are not used,
  everyone's maildir is <code>$HOME/Maildir</code>, and
  <i>maildrop</i> uses <code>$HOME/.mailfilter</code> by default.
  In this case, <i>pathtomailfilter</i> must be set to
  <code>../.mailfilter</code>.</p>

  <p>When virtual mail accounts are used, this will obviously be
  something else. The only requirement is that the <i>maildrop</i>
  filtering recipe and the maildir <b>must be on the same
  filesystem or partition</b>.</p>

  <p><i>pathtomaildir</i> is the other half of the story. When
  <i>maildrop</i> gets a message to deliver, <i>maildrop</i> needs
  to know where the mailboxes and folders are. <i>Maildrop</i>
  begins running in what it considers to be the recipient's home
  directory, reading either <code>.mailfilter</code>, by default,
  or the file specified on the command line.</p>

  <p>The webmail server needs to generate filtering instruction
  that deliver messages to its maildir. By default, the maildir for
  non-virtual accounts is $HOME/Maildir, so <i>pathtomaildir</i>
  needs to be set to <code>./Maildir</code>.</p>

  <h3>Summary for virtual accounts</h3>

  <p>Basically, 99% of the time <code>MAILDIRFILTER</code> will be
  <code>../.mailfilter</code> and <code>MAILDIR</code> will be
  <code>./Maildir</code>. When virtual mail accounts are used,
  <i>maildrop</i> still must be used as a mail delivery agent.
  Somehow, the correct maildir that corresponds to the recipient's
  mail account must be specified as the argument to
  <i>maildrop</i>. Usually all or most virtual accounts are set up
  inside a single physical account. In that case it is necessary to
  set up a different <i>maildrop</i> filtering recipe file for each
  virtual mail account (since everyone's
  <code>$HOME/.mailfilter</code> will be the same file), and in
  each maildir specify the relative path to its corresponding
  filtering recipe, and the relative path to the maildir from the
  default home directory. Then, for each virtual mail account, the
  mail server must run <i>maildrop</i> to do the actual mail
  delivery, explicitly specifying the filtering recipe to be
  used.</p>

  <h3>The global <code>maildirfilterconfig</code> file</h3>

  <p>In most cases where virtual mail accounts are not used, every
  maildir's <code>maildirfilterconfig</code> should be the same. As
  an alternative to installing the same
  <code>maildirfilterconfig</code> in each maildir, it is possible
  to install a single <code>maildirfilterconfig</code>
  systemwide.</p>

  <p>Install the global <code>maildirfilterconfig</code> in the
  <i>Courier</i> mail server's configuration directory
  (<code>/usr/lib/courier/etc</code> by default).</p>

  <p>The global <code>maildirfilterconfig</code> will be used
  unless <code>maildirfilterconfig</code> exists in the maildir
  directory. Therefore, the global <code>maildirfilterconfig</code>
  can be used to provide a default for the majority of the mail
  accounts, and any exceptions are handled by installing
  <code>maildirfilterconfig</code> in the maildir directory, whose
  contents will override the global file.</p>

  <h3>Happy filtering.</h3>

  <p>If everything is set up correctly, the webmail menu will
  present a new link to a screen where mail filtering rules are
  defined and installed. A mail filter consists of a condition, and
  an action. A condition is usually based on the contents of some
  header, or the message body. Regular expressions are allowed.
  Which means that certain special characters must be quoted. For
  example, to search for the string "[announce]" verbatim in the
  subject header, it must be entered as "\[announce\]". Pattern
  matching, for now, is case-insensitive. The regular expression
  syntax uses pretty much the same syntax as Perl. See the
  maildropfilter manual page for more information.</p>

  <p>Multiple mail filtering rules can be installed. Their relative
  order can be rearranged by selecting a filtering rule, then
  selecting either the "Up" or the "Down" button. It is necessary
  to select "Save all changes" for any changes to the filtering
  rules to take effect. Leaving that page in any other way will
  throw away all changes made.</p>

  <h3>Webmail runtime configuration</h3>

  <p>There are some options which can be used to change the webmail
  server's behavior for individual accounts, or globally, using the
  "Account Options" feature in the <i>Courier</i> mail server
  Authentication library. The individual account's setting takes
  precedence over the DEFAULTOPTIONS settings in the
  <i>authdaemonrc</i> configuration, so for example if you want to
  disable webmail access for most accounts but enable it for a
  select few, you can set
  <code>DEFAULTOPTIONS="disablewebmail=1"</code> in the
  <code>authdaemonrc</code> configuration file, and add the option
  <code>disablewebmail=0</code> to individual accounts. See the
  section "Account options" in README_authlib.html in the
  courier-authlib package for more information on setting the
  following account options:</p>

  <p><code>disablewebmail</code> - if set to a non-zero value, this
  account will not be permitted to login to webmail (e.g. because
  the user is only allowed to use POP3 or IMAP)</p>

  <p><code>wbnochangingfrom</code> - if set to a non-zero value,
  the webmail server will not allow the <code>From:</code> header
  to be changed, it will always have its default value.</p>

  <p><code>wbnochangepass</code> - if set to a non-zero value, the
  webmail server will not allow passwords to be changed. See
  "<a href="#changepass">Changing mail account passwords using the
  webmail server</a>", below, for more information.</p>

  <p><code>wbusexsender</code> - if set to a non-zero value, the
  webmail server will attach an <code>X-Sender:</code> header to
  all outgoing messages. This can be used in the event you would
  like to be able to modify the From: header, yet also be able to
  track sent mail to the original account.</p>

  <p><code>wbnoimages</code> - if set to a non-zero value then no
  images or icons will be used. The generated interface will be a
  text-only interface.</p>

  <p><code>wbnodsn</code> - set to a non-zero value then the option
  to request delivery confirmation receipts will not be shown.</p>

  <h2><a name="changepass" id="changepass">OPTIONAL: Changing mail
  account passwords using the webmail server</a></h2>

  <p>After installing the webmail server be sure to test that the
  login password can be changed through the webmail server.</p>

  <p>If you do not want to use the password change function you can
  also remove the <code>sqwebpasswd</code> program. This is a
  helper program, installed with the set-groupid bit set, that
  relays the password change request to the authentication daemon,
  through the filesystem socket that is not globally accessible.
  The password change request consists of the account name, the old
  password, and the new password. The password change request is
  validated by the authentication daemon, and the old password must
  match the existing password on the account, before the password
  change goes through. This set-groupid helper program is safe to
  use.</p>

  <h2><a name="autoreply" id="autoreply">OPTIONAL: Configure
  autoreplies for the webmail server</a></h2>

  <p>Enabling mail filtering, according to the instructions in the
  previous section, automatically enables MIME autoreply
  capability. The webmail interface can be used to configure simple
  autoresponders. By default there is no limit on the number of the
  size of created autoreplies, therefore it is recommended that a
  quota be set up on the autoreplies.</p>

  <p>An global autoreply quota is set up by initializing the
  <code>/usr/lib/courier/etc/autoresponsesquota</code>
  configuration file. This file sets the autoreply quota globally.
  An <code>autoresponsesquota</code> file in the Maildir will
  override the global quota setting for that maildir only. See the
  <a href="courier.html">courier(8)</a> manual page for the
  description of the <code>autoresponsesquota</code> file.</p>

  <p>Autoreplies can include any valid MIME content (MIME content
  other than plain text can be uploaded). The following special
  procedure needs to be used to prepare multipart autoreply
  content, such as text and html alternatives of the same
  message:</p>

  <p>Assign a filename extension to the <code>message/rfc822</code>
  MIME content. For example, edit your <code>mime.types</code>
  file, find the <code>message/rfc822</code> MIME type (append one
  if it's not in <code>mime.types</code>), and make sure that it
  has at least one filename extension, such as "msg".</p>

  <p>Prepare the multipart MIME autoreply. The most convenient way
  is to prepare a normal E-mail message using a conventional E-mail
  client. Save the RFC822-formatted message in a file with a ".msg"
  extension, and upload it on the autoreply screen.</p>

  <p><code>Webmail</code> handles uploaded
  <code>message/rfc822</code> content by removing all headers
  except the MIME headers, leaving the MIME content type header,
  and the actual MIME content.</p>Normally there is no limit on the
  number or the total size of autoreplies configured via the
  webmail server. A quota can be installed by initializing the
  <code>autoresponsesquota</code> configuration file. See <a href=
  "courier.html"><code>courier(8)</code></a> for more information.

  <h2><a name="gpg" id="gpg">OPTIONAL: Configure encryption for the
  webmail server</a></h2>

  <p>This is an optional feature in the webmail server that uses
  GnuPG to send and receive encrypted/signed E-mail. There is no
  encryption code in the webmail server, it uses <a target="_blank"
  href="http://www.gnupg.org/">GnuPG</a> to do encryption and
  decryption. For more information on setting up and using
  encryption, read the file <code>gpglib/README.html</code> in the
  source distribution.</p>

  <h2><a name="footer" id="footer">OPTIONAL: Install
  automatically-appended footer text for webmail messages</a></h2>

  <p>
  <code>/usr/lib/courier/share/sqwebmail/html/<i>LANG</i>/footer</code>
  - if this file exists, its contents will be appended to the end
  of every sent message from the webmail server. The actual
  directory where sqwebmail's html language files are installed may
  be different with prebuilt Courier packages. <i>LANG</i> is the
  language code here, there can be a separate footer per installed
  language. The <i>footer</i> file carries the following
  requirements:</p>

  <ul>
    <li>
      <p>The footer file must be coded in <tt>UTF-8</tt>.</p>
    </li>

    <li>
      <p>The footer file must follow the <tt>format=flowed;
      delsp=yes</tt> format, as specified by <tt>RFC 3676</tt>.
      Capsule summary:</p>

      <ul>
        <li>
          <p>Paragraphs are delimited by blank lines.</p>
        </li>

        <li>
          <p>Paragraphs that consist of more than one line must
          have a trailing space ending each line except the last
          line in the paragraph.</p>
        </li>

        <li>
          <p>That trailing space is in addition to a space that
          delimits individual words in most Western languages.
          Therefore, a line that ends on a word without punctuation
          and continues with the next word at the beginning of the
          next line must end with two spaces: the usual space that
          separates individual words, and a second space that
          indicates that the paragraph continues on the next
          line.</p>
        </li>

        <li>
          <p>Restated: a line that ends with a space is logically
          joined with the next line, after the trailing space is
          logically removed.</p>
        </li>

        <li>
          <p>Lines that begin with a space character or the "&gt;"
          character must have an additional space character
          prepended to them. This leading space character is
          logically removed from the contents of the line.</p>
        </li>
      </ul>
    </li>

    <li>
      <p>Signature content gets formatted as part of the message
      together with the rest of the content. Sender-selected option
      to format the message as either a plain text message, or
      using wiki-style HTML markup applies to the footer file too.
      The footer file's contents should be constructed taking into
      account the possibility that wiki-style HTML markup may get
      optionally applied to the footer content.</p>
    </li>
  </ul>

  <h2><a name="quota" id="quota">OPTIONAL: Quota support</a></h2>

  <p>There are two ways to implement a quota on the size of a mail
  account: filesystem quotas and maildir quotas:</p>

  <h3>Filesystem quotas</h3>

  <p>The maximum disk space quota is implemented within the
  operating system's filesystem support code. Here, the operating
  system enforces the maximum disk space that can be used by each
  account. This is the only reliable quota implementation if
  individual accounts have login access to the mail account.
  Maildir quotas (see below) are implemented entirely within the
  maildir support code, and can easily be superceeded by anyone
  with login access to the mail account. Additionally, mail
  accounts must all be system accounts. Virtual accounts -- that
  share the same physical system userid -- cannot usually be
  support by filesystem-based quotas, because all mail accounts
  have the same userid and groupid.</p>

  <p><b>The webmail server cannot be used with filesystem
  quotas.</b> The webmail server creates and maintains, all by
  itself, a number of database files that are used to quickly index
  and access messages. If an account exceeds its disk quota, the
  webmail server will not be able to create and update those
  database file, which results in a rather spectacular crash. If
  login access is available, it is possible to log in and manually
  delete some files to reclaim some disk space. If login access is
  not available, the administrator will have to manually fix the
  account -- the webmail server will not even be able to open an
  existing folder and delete messages in order to free up disk
  space. There is some good news, though: the IMAP and the POP3
  server can still be used to access and delete messages from the
  mail account. Due to the way that out-of-quota condition is
  handled by the IMAP server, some IMAP clients may mark any
  existing messages in the account as unread, but that is a minor
  glitch that does no harm.</p>

  <h3>Maildir quotas</h3>

  <p>The <i>Courier</i> mail server can manually enforce a quota
  for mail accounts that use maildirs. This quota enforcement is
  implemented entirely in software, and is available only when
  maildirs are used. This quota implementation will also work with
  virtual accounts. Maildir quota support is available only with
  userdb, LDAP, MySQL and PostgreSQL authentication back-ends.
  Maildir quotas are supported by IMAP, POP3, and the webmail
  server. To add a maildir quota with userdb, run the following
  commands, for example:</p>
  <pre>
userdb <i>account</i> set quota=<i>quota</i>
makeuserdb
</pre>

  <p>Here, <i>account</i> identifies the account to which the quota
  applies, and <i>quota</i> is the quota specification, as
  described in the <a href=
  "maildirquota.html"><code>maildirquota(7)</code></a> manual
  page.</p>

  <p>To implement a quota with an LDAP, MySQL, or a PostgreSQL back
  end, simply follow the instructions given in the corresponding
  configuration file.</p>

  <h2><a name="options" id="options">Account OPTIONS</a></h2>

  <p>It is possible to adjust certain parameters on an
  account-by-account basis. This feature is actually implemented in
  the <i>Courier</i> mail server Authentication Library. See
  ACCOUNT OPTIONSin the <code>auth_generic</code> manual page.</p>

  <h2><a name="sendfax" id="sendfax">OPTIONAL: Configure outbound
  faxing</a></h2>

  <p>Fax sending is disabled by default and must be explicitly
  enabled, according to the following instructions. After fax
  sending is enabled, addressing an E-mail message to
  <tt>&lt;5552000@fax&gt;</tt> will have this message faxed.</p>

  <p>Of course, the necessary hardware and software must be
  available. The requisite hardware is a class 2 faxmodem attached
  to a serial port. Additional software, separate from the
  <i>Courier</i> mail server, must also be installed. The
  <i>Courier</i> mail server does not handle the actual job of
  faxing. The <i>Courier</i> mail server only reformats E-mail
  messages as fax images, and runs <a target="_blank" href=
  "http://alpha.greenie.net/mgetty/">mgetty+sendfax</a> to send the
  fax. The <i>Courier</i> mail server also needs additional
  software to convert E-mail messages to faxes. All additional
  software must be separately installed, configured, and tested
  before enabling faxing in the <i>Courier</i> mail server. Most
  systems already include the following software as part of the
  base operating system, so in most cases adding fax support will
  not actually require any additional software to be installed,
  only minor reconfiguration of existing software:</p>

  <h3>mgetty+sendfax</h3>

  <p><tt>mgetty+sendfax</tt> works with most Class 2 faxmodems. The
  <i>Courier</i> mail server does not use the spooling scripts
  found in the <tt>mgetty+sendfax</tt> package. The <i>Courier</i>
  mail server uses its own mail spool. A fax message is handled no
  differently than any other E-mail message. The only difference is
  that the E-mail message is addressed to
  <tt>&lt;phonenumber@fax&gt;</tt>.</p>

  <p><tt>mgetty+sendfax</tt> should be configured with its default
  settings, EXCEPT as follows:</p>

  <ul>
    <li>In <tt>/etc/mgetty+sendfax</tt>, the
    <tt>"max-tries-continue"</tt> setting must be set to "n".</li>
  </ul>

  <h3>groff or troff, ghostscript, NetPBM</h3>

  <p>Conversion of E-mail messages to faxes uses <a target="_blank"
  href="http://www.ghostscript.com/">ghostscript</a>, and
  <a target="_blank" href=
  "http://www.gnu.org/software/groff/groff.html">groff</a>. It
  should be possible to use the original UNIX troff instead of
  groff, but this has not been tested. The <i>Courier</i> mail
  server generates the fax cover page from the contents of the
  E-mail message's headers. The initial text portion of the E-mail
  message will appear as fax cover page comments. Note that the
  initial text portion of the E-mail message must be in plain text,
  not HTML. E-mail attachments will be converted and attached as
  additional fax pages. E-mail attachments may contain plain text,
  Postscript or PDF documents. Other attachments will result in the
  E-mail message being returned as undeliverable.</p>

  <p>On the cover page, the sender's name, the recipient's name,
  and the fax subject gets taken from the E-mail message's headers.
  The ability to use non-Latin characters depends on the support
  from the underlying tools, <i>ghostscript</i> and <i>groff</i>,
  for the default system locale.</p>

  <p>Install the <a target="_blank" href=
  "http://netpbm.sourceforge.net/">NetPBM</a> library to add the
  ability to fax GIF, JPEG, and PNG images. Each image will be
  converted to a single fax page. Images in excess of 1500x1500
  pixels (approximately) will be truncated, and color images will
  be dithered to black-and-white.</p>

  <h3>Enabling faxing</h3>

  <p>The configuration file <tt>/usr/lib/courier/etc/faxrc</tt>
  must be edited in order to enable faxing. This file sets up the
  dialing parameters, and the default file disables faxing by
  rejecting all phone numbers. The configuration file has extensive
  comments that explain how dialing parameters are set.</p>

  <p>Using webadmin to set up fax sending is highly recommended. A
  proper <tt>faxrc</tt> will automatically hide all the local
  daling conventions. Webadmin knows how to generate the dialing
  configuration for the North American dialing plan, with a
  configurable area code. Faxes should be addressed to a fixed ten
  digit area code+phone number address,
  <tt>&lt;nnnxxxxxxx@fax&gt;</tt>, which will be converted for
  dialing from the local area code appropriately. Webadmin can also
  optionally enable faxing to international 011 phone numbers.
  Webadmin can also fall back to a bare configuration where all
  phone numbers are dialed as-is, for locations outside of North
  America.</p>

  <h3>Sending faxes</h3>

  <p>E-mail messages may contain attachments. The <i>Courier</i>
  mail server combines all attachments in the message into a single
  fax transmission. Attachment types may be freely mixed. A single
  message may contain one plain text, and one PDF attachment, for
  example. It is possible to select certain options, as
  follows:</p>

  <ul>
    <li>
      <tt>&lt;phonenumber@fax-lowres&gt;</tt>

      <p>sends a low-resolution fax.</p>
    </li>

    <li>
      <tt>&lt;phonenumber@fax-ignore&gt;</tt>

      <p>Ignore attachments that the <i>Courier</i> mail server
      doesn't know how to convert to a FAX image format. Normally,
      if an attachment cannot be converted the whole message is
      returned as undeliverable.</p>
    </li>

    <li>
      <tt>&lt;phonenumber@fax-cover&gt;</tt>

      <p>sends only the cover page. This can be useful for <a href=
      "dot-courier.html">.courier</a> files. See the <a href=
      "courierfax.html">courierfax(8)</a> manual page for an
      example.</p>
    </li>
  </ul>

  <p>These options can be combined:
  <tt>&lt;phonenumber&gt;@fax-lowres-ignore&gt;</tt>.</p>

  <h3>Cover pages</h3>

  <p><tt>/usr/lib/courier/etc/faxcoverpage.tr</tt> is the troff
  source for the FAX cover page, which includes the first plain
  text section of the E-mail message. Do not attempt to play with
  <tt>faxcoverpage.tr</tt> without a clear understanding of troff.
  It is safe to make trivial changes (such as replacing the
  "FACSIMILE COVER PAGE" text).</p>

  <h3>Dialing</h3>

  <p>The <tt>/usr/lib/courier/etc/faxrc</tt> configuration file
  provides rudimentary phone number rewriting logic (stuff like
  dialing "9," to get outside line from a PBX). The default
  <tt>faxrc</tt> configuration file specifies a typical dialing
  configuration for the North American numbering plan, with seven
  digit local phone numbers, and 1+ten digit long distance phone
  numbers. The area code in the default <tt>faxrc</tt>
  configuration file is set to "999", you will need to change it to
  your area code (there are two places in <tt>faxrc</tt> where the
  area code needs to be set).</p>

  <p>In general, messages should be addressed to the full ten-digit
  phone numbers. The local area code will be stripped
  automatically, and "1" will be dialed before all other area
  codes. If this is done in practice, local area code changes will
  only require an update to <code>faxrc</code>, without any need to
  update the address book.</p>

  <p>Comments in the <code>faxrc</code> configuration file explain
  the format of the phone number rewriting rules, in the event that
  local phone system customization is required (for example,
  dialing 9 to get an outside line). Several places in North
  America now use ten digit local phone number overlays, with 1+ten
  digit long distance dialing. TODO: Use <tt>webadmin</tt> if you
  are not sure how to set this up.</p>

  <h3>Security</h3>

  <p>The default <code>faxrc</code> configuration file allows only
  locally-generated faxes. <code>faxrc</code> must be modified in
  order to accept faxes via ESMTP.</p>

  <p>Additionally, faxes are accepted via ESMTP only if the
  FAXRELAYCLIENT variable is set. See the <a href=
  "makesmtpaccess.html">makesmtpaccess(8)</a> man page for
  additional information.</p>

  <h2><a name="recvfax" id="recvfax">OPTIONAL: Configure inbound
  faxing</a></h2>

  <p><tt>mgetty</tt> has an option that runs a script called
  "<tt>new_fax</tt>" after it receives a fax. The default location
  for this script is either
  <tt>/usr/local/lib/etc/mgetty+sendfax/new_fax</tt> or
  <tt>/etc/mgetty+sendfax/new_fax</tt>. Consult your mgetty
  documentation to determine if the <tt>new_fax</tt> option is
  enabled, and the exact script location.</p>

  <p>The <i>Courier</i> mail server provides a script -
  <tt>/usr/lib/courier/share/faxmail/new_fax</tt> - that can be
  used as mgetty's <tt>new_fax</tt> script. This script converts
  incoming faxes to PNG images, and delivers it to a local mailbox.
  Simply copy this script to mgetty's <tt>etc</tt> directory (or
  install a soft link there), to automatically drop incoming faxes
  to a local mailboxes.</p>

  <p>The <tt>/usr/lib/courier/etc/faxnotifyrc</tt> configuration
  file specifies the mailbox that receives incoming faxes, and
  several other related options.</p>

  <h2><a name="analog" id="analog">OPTIONAL: Install the
  <i>Courier</i> mail server log analyzer</a></h2>

  <p>The <i>Courier</i> mail server log analyzer (the
  <tt>courier-analog</tt> package) is a Perl script that generates
  log summaries for the <i>Courier</i> mail server. The
  <i>Courier</i> mail server log analyzer generates log summaries
  for incoming and outgoing SMTP connections, and IMAP and POP3
  activity. courier-analog can generate output in text or HTML
  format.</p>

  <p>The <i>Courier</i> log analyzer is not included in the main
  the <i>Courier</i> mail server tarball, it must be downloaded
  separately from <a href=
  "http://www.courier-mta.org/download.php#analog">http://www.courier-mta.org/download.php#analog</a>.
  After downloading and installing this package, see the
  courier-analog manual page for more information.</p>

  <h2><a name="decommission" id="decommission">Decommission your
  existing mail server</a></h2>

  <p>This steps consists of flushing the mail queue of your
  existing mail server and removing it from the system.</p>

  <p>If you're using sendmail, edit your startup script, and start
  sendmail with the option '-q30m' only. Remove the -bd option.
  This causes sendmail to stop listening on port 25, and stay as a
  daemon process only for the purpose of running the queue every 30
  minutes.</p>

  <p>If you're using Qmail, remove <code>tcpserver</code> from your
  system startup script.</p>

  <p>Wait for all existing mail to flush itself out, then
  permanently remove your existing server.</p>

  <p>Depending on your system, you may need to create a bunch of
  soft links, such as <code>/usr/bin/sendmail</code>,
  <code>/usr/sbin/sendmail</code>, <code>/lib/sendmail</code>, or
  <code>/etc/sendmail</code> that point to
  <code>/usr/lib/courier/bin/sendmail</code>. If you want to
  receive mail via UUCP you will also need to make sure that UUCP
  knows to find <code>rmail</code> in
  <code>/usr/lib/courier/bin</code> as well.</p>

  <h2><a name="sample" id="sample">Sample init script</a></h2>

  <p>You're now ready to configure your system to start the
  <i>Courier</i> mail server at system boot time (and shut it down
  at system shutdown). If your system uses system-V init scripts,
  here's a sample script that you can install in your
  <code>/etc/rc?.d</code>directories. This is a slightly modified
  version of the init script that's used in my RPM package
  (<code>courier.sysvinit</code> file in the source code
  tarball).</p>

  <p><strong>NOTE:</strong> the following script may take a long
  time to finish, the very first time it runs. That's because the
  script automatically creates test SSL certificates the first time
  the script runs (provided that SSL support is available). This
  can take as much as 5-6 minutes on a slow machine. Subsequent
  starts should take only a few seconds.</p>
  <pre>
#! /bin/sh
#
# chkconfig: 2345 35 65
# description: Courier - SMTP server
#
# NOTE: The 'restart' here does a "hard" stop, and a start.  Be gentle, use
# "courierd restart" for a kindler, gentler, restart.
#
#

prefix="/usr/lib/courier"
exec_prefix="/usr/lib/courier"
sysconfdir="/usr/lib/courier/etc"
sbindir="${exec_prefix}/sbin"
libexecdir="/usr/lib/courier/libexec"
datadir="/usr/lib/courier/share"

case "$1" in
start)
        cd /
        # Start daemons.
        touch /var/lock/subsys/courier

        echo -n "Starting the Courier mail server:"

        # First time after install create aliases.dat and makesmtpaccess.dat

        test -f ${sysconfdir}/aliases.dat || ${sbindir}/makealiases

        esmtpdcert=0

        . ${sysconfdir}/esmtpd
        case x$ESMTPDSTART in
        x[yY]*)
                esmtpdcert=1
                ;;
        esac

        test -f ${ACCESSFILE}.dat || ${sbindir}/makesmtpaccess

        . ${sysconfdir}/esmtpd-msa
        case x$ESMTPDSTART in
        x[yY]*)
                esmtpdcert=1
                ;;
        esac

        test -f ${ACCESSFILE}.dat || ${sbindir}/makesmtpaccess-msa

        ${sbindir}/courierfilter start
        echo -n " courierfilter"

        if test -x ${sbindir}/courierldapaliasd
        then
                ${sbindir}/courierldapaliasd start
                echo -n " courierldapaliasd"
        fi

        if test -f ${libexecdir}/courier/sqwebmaild
        then
                ${sbindir}/webmaild start
                echo -n " webmail"
        fi

        ${sbindir}/courier start
        echo -n " courierd"

        if test "$esmtpdcert" = 1
        then
# If we do not have a certificate, make one up.

                if test ! -f ${datadir}/esmtpd.pem
                then
                        if test -x $COURIERTLS
                        then
                                echo -n " generating-ESMTP-SSL-certificate..."
                                ${sbindir}/mkesmtpdcert &gt;/dev/null 2&gt;&amp;1
                        fi
                fi
        fi

        . ${sysconfdir}/esmtpd
        case x$ESMTPDSTART in
        x[yY]*)

                ${sbindir}/esmtpd start
                echo -n " esmtpd"
                ;;
        esac

        . ${sysconfdir}/esmtpd-msa
        case x$ESMTPDSTART in
        x[yY]*)

                ${sbindir}/esmtpd-msa start
                echo -n " esmtpd-msa"
                ;;
        esac
        
        if test -x ${sbindir}/pop3d
        then
                POP3DSTART=""
                POP3DSSLSTART=""

                if test -f ${sysconfdir}/pop3d
                then
                        . ${sysconfdir}/pop3d
                fi
                case x$POP3DSTART in
                x[yY]*)
                        ${sbindir}/pop3d start
                        echo -n " pop3d"
                        ;;
                esac
                if test -f ${sysconfdir}/pop3d-ssl
                then
                        . ${sysconfdir}/pop3d-ssl
                fi
                case x$POP3DSSLSTART in
                x[yY]*)
                        if test -x $COURIERTLS
                        then
# If we do not have a certificate, make one up.

                                if test ! -f ${datadir}/pop3d.pem
                                then
                                        echo -n " generating-POP3-SSL-certificate..."

                                        ${sbindir}/mkpop3dcert &gt;/dev/null 2&gt;&amp;1
                                fi

                                ${sbindir}/pop3d-ssl start &amp;&amp; \
                                        echo -n " pop3d-ssl"
                        fi
                        ;;
                esac
        fi

        if test -x ${sbindir}/imapd
        then
                . ${sysconfdir}/imapd
                case x$IMAPDSTART in
                x[yY]*)
                        ${sbindir}/imapd start
                        echo -n " imapd"
                        ;;
                esac
                . ${sysconfdir}/imapd-ssl
                case x$IMAPDSSLSTART in
                x[yY]*)
                        if test -x $COURIERTLS
                        then
# If we do not have a certificate, make one up.

                                if test ! -f ${datadir}/imapd.pem
                                then
                                        echo -n " generating-IMAP-SSL-certificate..."

                                        ${sbindir}/mkimapdcert &gt;/dev/null 2&gt;&amp;1
                                fi

                                ${sbindir}/imapd-ssl start &amp;&amp; \
                                        echo -n " imapd-ssl"
                        fi
                        ;;
                esac
        fi

        if test -x ${bindir}/webmlmd
        then
                . ${sysconfdir}/webmlmrc
                if test "$LISTS" != ""
                then
                        ${bindir}/webmlmd start ${sysconfdir}/webmlmrc &amp;&amp; \
                                echo -n " webmlmd"
                fi
        fi

        echo ""
        ;;
stop)
        echo -n "Stopping the Courier mail server:"

        if test -x ${bindir}/webmlmd
        then
                ${bindir}/webmlmd stop ${sysconfdir}/webmlmrc
                echo -n " webmlmd"
        fi

        if test -x ${sbindir}/imapd
        then
                ${sbindir}/imapd stop
                echo -n " imapd"
        fi

        if test -x ${sbindir}/imapd-ssl
        then
                ${sbindir}/imapd-ssl stop
                echo -n " imapd-ssl"
        fi

        ${sbindir}/esmtpd-msa stop
        echo -n " esmtpd-msa"

        ${sbindir}/esmtpd stop
        echo -n " esmtpd"

        if test -x ${sbindir}/pop3d
        then
                ${sbindir}/pop3d stop
                echo -n " pop3d"
        fi

        if test -x ${sbindir}/pop3d-ssl
        then
                ${sbindir}/pop3d-ssl stop
                echo -n " pop3d-ssl"
        fi

        ${sbindir}/courier stop
        echo -n " courierd"

        if test -f ${libexecdir}/courier/sqwebmaild
        then
                ${sbindir}/webmaild stop
                echo -n " webmail"
        fi

        if test -x ${sbindir}/courierldapaliasd
        then
                ${sbindir}/courierldapaliasd stop
                echo -n " courierldapaliasd"
        fi

        ${sbindir}/courierfilter stop
        echo " courierfilter"
        ;;
restart)
        $0 stop
        $0 start
        ;;
esac
exit 0
</pre>

  <p>The reason I test for the existence of the POP3 and IMAP
  server binaries is because I build the POP3 and IMAP servers as
  separate sub-packages, that do not have to be installed. These
  tests avoid the need for each sub-package to install its own
  startup script.</p>
</body>
</html>
